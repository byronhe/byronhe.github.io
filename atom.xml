<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tech Ideas]]></title>
  <link href="https://blog.helong.info//atom.xml" rel="self"/>
  <link href="https://blog.helong.info//"/>
  <updated>2020-03-03T07:20:39+00:00</updated>
  <id>https://blog.helong.info//</id>
  <author>
    <name><![CDATA[byronhe]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[用 Abstract Unix Socket 实现进程单实例运行]]></title>
    <link href="https://blog.helong.info//blog/2020/03/03/abstract-unix-socket-single-instance/"/>
    <updated>2020-03-03T11:06:00+00:00</updated>
    <id>https://blog.helong.info//blog/2020/03/03/abstract-unix-socket-single-instance</id>
    <content type="html"><![CDATA[<a name="L.................."></a>
<h2>一，问题背景</h2>

<p>很多时候，我们需要<strong>确保进程只有一个实例运行</strong>。</p>

<p>有几种方法：</p>

<p><a href="http://stackoverflow.com/questions/2964391/preventing-multiple-process-instances-on-linux">http://stackoverflow.com/questions/2964391/preventing-multiple-process-instances-on-linux</a></p>

<p><a href="http://stackoverflow.com/questions/5339200/how-to-create-a-single-instance-application-in-c-or-c">http://stackoverflow.com/questions/5339200/how-to-create-a-single-instance-application-in-c-or-c</a></p>

<p><a href="https://github.com/qtproject/qt-solutions/tree/master/qtsingleapplication/src">https://github.com/qtproject/qt-solutions/tree/master/qtsingleapplication/src</a></p>

<p>比较常规的做法，是对一个文件加文件锁 flock，比如对 pid 文件 flock( LOCK_EX|LOCK_NB )</p>

<p>但是这种方法有些弊端：
1. 如果文件被 mv 或者 rm，是会被绕过的。
2. 如果磁盘故障比如磁盘满，目录没有写权限，也会有问题。</p>

<a name="L......abstract.namespace.unix.socket"></a>
<h2>二，abstract namespace unix socket</h2>

<p><a href="http://linux.die.net/man/7/unix">http://linux.die.net/man/7/unix</a></p>

<p>unix socket 有3种：</p>

<ol>
<li>基于文件的</li>
<li>socketpair 创建的，匿名的</li>
<li>abstract namespace 的，Linux特有</li>
</ol>


<p>Linux 下， AF_UNIX socket 支持一种特殊的
abstract namespace unix socket 。</p>

<p>相比 普通的基于文件系统的 unix socket，abstract namespace unix socket ：</p>

<ol>
<li>没有磁盘文件</li>
<li>进程挂了以后自动删除，无残留文件</li>
<li>无需担心与 文件系统上的文件冲突，不需要关心文件系统上的绝对路径是否存在的问题</li>
</ol>


<p>在 lsof 的结果里面看起来，就是有一些 类似 @test_abstract_ns 这样的 文件项</p>

<p>代码中使用也很简单，  abstract namespace  unix socket 在 bind 之前，sockaddr_un.sun_path[0] 设成 0x0 即可。</p>

<a name="L............"></a>
<h2>三，代码</h2>

<p>于是写了一个 SysSem 工具类（ 一个 system 范围的 semaphore ），
用来：</p>

<ol>
<li>让一个程序只启动一个实例。</li>
<li>让 x 进程等待 y 进程执行完 yyy 操作后，才能执行 xxx 操作。</li>
</ol>


<p>特点：</p>

<ol>
<li>多进程/线程 并发安全。</li>
<li>当持有的进程被 kill ，OS自动释放，无残留。</li>
<li>没有磁盘文件，没有文件意外被删的各种情况。</li>
<li>不占用 tcp/udp 端口。</li>
<li>简单，不到 60行代码。</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/un.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;algorithm&gt;
</span><span class='line'>#include &lt;string&gt;
</span><span class='line'>
</span><span class='line'>//
</span><span class='line'>// a semaphore with system scope.
</span><span class='line'>//
</span><span class='line'>// 1. no race conditions between Post() / GetValue() , better than flock().
</span><span class='line'>// 2. when a running process be killed, automatically release all.
</span><span class='line'>// 3. no file on disk, no accidently delete .
</span><span class='line'>// 4. no tcp/udp socket, no confliction, no port consumption.
</span><span class='line'>//
</span><span class='line'>class SysSem {
</span><span class='line'>public:
</span><span class='line'>    SysSem() : _fd(-1) { memset(&_addr, 0, sizeof(_addr)); }
</span><span class='line'>    ~SysSem();
</span><span class='line'>
</span><span class='line'>    void Init(std::string id);
</span><span class='line'>
</span><span class='line'>    bool Post();
</span><span class='line'>    bool GetValue();
</span><span class='line'>
</span><span class='line'>    const char* GetID() const;
</span><span class='line'>
</span><span class='line'>private:
</span><span class='line'>    struct sockaddr_un _addr;
</span><span class='line'>    int _fd;
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>void SysSem::Init(std::string id) {
</span><span class='line'>    _addr.sun_family = AF_UNIX;
</span><span class='line'>    const size_t len = std::min(id.size(), sizeof(_addr.sun_path) - 2);  // 2 = start null and end null byte
</span><span class='line'>    // abstract namespace socket address , _addr.sun_path[0] is a null byte ('\0')
</span><span class='line'>    memcpy(_addr.sun_path + 1, id.c_str(), len);
</span><span class='line'>    // memcpy(_addr.sun_path + 0, id.c_str(), len);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>const char* SysSem::GetID() const { return &_addr.sun_path[1]; }
</span><span class='line'>
</span><span class='line'>SysSem::~SysSem() {
</span><span class='line'>    if (_fd &gt;= 0) {
</span><span class='line'>        ::close(_fd);
</span><span class='line'>        _fd = -1;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>bool SysSem::Post() {
</span><span class='line'>    _fd = ::socket(AF_UNIX, SOCK_STREAM, 0);
</span><span class='line'>    if (_fd &lt; 0) {
</span><span class='line'>        return false;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    if ((0 != ::bind(_fd, (struct sockaddr*)&_addr, sizeof(_addr))) || (0 != listen(_fd, 65536))) {
</span><span class='line'>        return false;
</span><span class='line'>    }
</span><span class='line'>    return true;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>bool SysSem::GetValue() {
</span><span class='line'>    const int clientFD = ::socket(AF_UNIX, SOCK_STREAM, 0);
</span><span class='line'>    if (clientFD &lt; 0) {
</span><span class='line'>        return false;
</span><span class='line'>    }
</span><span class='line'>    const bool ret = (0 == ::connect(clientFD, (struct sockaddr*)&_addr, sizeof(_addr)));
</span><span class='line'>    ::close(clientFD);
</span><span class='line'>    return ret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#include &lt;assert.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>
</span><span class='line'>int main(int argc, char** argv) {
</span><span class='line'>    if (argc != 3) {
</span><span class='line'>        fprintf(stderr, "usage: %s abstract-path post/get\n", argv[0]);
</span><span class='line'>        exit(1);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    SysSem inst;
</span><span class='line'>    inst.Init(argv[1]);
</span><span class='line'>
</span><span class='line'>    if (0 == strcasecmp(argv[2], "post")) {
</span><span class='line'>        assert(inst.Post());
</span><span class='line'>        SysSem check;
</span><span class='line'>        check.Init(argv[1]);
</span><span class='line'>        assert(check.GetValue());
</span><span class='line'>        printf("ok, i am the only one under %s. running ...\n", inst.GetID());
</span><span class='line'>        pause();
</span><span class='line'>
</span><span class='line'>    } else if (0 == strcasecmp(argv[2], "get")) {
</span><span class='line'>        assert(inst.GetValue());
</span><span class='line'>        printf("a process is running under %s. \n", inst.GetID());
</span><span class='line'>    } else {
</span><span class='line'>        printf("unknown cmd \n");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python 自动翻译成 C++ ，彻底保证离线在线特征一致]]></title>
    <link href="https://blog.helong.info//blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering/"/>
    <updated>2019-11-29T13:54:00+00:00</updated>
    <id>https://blog.helong.info//blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering</id>
    <content type="html"><![CDATA[<hr />

<a name="L.................."></a>
<h1>一，问题背景</h1>

<p>随着深度学习的广泛应用，在搜索引擎/推荐系统/机器视觉等业务系统中，越来越多的深度学习模型部署到线上服务。</p>

<p>机器学习模型在离线训练时，一般要将输入的数据做特征工程预处理，再输入模型在 TensorFlow PyTorch 等框架上做训练。</p>

<a name="L1............................"></a>
<h3>1.常见的特征工程逻辑</h3>

<p>常见的特征工程逻辑有：</p>

<ol>
<li>分箱/分桶 离散化</li>
<li>log/exp 对数/幂等 math numpy 常见数学运算</li>
<li>特征缩放/归一化/截断</li>
<li>交叉特征生成</li>
<li>分词匹配程度计算</li>
<li>字符串分隔匹配判断tong</li>
<li>缺省值填充等</li>
<li>数据平滑</li>
<li>onehot 编码，hash 编码等</li>
</ol>


<p>这些特征工程代码，当然一般使用深度学习最主要的语言 <strong>python</strong> 实现。</p>

<a name="L.................."></a>
<h1>二，业务痛点</h1>

<p>离线训练完成，模型上线部署后，同样要<strong>用 C++ 重新实现</strong> 这些 python 的特征工程逻辑代码。</p>

<p>我们发现，<strong>“用 C++ 重新实现”</strong> 这个步骤，给实际业务带来了大量的问题：</p>

<ol>
<li>繁琐，费时费力，极容易出现 python 和 C++ 代码<strong>不一致</strong></li>
<li><strong>不一致</strong>会直接影响模型在线上的效果，导致大盘业务指标不如预期，产生各种 bad case</li>
<li><strong>不一致</strong>难以发现，无法测试，无法监控，经常要靠用户投诉反馈，甚至大盘数据异常才能发现</li>
</ol>


<!--more-->


<a name="L1.............."></a>
<h3>1. 业界方案</h3>

<p>针对这些问题，我调研了这些业界方案：</p>

<p>《推荐系统中模型训练及使用流程的标准化》
<a href="https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3">https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3</a></p>

<p>《自主研发、不断总结经验，美团搜索推荐机器学习平台》
<a href="https://cloud.tencent.com/developer/article/1357309">https://cloud.tencent.com/developer/article/1357309</a></p>

<p>《京东电商推荐系统实践》
<a href="https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW">https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW</a></p>

<blockquote><p>“模型线上线下一致性问题对于模型效果非常重要，我们使用特征日志来实时记录特征，保证特征的一致性。这样离线处理的时候会把实时的用户反馈，和特征日志做一个结合生成训练样本，然后更新到模型训练平台上，平台更新之后在推送到线上，这样整个排序形成了一个闭环。”</p></blockquote>

<p>总结起来，有几种思路：</p>

<ol>
<li>在线特征存储起来给离线用</li>
<li>在线 C++ 代码编译成 so 导出给离线用</li>
<li>根据一份配置生成离线和在线代码</li>
<li>提取公共代码，加强代码复用，等软件工程手段，减少不一致</li>
</ol>


<a name="L2...................."></a>
<h3>2. 自动翻译方案</h3>

<a name="L.1........................"></a>
<h4>(1) .已有方案的缺点</h4>

<p>但这些思路都有各种缺点：</p>

<ol>
<li>所有在线请求的所有特征，这个存储量数据量很大</li>
<li>算法改代码需要等待后台开发，降低了算法同学的工作效率</li>
<li>特征处理代码的复杂度转移到配置文件中，不一定能充分表达，而且配置格式增加学习成本</li>
<li>就这边真实离线特征处理代码来看，大部分代码都无法抽取出公共代码做复用。</li>
</ol>


<a name="L.2............"></a>
<h4>(2). 翻译器</h4>

<p>回到问题出发点考虑，显而易见，这个问题归根结底就是需要一个 “ python 到 c++ 的翻译器 ” 。</p>

<p>那其实 “翻译器 Transpiler ” ，和编译器解释器类似，也是个古老的热门话题了，比如 <a href="https://webassembly.org/">WebAssembly</a>, <a href="https://coffeescript.org/">CoffeeScript </a>，<a href="https://www.babeljs.cn/docs/">Babel</a> ,
<a href="https://github.com/google/closure-compiler">Google Closure Compiler</a>，<a href="https://www.netlib.org/f2c/f2c.1">f2c</a></p>

<p>于是一番搜索，发现 python 到 C++ 的翻译器也不少，其中 <a href="https://github.com/serge-sans-paille/pythran">Pythran</a> 是新兴比较热门的开源项目。</p>

<p>于是一番尝试后，借助 pythran，我们实现了：</p>

<ol>
<li>一条命令 <strong>全自动把 Python 翻译成等价 C++</strong></li>
<li>严格等价保证改写，彻底消除不一致</li>
<li><strong>完全去掉重新实现</strong> 这块工作量，后台开发成本降到 0 ，彻底解放生产力</li>
<li>算法同学继续使用纯 python，开发效率无影响，<strong> 无学习成本 </strong></li>
<li>并能推广到其他需要 <strong>python 改写成后台 C++ 代码</strong> 的业务场景，解放生产力</li>
</ol>


<a name="L......pythran................"></a>
<h1>三，pythran 的使用流程</h1>

<a name="L.1........."></a>
<h3>(1). 安装</h3>

<p>一条命令安装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip3 install pythran
</span></code></pre></td></tr></table></div></figure>


<a name="L.2.......Python......."></a>
<h3>(2). 写 Python 代码</h3>

<p>下面这个 python demo，是 pythran 官方 demo</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">math</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">zero</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export matrix_multiply(float list list, float list list)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">matrix_multiply</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">):</span>
</span><span class='line'>    <span class="n">new_matrix</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">)):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">)):</span>
</span><span class='line'>                <span class="n">new_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">m0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">m1</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">new_matrix</span>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export arc_distance(float[], float[], float[], float[])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">arc_distance</span><span class="p">(</span><span class="n">theta_1</span><span class="p">,</span> <span class="n">phi_1</span><span class="p">,</span> <span class="n">theta_2</span><span class="p">,</span> <span class="n">phi_2</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Calculates the pairwise arc distance</span>
</span><span class='line'><span class="sd">    between all points in vector a and b.</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">theta_2</span><span class="o">-</span><span class="n">theta_1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span><span class='line'>           <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">phi_2</span><span class="o">-</span><span class="n">phi_1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">distance_matrix</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">temp</span><span class="p">))</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">distance_matrix</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export dprod(int list, int list)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">dprod</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;WoW, generator expression, zip and sum.&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">l1</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export get_age(int )</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_age</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;0_20&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;21_25&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;26_30&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">35</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;31_35&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;36_40&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">45</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;41_45&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;46_50&#39;</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;50+&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">age_x</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L.3...Python........C.."></a>
<h3>(3). Python 转成 C++</h3>

<p>一条命令完成翻译</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pythran -e demo.py -o  demo.hpp
</span></code></pre></td></tr></table></div></figure>


<a name="L.4.......C..............."></a>
<h3>(4). 写 C++ 代码调用</h3>

<p>pythran/pythonic/ 目录下是 python 标准库的 C++ 等价实现，翻译出来的C++ 代码需要 include 这些头文件</p>

<p>写个 C++ 代码调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &quot;demo.hpp&quot;</span>
</span><span class='line'><span class="cp">#include &quot;pythonic/numpy/random/rand.hpp&quot;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pythonic</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">pythonic</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span> <span class="n">m0</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">},</span>
</span><span class='line'>                                                             <span class="p">{</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">}</span> <span class="p">},</span>
</span><span class='line'>                                                       <span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">},</span>
</span><span class='line'>                                                             <span class="p">{</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">}</span> <span class="p">};</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">m0</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">=</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">matrix_multiply</span><span class="p">()(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">auto</span> <span class="n">theta_1</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>       <span class="n">phi_1</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>       <span class="n">theta_2</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>       <span class="n">phi_2</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;arc_distance &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">theta_1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">phi_1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">theta_2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">phi_2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">=</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">arc_distance</span><span class="p">()(</span><span class="n">theta_1</span><span class="p">,</span> <span class="n">phi_1</span><span class="p">,</span> <span class="n">theta_2</span><span class="p">,</span> <span class="n">phi_2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pythonic</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">l0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="n">l1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dprod &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">l0</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">l1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">=</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">dprod</span><span class="p">()(</span><span class="n">l0</span><span class="p">,</span> <span class="n">l1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;get_age 30 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">get_age</span><span class="p">()(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L.5..............."></a>
<h3>(5). 编译运行</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>g++ -g -std<span class="o">=</span>c++11 main.cpp -fopenmp -march<span class="o">=</span>native -DUSE_XSIMD -I /usr/local/lib/python3.6/site-packages/pythran/ -o pythran_demo
</span><span class='line'>
</span><span class='line'>./pythran_demo
</span></code></pre></td></tr></table></div></figure>


<a name="L......pythran..................."></a>
<h1>四，pythran 的功能与特性</h1>

<a name="L.1........."></a>
<h3>(1). 介绍</h3>

<p>按官方定义，Pythran 是一个 AOT (Ahead-Of-Time - 预先编译) 编译器。 给科学计算的 python 加注解后，pythran 可以把 python 代码变成接口相同的原生 python 模块，大幅度提升性能。</p>

<p>并且 pythran 也可以利用 OpenMP 多核和 SIMD 指令集。</p>

<p>支持 python 3 和 Python 2.7 。</p>

<p>pythran 的 manual 挺详细：
<a href="https://pythran.readthedocs.io/en/latest/MANUAL.html">https://pythran.readthedocs.io/en/latest/MANUAL.html</a></p>

<a name="L.2........."></a>
<h3>(2). 功能</h3>

<p>pythran 并不支持完整的python， 只支持 python 语言特性的一个子集:</p>

<ul>
<li>polymorphic functions 多态函数(翻译成 C++ 的泛型模板函数)</li>
<li>lambda</li>
<li>list comprehension  列表推导式</li>
<li>map, reduce 等函数</li>
<li>dictionary, set, list 等数据结构</li>
<li>exceptions 异常</li>
<li>file handling 文件处理</li>
<li>部分 numpy</li>
</ul>


<p>不支持的功能：</p>

<ul>
<li>classes 类</li>
<li>polymorphic variables 可变类型变量</li>
</ul>


<a name="L.3................................."></a>
<h3>(3). 支持的数据类型和函数</h3>

<p>pythran export  可以导出函数和全局变量。
支持导出的数据类型，BNF 定义是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='antlr'><span class='line'><span class="nl">argument_type</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">basic_type</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">(argument_type+)</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">tuple</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="err">list</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">list</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="err">set</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">set</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[]</span><span class="err">+</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">C</span><span class="err">-style</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[</span><span class="x">::</span><span class="p">]</span><span class="err">+</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">strided</span><span class="w"> </span><span class="err">ndarray</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[</span><span class="x">:,...,:</span><span class="p">]</span><span class="err">+</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">Cython</span><span class="w"> </span><span class="err">style</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[</span><span class="x">:,...,3</span><span class="p">]</span><span class="err">+</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">some</span><span class="w"> </span><span class="err">dimension</span><span class="w"> </span><span class="err">fixed</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="p">:</span><span class="nv">argument_type</span><span class="w"> </span><span class="nv">dict</span><span class="w">    </span><span class="o">#</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">dictionary</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nv">basic_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bool</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">byte</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">float</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">str</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">slice</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">uint8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uint16</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uint32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uint64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uintp</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">int8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int16</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">intp</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">float32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">float64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">float128</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">complex64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">complex128</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">complex256</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到基础类型相当全面，支持各种 整数，浮点数，字符串，复数</p>

<p>复合类型支持 tuple, list, set, dict, numpy.ndarray 等，</p>

<p>对应 C++ 代码的类型实现在  pythran/pythonic/include/types/  下面，可以看到比如 dict 实际就是封装了一下 std::unordered_map
<a href="https://pythran.readthedocs.io/en/latest/SUPPORT.html">https://pythran.readthedocs.io/en/latest/SUPPORT.html</a>
可以看到支持的 python 基础库，其中常用于机器学习的 numpy 支持算比较完善。</p>

<a name="L......pythran................"></a>
<h1>五，pythran 的基本原理</h1>

<p>和常见的编译器/解释器类似， pythran 的架构是分成 3 层：</p>

<ol>
<li>python 代码解析成抽象语法树 AST 。用 python 标准库自带的的 ast 模块实现</li>
<li>代码优化。
 在 AST 上做优化，有多种 transformation pass，比如 deadcode_elimination 死代码消除，loop_full_unrolling  循环展开 等。还有 Function/Module/Node 级别的 Analysis，用来遍历 AST 供 transformation 利用。</li>
<li>后端，实现代码生成。目前有2个后端，Cxx / Python，  Cxx 后端可以把 AST 转成 C++ 代码（ Python 后端用来调试）。</li>
</ol>


<p>目前看起来 ，pythran 还欠缺的：</p>

<ol>
<li>字符串处理能力欠缺，缺少 str.encode()/str.decode() 对 utf8 的支持</li>
<li>缺少正则表达式 regex 支持</li>
<li>缺少 json 支持</li>
</ol>


<p>看文档要自己加也不麻烦，看业务需要可以加。</p>

<a name="L.................."></a>
<h1>六，相关文章</h1>

<p>《京东电商推荐系统实践》
<a href="https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW">https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW</a></p>

<p>《自主研发、不断总结经验，美团搜索推荐机器学习平台》
<a href="https://cloud.tencent.com/developer/article/1357309">https://cloud.tencent.com/developer/article/1357309</a></p>

<p>《推荐系统中模型训练及使用流程的标准化》
<a href="https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3">https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3</a></p>

<p>numba
<a href="http://numba.pydata.org">http://numba.pydata.org</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 DAT 重实现 CppJieba 中文分词算法，降低 99% 内存消耗]]></title>
    <link href="https://blog.helong.info//blog/2019/11/25/cppjieba-darts-DAT-memory_optimize/"/>
    <updated>2019-11-25T12:34:00+00:00</updated>
    <id>https://blog.helong.info//blog/2019/11/25/cppjieba-darts-DAT-memory_optimize</id>
    <content type="html"><![CDATA[<hr />

<a name="L.................."></a>
<h2>一，问题背景</h2>

<p>中文分词应用比较广泛的开源算法，是 <a href="https://github.com/fxsjy/jieba">jieba 结巴分词</a>，结巴分词较高性能的实现是 C++ 版本的 CppJieba :
<a href="https://github.com/yanyiwu/cppjieba">https://github.com/yanyiwu/cppjieba</a></p>

<p>在实际使用 CppJieba 的过程中，我们发现 CppJieba 的内存占用比较高。</p>

<p>比如对一个 76W 词 大小 11MB 的词典 ，加载 2份 （比如为了支持平滑改动用户词典）就需要耗费 505MB内存。</p>

<p>这对一些多进程的后台服务，浪费大量内存，难以接受，因此这里希望削减内存耗费。</p>

<p>经过初步调查，确定改进方法，然后动手改造，<strong>最终把 505MB 缩减到了 4.7MB ，实现了 99% 内存降低</strong>。</p>

<p>此处也有 issue 讨论 <a href="https://github.com/yanyiwu/cppjieba/issues/3">https://github.com/yanyiwu/cppjieba/issues/3</a></p>

<p>代码稍后可能会开源出来。</p>

<!--more-->


<a name="L.................."></a>
<h2>二，实现过程</h2>

<a name="L....1................."></a>
<h3>二.1  查内存分布</h3>

<p>第一步先用 jemalloc 的 memory profiler 工具查看内存耗费在哪里，</p>

<ol>
<li>改一下 CppJieba  的  test/demo.cpp， 链接 jemalloc，编译成二进制  jieba_test</li>
<li>然后设置环境变量
 <code>export MALLOC_CONF="prof:true,prof_prefix:mem_prof/mem_profile_je.out,lg_prof_interval:20,lg_prof_sample:20"</code></li>
<li>然后  mkdir mem_prof， 并运行测试程序</li>
<li>jeprof &ndash;pdf ./jieba_test mem_prof/mem_profile_je.out.xxx.heap > mem_profile.pdf</li>
</ol>


<p>打开 mem_profile.pdf ，就可以看到内存分布了</p>

<a name="L....2............."></a>
<h3>二.2 优化方案</h3>

<p>显而易见，内存主要耗费在:
1. Trie.hpp 中的 Trie 树构建
2. KeywordExtractor.hpp 加载  idf 词典文件。</p>

<p>因此方案:</p>

<a name="L1..Double.Array.Trie.........cppjieba::Trie"></a>
<h4>1. Double Array Trie 代替  cppjieba::Trie</h4>

<p>引入 Double Array Trie  (简称  DAT ,<a href="https://github.com/s-yata/darts-clone">https://github.com/s-yata/darts-clone</a>) , 代替 Trie.hpp 中的简单内存 Trie，并把 darts 生成的  DAT 保存到文件中，在启动时，如果已经有和词典对应的 DAT ，直接 mmap() attach 上去，即可启动。</p>

<p>经过实测发现，75万词词典，dart-clone 生成的 DAT 文件，大小只有 24MB，而且可以 mmap 挂载，多进程共享。</p>

<a name="L2..KeywordExtractor"></a>
<h4>2. KeywordExtractor</h4>

<p>KeywordExtractor 是个不常用功能，直接改成支持传入空的 idfPath 和 stopWordPath, 此时不加载数据即可。</p>

<a name="L....3............."></a>
<h3>二.3 其他问题</h3>

<a name="L1...................................DAT......"></a>
<h4>1. 支持热更新，保证词典和DAT一致</h4>

<p>这里一个问题是，词典可能热更新，那怎么知道 DAT 文件和当前词典的内容对应？</p>

<p>我的做法是，对 默认词典文件+自定义词典文件，用文件内容算 MD5，写入 DAT 文件头部，这样打开 DAT 文件发现 MD5 不一致，就知道 DAT文件过时了，即可重建 DAT 。</p>

<p>实测发现算 MD5 还是很快的，启动时间都在 1秒 左右。</p>

<a name="L2.............."></a>
<h4>2. 代码清理</h4>

<p>另外，清理了一下代码，删掉了 Unicode.hpp 中的无用代码。
清理了 FullSegment.hpp HMMSegment.hpp MixSegment.hpp MPSegment.hpp QuerySegment.hpp 等中的重复代码。</p>

<a name="L3................."></a>
<h4>3. 不兼容改动</h4>

<ul>
<li>由于 Double Array Trie 无法支持动态插入词，删除 InsertUserWord() 方法</li>
<li>FullSegment.hpp 中 maxId 的计算有 bug，做了 fix。</li>
</ul>


<p>整体改造后，代码量比原来减少 100 多行。</p>

<p>上线后效果显著。</p>

<p>当内存降低到 2-3MB 的水平后，这意味着 75W 词这种规模的大词典，可以用在手机环境。</p>

<p>比如可以在 ios 或者 Android 上做 中文/英文的切词，
这意味着可能在客户端实现体验相当良好的搜索引擎。</p>

<p>ios 上也有可用于中文的分词器 <a href="https://developer.apple.com/documentation/corefoundation/cfstringtokenizer-rf8">CFStringTokenizer</a> ，但貌似不开源。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GB 规模语料上的高性能新词发现算法]]></title>
    <link href="https://blog.helong.info//blog/2019/09/18/newwords_discovery/"/>
    <updated>2019-09-18T22:19:00+00:00</updated>
    <id>https://blog.helong.info//blog/2019/09/18/newwords_discovery</id>
    <content type="html"><![CDATA[<hr />

<p>分词是中文搜索的重要环节，目前分词算法已经比较成熟，分词错误的主要是由于未登录词。</p>

<p>因此发现业务领域语料库中的新词，减少未登录词，对改善搜索引擎的用户体验有重要意义。</p>

<p>新词发现的一种常用算法，是 matrix67 大神 2012 年提出的 《互联网时代的社会语言学：基于SNS的文本数据挖掘》
<a href="https://www.matrix67.com/blog/archives/5044">https://www.matrix67.com/blog/archives/5044</a></p>

<p>其主要思路，是统计语料中出现的所有 ngram 子字符串的凝固度，自由度，信息熵。</p>

<p>算法中需要统计所有 ngram 子字符串的 左熵右熵，实现该算法时，一般以子字符串为 key，用哈希表来存。</p>

<p>但随着语料库变大时，内存消耗变大，</p>

<p>比如之前的 python 版本实现，对 200MB 的语料，就需要约 30G 内存来存哈希表，</p>

<p>导致单机内存不足无法运行，而且对这样规模的语料库，算法需要跑一两天才能出结果。</p>

<p>这里我应用一些工程实现方面的技巧，
把用哈希表统计左熵右熵的计算，拆分成多个子哈希表，分批计算，并利用多核并行，大幅度优化了算法的性能。</p>

<p>最终实现了 GB 大小语料上的新词发现，并把运行时间缩减到了 30 分钟左右 。</p>

<p><a href="https://github.com/hankcs/HanLP/wiki/%E6%96%B0%E8%AF%8D%E8%AF%86%E5%88%AB">https://github.com/hankcs/HanLP/wiki/%E6%96%B0%E8%AF%8D%E8%AF%86%E5%88%AB</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TLS协议分析 与 现代加密通信协议设计]]></title>
    <link href="https://blog.helong.info//blog/2015/09/06/tls-protocol-analysis-and-crypto-protocol-design/"/>
    <updated>2015-09-06T22:32:55+00:00</updated>
    <id>https://blog.helong.info//blog/2015/09/06/tls-protocol-analysis-and-crypto-protocol-design</id>
    <content type="html"><![CDATA[<p>最近发现密码学很有意思，刚好还和工作有点关系，就研究了一下，本文是其中一部分笔记和一些思考。</p>

<p><strong>密码学理论艰深，概念繁多，本人知识水平有限，错误难免，如果您发现错误，请务必指出，非常感谢!</strong></p>

<p><strong>本文禁止转载</strong></p>

<p>本文目标：</p>

<ol>
<li>学习鉴赏TLS协议的设计，透彻理解原理和重点细节</li>
<li>跟进一下密码学应用领域的历史和进展</li>
<li>整理现代加密通信协议设计的一般思路</li>
</ol>


<p>本文有门槛，读者需要对现代密码学有清晰而系统的理解，建议花精力补足背景知识再读。本文最后的参考文献里有一些很不错的学习资料。</p>

<!--more-->


<a name="L......TLS........................"></a>
<h1>一 . TLS协议的设计目标：</h1>

<a name="L1......................."></a>
<h2>1. 密码学的方法论</h2>

<p>密码学和软件开发不同，软件开发是工程，是手艺，造轮子是写代码的一大乐趣。软件开发中常常有各种权衡，一般难有明确的对错，一般还用建筑来比拟软件的结构，设计的优雅被高度重视。</p>

<p>密码学就不一样了。<a href="http://www.daemonology.net/blog/2013-06-17-crypto-science-not-engineering.html">密码学是科学，不是工程</a>，有严格的技术规范，严禁没有经过学术训练者随意创造。要求严谨的理论建模，严密的数学证明。很少有需要权衡的地方，正确就是正确，错误就是错误。又由于密码学过去在军事上的重要价值，各国政府一直投入大量人力物力财力，不断深入强化己方的算法，破解对手的算法，所以密码学就是一种残酷的军备竞赛。</p>

<ul>
<li><p>密码学有很多的陷阱（下文会介绍几个），设计使用密码学的协议或者软件，是极其容易出错，高风险的专业活动，单纯的码农背景是做不了的。本着<strong>不作死就不会死</strong>的伟大理念，首先推荐读者尽可能使用 TLS 这种标准化，开源，广泛使用，久经考验，高性能的协议。本文也只是整理一点粗浅的科普常识，读完这篇文章，并不能使读者具有设计足够安全的密码学协议的能力。</p></li>
<li><p>密码学经过几十年的军备竞赛式发展，已经发展出大量巧妙而狡猾的攻击方法，我们使用的算法，都是在所有已知的攻击方法下都无法攻破的，由于我们大多数码农并没有精力去了解最前沿的攻击方法，所以我们其实并没有能力去评价一个加密算法，更没有能力自己发明算法。所以最好跟着业界的主流技术走，肯定不会有大错。</p></li>
<li><p>现代密码学近20年进展迅猛，现在搞现代密码学研究的主要都是数学家，在这个领域里面以一个码农的知识背景，已经很难理解最前沿的东西，连正确使用加密算法都是要谨慎谨慎再谨慎的。一个码农，能了解密码学基本概念，跟进密码学的最新应用趋势，并正确配置部署TLS这种协议，就很不错了。</p></li>
<li><p>密码学算法很难被正确地使用，各种细节非常容易出错。
例如：</p>

<ul>
<li>1.大多数码农都听说过aes，可是大多数都不了解细节，比如：aes应该用哪种模式？应该用哪种padding？IV/nonce应该取多少bit？IV/nonce应该怎么生成？ key size应该选多大？key应该怎么生成？应不应该加MAC？MAC算法的选择？MAC和加密应该怎么组合？</li>
<li>2.大多数知道RSA的码农分不清 RSASSA-PKCS1-v1_5 ，RSAES-OAEP 和 RSASSA-PSS</li>
<li>3.更多错误参见 <a href="http://security.stackexchange.com/questions/2202/lessons-learned-and-misconceptions-regarding-encryption-and-cryptology">这个stackoverflow问答，强烈推荐仔细阅读</a></li>
</ul>
</li>
<li><p>密码学算法很难被正确地实现(代码实现过程中会引入很多漏洞，比如HeartBleed，比如各种随机数生成器的bug，时间侧通道攻击漏洞)</p></li>
<li><p>不能一知半解，绝对不能在一知半解的情况下就动手设计密码学协议。犹如“盲人骑瞎马，夜班临深池”。</p></li>
<li><p>不能闭门造车，密码学相关协议和代码一定要开源，采用大集市式的开发，接受peer review，被越多的人review，出漏洞的可能越小（所以应该尽可能使用开源组件）</p></li>
</ul>


<a name="L2..TLS..............."></a>
<h2>2. TLS的设计目标</h2>

<p>TLS的设计目标是构建一个安全传输层（Transport Layer Security ），在基于连接的传输层（如tcp）之上提供：</p>

<ol>
<li>密码学安全
 (1). 保密， message privacy (保密通过加密encryption实现，所有信息都加密传输，第三方无法窃听 )
 (2). 完整性， message integrity（  通过MAC校验机制，一旦被篡改，通信双方会立刻发现 ）
 (3). 认证， mutual authentication （双方认证,双方都可以配备证书，防止身份被冒充 ）</li>
<li>互操作，通用性 （ 根据公开的rfc，任何符合rfc的软件实现都可以互操作，不受限于任何专利技术）</li>
<li>可扩展性 ( 通过扩展机制 tls_ext可以添加功能，有大量的新功能，都是通过扩展添加的)</li>
<li>高效率 （通过session cache，恰当部署cache之后，tls的效率很高）</li>
</ol>


<p>请认准这几个目标，在后文中，会逐一实现。</p>

<a name="L3..TLS........."></a>
<h2>3. TLS的历史</h2>

<ul>
<li>1995: SSL 2.0, 由Netscape提出，这个版本由于设计缺陷，并不安全，很快被发现有严重漏洞，已经废弃。</li>
<li>1996: SSL 3.0. 写成RFC，开始流行。目前(2015年)已经不安全，必须禁用。</li>
<li>1999: TLS 1.0. 互联网标准化组织ISOC接替NetScape公司，发布了SSL的升级版TLS 1.0版.</li>
<li>2006: TLS 1.1. 作为 RFC 4346 发布。主要fix了CBC模式相关的如BEAST攻击等漏洞</li>
<li>2008: TLS 1.2. 作为RFC 5246 发布 。增进安全性。目前(2015年)应该主要部署的版本，请确保你使用的是这个版本</li>
<li>2015之后: TLS 1.3，还在制订中，支持0-rtt，大幅增进安全性，砍掉了aead之外的加密方式</li>
</ul>


<p>由于SSL的2个版本都已经退出历史舞台了，所以本文后面只用TLS这个名字。
读者应该明白，一般所说的SSL就是TLS。</p>

<a name="L.....TLS..............."></a>
<h1>二. TLS协议的原理</h1>

<a name="L1............................."></a>
<h2>1. 自顶向下，分层抽象</h2>

<p>构建软件的常用方式是分层，把问题域抽象为多层，每一层的概念定义为一组原语，上一层利用下一层的组件构造实现，并被上一层使用，层层叠叠即成软件。
*  例如在编程语言领域中，汇编语言为一层，在汇编上面是C/C++等静态编译语言，C/C++之上是python/php/lua等动态类型脚本语言层，之上常常还会构造领域特定的DSL
*  在网络架构中，以太网是一层，其上是ip协议的网络层，ip之上是tcp等传输层，tcp之上是http等应用层</p>

<p>密码学通信协议也是分层构造得到。大致可以这么分层：</p>

<ol>
<li><p>最底层是基础算法原语的实现，例如: aes ,  rsa， md5, sha256，ecdsa,  ecdh 等（举的例子都是目前的主流选择，下同）</p></li>
<li><p>其上是选定参数后，符合密码学里标准分类的算法，包括块加密算法，签名算法，非对称加密算法，MAC算法等，例如： aes-128-cbc-pkcs7，rsaes-oaep ，rsassa-pkcs1-v1_5, hmac-sha256，ecdsa-p256，curve25519 等</p></li>
<li><p>再其上，是把多种标准算法组合而成的半成品组件，例如：对称传输组件例如 aes-128-cbc + hmac-sha256，aes-128-gcm，认证密钥协商算法: rsassa-OAEP + ecdh-secp256r1，数字信封：rsaes-oaep + aes-cbc-128 + hmac-sha256 ，文件密码加密存储组件：pbkdf2+aes-128-cbc-hmac-sha256，密钥扩展算法 PRF-sha256 等</p></li>
<li><p>再其上，是用各种组件拼装而成的各种成品密码学协议/软件，例如：tls协议，ssh协议，srp协议，gnupg文件格式，iMessage协议，bitcoin协议等等</p></li>
</ol>


<p>第1层，一般程序员都有所了解，例如rsa，简直路人皆知; md5 被广泛使用(当然，也有广泛的误用)
第2层，各种莫名其妙的参数，一般很让程序员摸不着头脑，需要深入学习才能理清。
第3层，很多程序员自己造的轮子，往往说白了就是想重复实现第3层的某个组件而已。
第4层，正确地理解，使用，部署这类成熟的开放协议，并不是那么容易。很多的误用来源于不理解，需要密码学背景知识，才能搞懂是什么，为什么，怎么用。</p>

<p>最难的是<strong>理论联系实际</strong>。面对一个一团乱麻的实际业务问题，最难的是从中抽象分析出其本质密码学问题，然后用密码学概念体系给业务建模。在分析建模过程中，要求必须有严密的，体系化的思考方式。不体系化的思考方式会导致疏漏，或者误用。</p>

<p>第2层中，密码学算法，常见的有下面几类：</p>

<ol>
<li>块加密算法 block cipher: AES, Serpent, 等</li>
<li>流加密算法 stream cipher: RC4，ChaCha20 等</li>
<li>Hash函数 hash funtion:MD5，sha1，sha256，sha512 , ripemd 160，poly1305 等</li>
<li>消息验证码函数 message authentication code: HMAC-sha256，AEAD 等</li>
<li>密钥交换 key exchange: DH，ECDH，RSA，PFS方式的（DHE，ECDHE）等</li>
<li>公钥加密 public-key encryption: RSA，rabin-williams 等</li>
<li>数字签名算法 signature algorithm:RSA，DSA，ECDSA (secp256r1 , ed25519) 等</li>
<li>密码衍生函数 key derivation function: TLS-12-PRF(SHA-256) , bcrypto，scrypto，pbkdf2 等</li>
<li>随机数生成器 random number generators:  /dev/urandom 等</li>
</ol>


<p>每个类别里面的都有几个算法不断竞争，优胜劣汰，近几十年不断有老的算法被攻破被淘汰，新的算法被提出被推广。这一块话题广，水很深，内容多，陷阱也多，后续byron会翻译整理一系列文章，分享一下每一类里面个人收集的资料。
在此推荐一下 <a href="https://www.crypto101.io/"> 开源电子书crypto101</a>，讲的很透彻，而且很易读)</p>

<p><strong>设计一个加密通信协议的过程，就是自顶向下，逐步细化，挑选各类组件，拼装成完整协议的过程</strong></p>

<a name="L3..TLS.CipherSuite"></a>
<h2>3. TLS CipherSuite</h2>

<p>从上述分层的角度看，TLS大致是由3个组件拼成的：
-  <strong>1.对称加密传输组件</strong>，例如aes-128-gcm(这几个例子都是当前2015年最主流的选择);
-  <strong>2.认证密钥协商组件</strong>，例如rsa-ecdhe;
-  <strong>3.密钥扩展组件</strong>，例如TLS-PRF-sha256</p>

<p>这些组件可以再拆分为5类算法，在TLS中，这5类算法组合在一起，称为一个CipherSuite：
authentication (认证算法)
encryption (加密算法 )
message authentication code (消息认证码算法  简称MAC)
key exchange (密钥交换算法)
key derivation function （密钥衍生算法)</p>

<p> TLS协议设计之初就考虑到了这每一类算法的演变，所以没有定死算法，而是设计了一个算法协商过程，来允许加入新的算法( 简直是软件可扩展性设计的典范！)，协商出的一个算法组合即一个CipherSuite
TLS CipherSuite  在 iana 集中注册，每一个CipherSuite分配有 一个2字节的数字用来标识 ，可以在 <a href="https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-4">iana的注册页面</a>  查看</p>

<p>iana注册页面截图：
<img src="https://blog.helong.info//images/blog/tls/CipherSuiteList.png" alt="" /></p>

<p>在浏览器中，就可以查看当前使用了什么 CipherSuite，在地址栏上，点击一个小锁的标志，就可以看到了。
<img src="https://blog.helong.info//images/blog/tls/addrbar_lock.png" alt="" /></p>

<p>服务器端支持的CipherSuite列表，如果是用的openssl，可以用  openssl  ciphers -V  | column -t 命令查看，输出如：
<img src="https://blog.helong.info//images/blog/tls/openssl_ciphers_output.png" alt="" /></p>

<p>例如其中这一行(这个是目前的主流配置):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x2F</span>  <span class="o">-</span>  <span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA256</span>    <span class="n">TLSv1</span><span class="mf">.2</span>  <span class="n">Kx</span><span class="o">=</span><span class="n">ECDH</span>        <span class="n">Au</span><span class="o">=</span><span class="n">RSA</span>    <span class="n">Enc</span><span class="o">=</span><span class="n">AESGCM</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>    <span class="n">Mac</span><span class="o">=</span><span class="n">AEAD</span>
</span></code></pre></td></tr></table></div></figure>


<p>表示：
名字为<code>ECDHE-RSA-AES128-GCM-SHA256</code>  的CipherSuite ，用于 TLSv1.2版本，使用 ECDHE 做密钥交换，使用RSA做认证，使用AES-128-gcm做加密算法，MAC由于gcm作为一种aead模式并不需要，所以显示为aead，使用SHA256做PRF算法。</p>

<p>可以参考 <a href="http://linux.die.net/man/1/ciphers">man 1 ciphers</a></p>

<p>要注意的是，由于历史兼容原因，tls标准，和openssl的tls实现中，有一些极度不安全的CipherSuite，一定要禁用，比如：</p>

<dl>
<dt>EXP , EXPORT</dt>
<dd> 一定要禁用。EXPORT表示上世纪美国出口限制弱化过的算法，早已经被攻破，TLS的FREAK 攻击就是利用了这类坑爹的算法。</dd>
<dt>eNULL, NULL</dt>
<dd> 一定要禁用。NULL表示不加密！默认是禁用的。
aNULL
： 一定要禁用。表示不做认证(authentication) ，也就是说可以随意做中间人攻击。</dd>
<dt>ADH</dt>
<dd> 一定要禁用。表示不做认证的 DH 密钥协商。</dd>
</dl>

<p>上面是举个例子，读者不要自己去研究怎么配置，这太容易搞错。
请按照mozilla官方给出的这个<a href="https://wiki.mozilla.org/Security/Server_Side_TLS#Recommended_configurations">权威文档</a>，复制粘贴就好了。</p>

<p>CipherSuite的更多解释，配置方法等，可以参考byron之前写的一篇文章 <a href="https://blog.helong.info//blog/2015/01/23/ssl_tls_ciphersuite_intro/">SSL/TLS CipherSuite 介绍</a></p>

<a name="L4.............."></a>
<h2>4. 协议分层</h2>

<p>TLS是用来做加密数据传输的，因此它的主体当然是一个对称加密传输组件。为了给这个组件生成双方共享的密钥，因此就需要先搞一个认证密钥协商组件，故，TLS协议自然分为：</p>

<ol>
<li>做对称加密传输的record协议 ，the record protocol</li>
<li>做认证密钥协商的handshake协议，the handshake protocol</li>
</ol>


<p>还有3个很简单的辅助协议：</p>

<ol>
<li>changecipher spec 协议，the changecipher spec protocol, 用来通知对端从handshake切换到record协议(有点冗余，在TLS1.3里面已经被删掉了)</li>
<li>alert协议，the alert protocol, 用来通知各种返回码，</li>
<li>application data协议， The application data protocol，就是把http，smtp等的数据流传入record层做处理并传输。</li>
</ol>


<p>这种 <strong>认证密钥协商 + 对称加密传输</strong> 的结构，是<strong>绝大多数加密通信协议的通用结构</strong>，在后文的更多协议案例中，我们可以看到该结构一再出现。</p>

<p>这5个协议中：
record协议在tcp流上提供分包，
图片来自网络：
<img src="https://blog.helong.info//images/blog/tls/tls_5_proto.png" alt="" /></p>

<p>其它的: handshake protocol, alert protocol, changeCipherSpec protocol, application data protocol都封装在record protocol的包里，然后在tcp上传输（此处以tcp举例，也有可能是udp，或者随便什么ipc机制等）</p>

<p>下文分别介绍，内容主要是翻译自 RFC5246，RFC5077，RFC4492</p>

<a name="L5..record......."></a>
<h2>5. record 协议</h2>

<p>record协议做应用数据的对称加密传输，占据一个TLS连接的绝大多数流量，因此，先看看record协议
图片来自网络:
<img src="https://blog.helong.info//images/blog/tls/tls_record_layer.png" alt="" /></p>

<p> Record 协议 &ndash; 从应用层接受数据，并且做:</p>

<ol>
<li>分片，逆向是重组</li>
<li>生成序列号，为每个数据块生成唯一编号，防止被重放或被重排序</li>
<li>压缩，可选步骤，使用握手协议协商出的压缩算法做压缩</li>
<li>加密，使用握手协议协商出来的key做加密/解密</li>
<li>算HMAC，对数据计算HMAC，并且验证收到的数据包的HMAC正确性</li>
<li>发给tcp/ip，把数据发送给 TCP/IP 做传输(或其它ipc机制)。</li>
</ol>


<a name="L1..SecurityParameters"></a>
<h3>1. SecurityParameters</h3>

<p>record层的上述处理，完全依据下面这个SecurityParameters里面的参数进行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ConnectionEnd</span>          <span class="n">entity</span><span class="p">;</span>
</span><span class='line'>      <span class="n">PRFAlgorithm</span>           <span class="n">prf_algorithm</span><span class="p">;</span>
</span><span class='line'>      <span class="n">BulkCipherAlgorithm</span>    <span class="n">bulk_cipher_algorithm</span><span class="p">;</span>
</span><span class='line'>      <span class="n">CipherType</span>             <span class="n">cipher_type</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span>                  <span class="n">enc_key_length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span>                  <span class="n">block_length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span>                  <span class="n">fixed_iv_length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span>                  <span class="n">record_iv_length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">MACAlgorithm</span>           <span class="n">mac_algorithm</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span>                  <span class="n">mac_length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span>                  <span class="n">mac_key_length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">CompressionMethod</span>      <span class="n">compression_algorithm</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span>                 <span class="n">master_secret</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
</span><span class='line'>      <span class="n">opaque</span>                 <span class="n">client_random</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>      <span class="n">opaque</span>                 <span class="n">server_random</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">SecurityParameters</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>record 层使用上面的SecurityParameters生成下面的6个参数（不是所有的CipherSuite都需要全部6个，如果不需要，那就是空）:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">client</span> <span class="n">write</span> <span class="n">MAC</span> <span class="n">key</span>
</span><span class='line'>  <span class="n">server</span> <span class="n">write</span> <span class="n">MAC</span> <span class="n">key</span>
</span><span class='line'>  <span class="n">client</span> <span class="n">write</span> <span class="n">encryption</span> <span class="n">key</span>
</span><span class='line'>  <span class="n">server</span> <span class="n">write</span> <span class="n">encryption</span> <span class="n">key</span>
</span><span class='line'>  <span class="n">client</span> <span class="n">write</span> <span class="n">IV</span>
</span><span class='line'>  <span class="n">server</span> <span class="n">write</span> <span class="n">IV</span>
</span></code></pre></td></tr></table></div></figure>


<p>当handshake完成，上述6个参数生成完成之后，就可以建立连接状态，连接状态除了上面的SecurityParameters，还有下面几个参数，并且随着数据的发送/接收，更新下面的参数：</p>

<dl>
<dt>*   compression state</dt>
<dd><pre><code> 当前压缩算法的状态。
</code></pre></dd>
<dt>*   cipher state</dt>
<dd><pre><code>加密算法的当前状态，对块加密算法比如aes，包含密码预处理生成的轮密钥(感谢温博士指出) "round key"，还有IV等；对于流加密，包含能让流加密持续进行加解密的状态信息
</code></pre></dd>
<dt>*  sequence number</dt>
<dd>   每个连接状态都包含一个sequence number，并且读和写状态有不同的sequence number。当连接开始传输数据时，sequence number必须置为0.  sequence number 是uint64类型的，并且不得超过 $ 2^{64}-1$ 。s.  Sequence number不得回绕。如果一个TLS实现无法避开回绕一个sequence number，必须进行重协商。sequence number在每个record被发送时都增加1。并且传输的第1个Record必须使用0作为sequence number。</dd>
</dl>

<p>此处有几个问题值得思考：</p>

<p>(1).  为什么MAC key , encryption key, IV 要分别不同？</p>

<p>在密码学中，对称加密算法一般需要encryption key，IV两个参数，MAC算法需要MAC key参数，因此这3个key用于不同的用途。
当然，不是所有的算法都一定会用到这3个参数，例如新的aead型算法，就不需要MAC key。</p>

<p>(2). 为什么client和server要使用不同的key
如果TLS的双方使用相同的key，那么当使用stream cipher加密应用数据的时候，stream cipher的字节流在两个方向是一样的，如果攻击者知道TLS数据流一个方向的部分明文（比如协议里面的固定值），那么对2个方向的密文做一下xor，就能得到另一个方向对应部分的明文了。</p>

<p>还有，当使用 aead 比如 aes-gcm 做加密的时候，aead标准严格要求，<strong>绝对不能用相同的 key+nonce 加密不同的明文</strong>，故如果TLS双方使用相同的key，又从相同的数字开始给nonce递增，那就不符合规定，会直接导致 aes-gcm 被攻破。</p>

<p>参考:
<a href="http://crypto.stackexchange.com/questions/2878/separate-read-and-write-keys-in-tls-key-material">http://crypto.stackexchange.com/questions/2878/separate-read-and-write-keys-in-tls-key-material</a></p>

<a name="L2..record........."></a>
<h3>2. record层分段</h3>

<p>如上图所示，对要发送的数据流，首先分段，分段成如下格式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">uint8</span> <span class="n">major</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint8</span> <span class="n">minor</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ProtocolVersion</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">change_cipher_spec</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">alert</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span> <span class="n">handshake</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
</span><span class='line'>      <span class="n">application_data</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ContentType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ContentType</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>      <span class="n">ProtocolVersion</span> <span class="n">version</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint16</span> <span class="n">length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">fragment</span><span class="p">[</span><span class="n">TLSPlaintext</span><span class="p">.</span><span class="n">length</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">TLSPlaintext</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<dl>
<dt>*  version字段</dt>
<dd> ，定义当前协商出来的TLS协议版本，例如 TLS  1.2   version 是 { 3, 3 }</dd>
<dt>*  length字段</dt>
<dd> 即长度，tls协议规定length必须小于 $2^{14}$，一般我们不希望length过长，因为解密方需要收完整个record，才能解密，length过长会导致解密方需要等待更多的rtt，增大latency，破坏用户体验，参考 <a href="http://book.douban.com/subject/25856314/">Web性能权威指南</a> TLS那一章。</dd>
<dt>*  type字段</dt>
<dd><p> ，用来标识当前record是4种协议中的哪一种，</p>

<p>record压缩</p></dd>
<dd> TLS协议定义了可选的压缩，但是，由于压缩导致了 2012 年被爆出<a href="https://en.wikipedia.org/wiki/CRIME">CRIME攻击，BREACH攻击</a>，所以在实际部署中，<strong>一定要禁用压缩</strong>。
<a href="http://www.unclekevin.org/?p=640">http://www.unclekevin.org/?p=640</a>
<a href="http://www.freebuf.com/articles/web/5636.html">http://www.freebuf.com/articles/web/5636.html</a></dd>
</dl>

<a name="L3..record....................."></a>
<h3>3. record层的密码学保护</h3>

<p>record层的密码学保护:</p>

<p>经过处理后的包格式定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ContentType</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>      <span class="n">ProtocolVersion</span> <span class="n">version</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint16</span> <span class="n">length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">select</span> <span class="p">(</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">cipher_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">stream</span><span class="p">:</span> <span class="n">GenericStreamCipher</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">block</span><span class="p">:</span>  <span class="n">GenericBlockCipher</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">aead</span><span class="p">:</span>   <span class="n">GenericAEADCipher</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">fragment</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">TLSCiphertext</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>TLS协议设计目标中的 1.保密(encryption) 2.完整性(authentication) ，和防重放就在这里实现。
实现方式有3类：</p>

<ol>
<li>Block Cipher (CBC mode of operation) + HMAC：例如 aes-128-cbc+hmac-sha256</li>
<li>Stream Cipher (RC4) + HMAC</li>
<li>Authenticated-Encryption using block cipher (GCM/CCM 模式)：例如 aes-128-gcm</li>
</ol>


<p>1.Block Cipher+HMAC 和 2.Stream Cipher + HMAC 的各类算法目前（2015年）都已经爆出各种漏洞(后文解释)，目前最可靠的是 3.Authenticated-Encryption 类的算法，主要就是aes-gcm，下一代的TLS v1.3干脆只保留了3.Authenticated-Encryption，把1和2直接禁止了(所以。。。你真的还要继续用aes-cbc吗？)。</p>

<p>GCM模式是AEAD的，所以不需要MAC算法。
GCM模式是AEAD的一种，AEAD 的 作用类似于  Encrypt-then-HMAC ，例如 Sha256 + Salt + AES + IV</p>

<p>此处需要介绍一个<strong>陷阱</strong>。
在密码学历史上，出现过3种加密和认证的组合方式：</p>

<ol>
<li>Encrypt-and-MAC</li>
<li>MAC-then-Encrypt</li>
<li>Encrypt-then-MAC</li>
</ol>


<p>在TLS协议初定的那个年代，人们还没意识到这3种组合方式的安全性有什么差别，所以TLS协议规定使用 2.MAC-then-Encrypt，即先计算MAC，然后把 &ldquo;明文+MAC&rdquo; 再加密(块加密或者流加密)的方式，做流加密+MAC，和块加密+MAC。
但是，悲剧的是，近些年，人们发现 MAC-then-Encrypt 这种结构导致了 很容易构造padding oracle 相关的攻击，例如这在TLS中，间接形成被攻击者利用，这间接导致了 BEAST 攻击 , Lucky 13攻击 (CVE-2013-0169), 和 POODLE 攻击 (CVE-2014-3566).</p>

<p>目前因此，学术界已经一致同意： <strong>Encrypt-then-MAC 才是最安全的!</strong>
tls使用的是 MAC-then-Encrypt 的模式，导致了一些问题。
具体比较，参见：
<a href="http://cseweb.ucsd.edu/~mihir/papers/oem.pdf">http://cseweb.ucsd.edu/~mihir/papers/oem.pdf</a>
<a href="https://www.iacr.org/archive/crypto2001/21390309.pdf">https://www.iacr.org/archive/crypto2001/21390309.pdf</a>
<a href="http://crypto.stackexchange.com/questions/202/should-we-mac-then-encrypt-or-encrypt-then-mac">http://crypto.stackexchange.com/questions/202/should-we-mac-then-encrypt-or-encrypt-then-mac</a>
<a href="https://news.ycombinator.com/item?id=4779015">https://news.ycombinator.com/item?id=4779015</a>
<a href="http://tozny.com/blog/encrypting-strings-in-android-lets-make-better-mistakes/">http://tozny.com/blog/encrypting-strings-in-android-lets-make-better-mistakes/</a></p>

<p>鉴于这个陷阱如此险恶，学术界有人就提出了，干脆把Encrypt和MAC直接集成为一个算法，在算法内部解决好安全问题，不再让码农选择，避免众码农再被这个陷阱坑害，这就是AEAD（Authenticated-Encryption With Additional data）类的算法，GCM模式就是AEAD最重要的一种。</p>

<a name="L4..record.....................--MAC"></a>
<h3>4. record层的密码学保护&ndash;MAC</h3>

<p>TLS record 层 MAC的计算方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">MAC</span><span class="p">(</span><span class="n">MAC_write_key</span><span class="p">,</span> <span class="n">seq_num</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">type</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">version</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">fragment</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中的seq_num是当前record的 sequence number，每条record都会++，
可以看到把 seq_num，以及record header里面的几个字段也算进来了，这样<strong>解决了防重放问题</strong>，并且保证record的任何字段都不能被篡改。</p>

<p>算完MAC，格式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">stream</span><span class="o">-</span><span class="n">ciphered</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">content</span><span class="p">[</span><span class="n">TLSCompressed</span><span class="p">.</span><span class="n">length</span><span class="p">];</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">MAC</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">mac_length</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">GenericStreamCipher</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后根据SecurityParameters.cipher_type，选择对应的对称加密算法进行加密，分类解说如下：</p>

<a name="L5..record.....................--stream.cipher"></a>
<h3>5. record层的密码学保护&ndash;stream cipher</h3>

<p>stream cipher:
算stream cipher，stream cipher的状态在连续的record之间会复用。
stream cipher的主力是RC4，但是目前RC4已经爆出多个漏洞，所以实际中基本不使用流加密没法，详情请见：</p>

<p><a href="https://tools.ietf.org/html/rfc7457#section-2.5">https://tools.ietf.org/html/rfc7457#section-2.5</a></p>

<p><a href="http://www.freebuf.com/news/72622.html">[FreeBuf] RC4加密已不再安全，破解效率极高</a></p>

<p><a href="http://www.imperva.com/docs/HII_Attacking_SSL_when_using_RC4.pdf">http://www.imperva.com/docs/HII_Attacking_SSL_when_using_RC4.pdf</a></p>

<a name="L6..record.....................--.CBC.block.cipher"></a>
<h3>6. record层的密码学保护&ndash; CBC block cipher</h3>

<p>CBC模式块加密
TLS目前靠得住的的块加密cipher也不多，基本就是AES（最靠谱，最主流），Camellia，SEED，（3DES，IDEA之类已经显得老旧，DES请禁用），加密完的格式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">IV</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">record_iv_length</span><span class="p">];</span>
</span><span class='line'>      <span class="n">block</span><span class="o">-</span><span class="n">ciphered</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">opaque</span> <span class="n">content</span><span class="p">[</span><span class="n">TLSCompressed</span><span class="p">.</span><span class="n">length</span><span class="p">];</span>
</span><span class='line'>          <span class="n">opaque</span> <span class="n">MAC</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">mac_length</span><span class="p">];</span>
</span><span class='line'>          <span class="n">uint8</span> <span class="n">padding</span><span class="p">[</span><span class="n">GenericBlockCipher</span><span class="p">.</span><span class="n">padding_length</span><span class="p">];</span>
</span><span class='line'>          <span class="n">uint8</span> <span class="n">padding_length</span><span class="p">;</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">GenericBlockCipher</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个值得说道说道，因为我们码农平常在业界还能看到很多用AES-CBC的地方，其中的几个参数：</p>

<dl>
<dt>   IV </dt>
<dd><p>： 要求<strong>必须用密码学安全的伪随机数生成器(CSPRNG)</strong>生成，并且必须是不可预测的，在Linux下，就是用用/dev/urandom，或者用 openssl 库的 RAND_bytes()。</p>

<p> 注意：TLS 在 1.1版本之前，没有这个IV字段，前一个record的最后一个block被当成下一个record的IV来用，然后粗大事了，这导致了 <a href="http://www.openssl.org/~bodo/tls-cbc.txt">BEAST攻击</a>。
 所以，TLS1.2改成了这样。
 (<strong>还在使用CBC的各位，建议关注一下自己的IV字段是怎么生成出来的。如果要用，做好和TLS1.2的做法保持一致</strong>)。</p>

<p> 其中  SecurityParameters.record_iv_length 一定等于    SecurityParameters.block_size.
 例如 AES-256-CBC的 IV 一定是16字节长的，因为AES 128/192/256 的block size都是16字节。</p>

<p> padding</p></dd>
<dd><p>  使用CBC常用的PKCS 7 padding（在block size=16字节这种情况下，和pkcs 5的算法是一回事，java代码里面就可以这么用这个case里，和pkcs 5的结果是一样的）</p>

<p> padding_length</p></dd>
<dd>  就是PKCS 7 padding的最后一个字节</dd>
</dl>

<p> 注意2个险恶的陷阱：
 1. 实现的代码必须在收到全部明文之后才能传输密文，否则可能会有BEAST攻击
 2. 实现上，根据MAC计算的时间，可能进行时间侧通道攻击，因此必须确保&ndash;<strong>运行时间和padding是否正确无关</strong>。</p>

<a name="L7..record.....................--.AEAD.cipher"></a>
<h3>7. record层的密码学保护&ndash; AEAD cipher</h3>

<p>AEAD
到了我们重点关注的AEAD，AEAD是新兴的主流加密模式，是目前最重要的模式，其中主流的AEAD模式是 aes-gcm-128/aes-gcm-256/chacha20-poly1305</p>

<p>AEAD加密完的格式是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">opaque</span> <span class="n">nonce_explicit</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">record_iv_length</span><span class="p">];</span>
</span><span class='line'>     <span class="n">aead</span><span class="o">-</span><span class="n">ciphered</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">opaque</span> <span class="n">content</span><span class="p">[</span><span class="n">TLSCompressed</span><span class="p">.</span><span class="n">length</span><span class="p">];</span>
</span><span class='line'>     <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">GenericAEADCipher</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>   AEAD ciphers的输入是: key，nonce, 明文,和 &ldquo;additional data&rdquo;.
   key是   client_write_key 或者 the server_write_key.  不需要使用 MAC key.</p>

<p>   每一个AEAD算法都要指定不同的nonce构造算法，并指定 GenericAEADCipher.nonce_explicit 的长度.
   在TLS 1.2中，规定很多情况下，可以按照rfc5116 section 3.2.1的技术来做。其中record_iv_length是nonce的显式部分的长度，nonce的隐式部分从key_block作为  client_write_iv和 and server_write_iv得出，并且把显式部分放在 GenericAEAEDCipher.nonce_explicit 里.</p>

<p>在TLS 1.3 draft中，做了更改:</p>

<ol>
<li>规定 AEAD算法的 nonce的长度规定为 max(8 bytes, N_MIN)，即如果N_MIN比8大，就用N_MIN; 如果比8小，就用8。</li>
<li>并且规定 N_MAX小于8字节的AEAD不得用于TLS。</li>
<li><p>规定TLS AEAD中每条record的nonce通过下面的方法构造出来：
64bit的sequence number的右侧填充0，直到长度达到iv_length。然后把填充过的sequence number和静态的 client_write_iv或 server_write_iv （根据发送端选择）做异或(XOR)。异或完成后，得到的 iv_length 的nonce就可以做每条record的nonce用了。</p>

<p> AEAD输入的明文就是  TLSCompressed.fragment (记得上面的介绍吗？AEAD是MAC和encrypt的集成，所以输入数据不需要在算MAC了).</p>

<p> AEAD输入的additional_data 是:</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">additional_data</span> <span class="o">=</span> <span class="n">seq_num</span> <span class="o">+</span> <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">type</span> <span class="o">+</span>
</span><span class='line'>                    <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">version</span> <span class="o">+</span> <span class="n">TLSCompressed</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;+&rdquo; 表示字符串拼接。
    可以看到，此处类似上面的MAC计算，算入了seq_num来防重放，type,version,length等字段防止这些元数据被篡改。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">AEADEncrypted</span> <span class="o">=</span> <span class="n">AEAD</span><span class="o">-</span><span class="n">Encrypt</span><span class="p">(</span><span class="n">write_key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">additional_data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  解密+验证完整性：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">TLSCompressed</span><span class="p">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="n">AEAD</span><span class="o">-</span><span class="n">Decrypt</span><span class="p">(</span><span class="n">write_key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">AEADEncrypted</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">additional_data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>   如果解密/验证完整性失败,就回复一条 fatal bad_record_mac alert 消息.</p>

<p>aes-gcm的iv长度，nonce长度，nonce构成等，后续再深入探讨。</p>

<a name="L8..record.....................--.Key......"></a>
<h3>8. record层的密码学保护&ndash; Key扩展</h3>

<p>Key 扩展</p>

<p>TLS握手生成的master_secret只有48字节，2组encryption key, MAC key, IV加起来，长度一般都超过48，(例如 AES_256_CBC_SHA256 需要 128字节),所以，TLS里面用1个函数，来把48字节延长到需要的长度，称为PRF：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">key_block</span> <span class="o">=</span> <span class="n">PRF</span><span class="p">(</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">master_secret</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">&quot;key expansion&quot;</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">SecurityParameters</span><span class="p">.</span><span class="n">server_random</span> <span class="o">+</span>
</span><span class='line'>                  <span class="n">SecurityParameters</span><span class="p">.</span><span class="n">client_random</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后，key_block像下面这样被分割：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">client_write_MAC_key</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">mac_key_length</span><span class="p">]</span>
</span><span class='line'>  <span class="n">server_write_MAC_key</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">mac_key_length</span><span class="p">]</span>
</span><span class='line'>  <span class="n">client_write_key</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">enc_key_length</span><span class="p">]</span>
</span><span class='line'>  <span class="n">server_write_key</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">enc_key_length</span><span class="p">]</span>
</span><span class='line'>  <span class="n">client_write_IV</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">fixed_iv_length</span><span class="p">]</span>
</span><span class='line'>  <span class="n">server_write_IV</span><span class="p">[</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">fixed_iv_length</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>  TLS使用HMAC结构，和在CipherSuite中指定的hash函数（安全等级起码是SHA256的水平）
  来构造PRF，</p>

<p>首先定义P_hash，把(secret,seed)扩展成无限长的字节流：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">P_hash</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="o">=</span> <span class="n">HMAC_hash</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">seed</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                         <span class="n">HMAC_hash</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">seed</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>                         <span class="n">HMAC_hash</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中"+&ldquo;表示字符串拼接。
  A() 定义为:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">A</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">seed</span>
</span><span class='line'>  <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">HMAC_hash</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>   TLS的 PRF 就是把 P_hash 应用在secret上:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">PRF</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="o">=</span> <span class="n">P_</span><span class="o">&lt;</span><span class="n">hash</span><span class="o">&gt;</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">label</span> <span class="o">+</span> <span class="n">seed</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>   其中 label 是一个协议规定的，固定的 ASCII string.</p>

<p>要注意的是，TLS 1.3里面已经废弃了这种方式，改为使用<strong>更靠谱的 HKDF</strong>，HKDF 也是 html5的WebCryptoAPI的标准算法之一。</p>

<a name="L5..handshake......."></a>
<h2>5. handshake 协议</h2>

<p>handshake protocol重要而繁琐。</p>

<p>TLS 1.3对握手做了大修改，下面先讲TLS 1.2，讲完再介绍一下分析TLS 1.3.</p>

<a name="L1.handshake..............."></a>
<h3>1.handshake的总体流程</h3>

<p>handshake protocol用于产生给record protocol使用的SecurityParameters。
在handshake中:</p>

<ul>
<li>客户端和服务器端协商TLS协议版本号和一个CipherSuite，</li>
<li>认证对端的身份（可选，一般如https是客户端认证服务器端的身份），</li>
<li>并且使用密钥协商算法生成共享的master secret。</li>
</ul>


<p>步骤如下：</p>

<ul>
<li><p>  交换Hello消息，协商出算法，交换random值，检查session resumption.</p></li>
<li><p>  交换必要的密码学参数，来允许client和server协商出premaster secret。</p></li>
<li><p>  交换证书和密码学参数，让client和server做认证，证明自己的身份。</p></li>
<li><p>  从premaster secret和交换的random值 ，生成出master secret。</p></li>
<li><p>  把SecerityParameters提供被record层。</p></li>
<li><p>  允许client和server确认对端得出了相同的SecurityParameters，并且握手过程的数据没有被攻击者篡改。</p></li>
</ul>


<p>Handshake的结果是在双方建立相同的Session，Session 包含下列字段：</p>

<ol>
<li>session identifier
 session id，用来唯一标识一个session，在session 恢复的时候，也要用到</li>
<li>peer certificate
 对端的 X509v3 格式证书. 如果不需要认证对端的身份，就为空。</li>
<li>compression method
 压缩算法，一般被禁用</li>
<li>cipher spec
 CipherSuite，如上文介绍，包含： 用于生成key的pseudorandom function (PRF) , 块加密算法例如AES, MAC算法 (例如 HMAC-SHA256). 还包括一个 mac_length字段，在后文的we握手协议介绍</li>
<li>master secret
 48字节的，client和server共享密钥。</li>
<li>is resumable
 一个标志位，用来标识当前session是否能被恢复。</li>
</ol>


<p>以上字段，随后被用于生成 record层的SecurityParameters，多个连接可以通过握手协议的session恢复功能来复用同一个session。</p>

<p>握手协议使用 非对称加密/密钥协商/数字签名  3类算法，
因此要求读者对这3类算法概念清晰，能准确区分。
在此澄清一下,：
非对称的算法分为3类:
，
*  非对称加密，有：RSAES-PKCS1-v1_5，RSAES-OAEP ,Rabin-Williams-OAEP, Rabin-Williams-PKCS1-v1_5等
*  非对称密钥协商，有：DH，DHE，ECDH，ECDHE 等
*  非对称数字签名：RSASSA-PKCS1-v1_5，RSASSA-PSS，ECDSA，DSA，ED25519 等</p>

<p>另外，<strong>非对称加密算法，可以当作密钥协商算法来用，所以 RSAES-PKCS1-v1_5，RSAES-OAEP 也可以当作密钥协商算法来用</strong>。</p>

<hr />

<p>插播一段 RSA：</p>

<p>RSA的实际工程应用，要遵循PKCS#1 标准，见 <a href="https://www.ietf.org/rfc/rfc3447">https://www.ietf.org/rfc/rfc3447</a></p>

<p>其中的 RSAES-PKCS1-v1_5 和 RSASSA-PKCS1-v1_5 是使用RSA算法的两种不同scheme（体制）。
RSAES表示 RSA Encryption schemes，即非对称加密，
RSAES有：RSAES-OAEP，RSAES-PKCS1-v1_5两种，其中RSAES-OAEP更新更安全</p>

<p>RSASSA表示 Signature schemes with appendix，即appendix模式(appendix和recovery的区别请参看密码学教材)的非对称数字签名算法。
RSASSA有： RSASSA-PSS, RSASSA-PKCS1-v1_5 两种， 其中RSASSA-PSS更新更安全</p>

<p>RSA还有一个缺陷，就是很容易被时间侧通道攻击，所以现在的RSA实现都要加 blinding ，后文有介绍。</p>

<p>可以看到，RSA是一种很特殊的算法，既可以当非对称加密算法使用，又可以当非对称数字签名使用。这一点很有迷惑性，其实很多用RSA的人都分不清自己用的是RSA的哪种模式。</p>

<p>相比之下，ECC(椭圆曲线)这一块的算法就很清晰，ECDSA只能用作数字签名，ECDH只能用作密钥交换。</p>

<p>分清楚 RSAES-PKCS1-v1_5 和 RSASSA-PKCS1-v1_5 有什么用涅？</p>

<p>PKCS#1规范解释：</p>

<blockquote><p>   A generally good cryptographic practice is to employ a given RSA
key    pair in only one scheme.  This avoids the risk that
vulnerability in    one scheme may compromise the security of the
other, and may be    essential to maintain provable security.</p></blockquote>

<p>FIPS PUB 186-3  美国标准规定：</p>

<blockquote><p>An RSA key pair used for digital signatures shall only be used for one
digital signature scheme (e.g., ANS X9.31, RSASSA-PKCS1 v1.5 or
RSASSA-PSS; see Sections 5.4 and 5.5). In addition, an RSA digital
signature key pair shall not be used for other purposes (e.g., key
establishment).</p></blockquote>

<p><strong>一对密钥只做一个用途，要么用作非对称加解密，要么用作签名验证，别混着用！</strong>
<strong>一对密钥只做一个用途，要么用作非对称加解密，要么用作签名验证，别混着用！</strong>
<strong>一对密钥只做一个用途，要么用作非对称加解密，要么用作签名验证，别混着用！</strong></p>

<p>这个要求，决定了一个协议的 PFS（前向安全性），在斯诺登曝光NSA的“今日捕获，明日破解”政策后，<strong>越发重要</strong>。</p>

<p><a href="https://news.ycombinator.com/item?id=5942534">https://news.ycombinator.com/item?id=5942534</a></p>

<p><a href="http://news.netcraft.com/archives/2013/06/25/ssl-intercepted-today-decrypted-tomorrow.html">http://news.netcraft.com/archives/2013/06/25/ssl-intercepted-today-decrypted-tomorrow.html</a></p>

<p><a href="https://lwn.net/Articles/572926/">https://lwn.net/Articles/572926/</a></p>

<p><a href="https://www.eff.org/deeplinks/2014/04/why-web-needs-perfect-forward-secrecy">https://www.eff.org/deeplinks/2014/04/why-web-needs-perfect-forward-secrecy</a></p>

<p><a href="http://www.wired.com/2013/10/lavabit_unsealed">http://www.wired.com/2013/10/lavabit_unsealed</a></p>

<p>PFS反映到密钥协商过程中，就是：</p>

<ul>
<li> <strong>不要使用RSA做密钥协商，一定只用RSA做数字签名</strong>。</li>
<li> <strong>不要把ECDH的公钥固定内置在客户端做密钥协商</strong></li>
</ul>


<p>后文可以看到这一原则在 TLS 1.3,  QUIC，Apple的iMessage等协议中一再贯彻。</p>

<p>非对称RSA/ECC这个话题比较大了，后面有空再写文章吧，读者可以先看一下参考资料，里面有清晰的介绍。</p>

<p>插播结束，继续TLS。</p>

<hr />

<p>由于设计的时候，就要考虑兼容性，而且实际历史悠久，所以TLS协议90年代曾经使用的一些算法，现在已经被破解了，例如有的被发现漏洞(rc4)，有的密钥长度过短(例如曾经美帝有出口限制，限制RSA 在512比特以下，对称加密密钥限制40比特以下，后来2005年限制被取消)，但是考虑到兼容，现在的TLS实现中，还是包含了这种已经被破解的老算法的代码。这样，如果攻击者可以干扰握手过程，诱使client和server使用这种已经被破解的算法，就会威胁TLS协议的安全，这被称为“降级攻击”。</p>

<p>为了在握手协议解决降级攻击的问题，TLS协议规定：client发送ClientHello消息，server必须回复ServerHello消息，否则就是fatal error，当成连接失败处理。ClientHello和ServerHello消息用于建立client和server之间的安全增强能力，ClientHello和ServerHello消息建立如下属性：</p>

<ul>
<li>Protocol Version</li>
<li>Session ID</li>
<li>Cipher Suite</li>
<li>Compression Method.</li>
</ul>


<p>另外，产生并交换两个random值 ClientHello.random 和 ServerHello.random</p>

<p>密钥协商使用四条： server的Certificate，ServerKeyExchange，client的Certificate，ClientKeyExchange 。TLS规定以后如果要新增密钥协商方法，可以订制这4条消息的数据格式，并且指定这4条消息的使用方法。密钥协商得出的共享密钥<strong>必须足够长</strong>，<strong>当前定义的密钥协商算法生成的密钥长度必须大于46字节</strong>。</p>

<p>在hello消息之后，server会把自己的证书在一条Certificate消息里面发给客户端(如果需要做服务器端认证的话，例如https)。 并且，如果需要的话，server会发送一条ServerKeyExchange消息，（例如如果服务器的证书只用做签名，不用做密钥交换，或者服务器没有证书）。client对server的认证完成后，server可以要求client发送client的证书，如果这是协商出来的CipherSuite允许的。下一步，server会发送ServerHelloDone消息，表示握手的hello消息部分已经结束。然后server会等待一个client的响应。如果server已经发过了CertificateRequest消息，client必须发送Certificate消息。然后发送ClientKeyExchange消息，并且这条消息的内容取决于ClientHello和ServerHello消息协商的算法。如果client发送了有签名能力的证书，就显式发送一个经过数字签名的CertificateVerify消息，来证明自己拥有证书私钥。</p>

<p>然后，client发送一个ChangeCipherSpec消息，并且client拷贝待定的Cipher  Spec到当前的Cipher Spec。然后client立即用新算法+新key+新密钥 发送Finished消息。收到后，server发送自己的ChangeCipherSpec消息，作为响应，并且拷贝待定的Cipher Spec到当前的Cipher Spec。此时，握手就完成了，client和server可以开始交换应用层数据（如下图所示）。应用层数据不得在握手完成前发送。</p>

<p>引用一个来自网络的图片：
<img src="https://blog.helong.info//images/blog/tls/tls_handshake.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>      <span class="n">Client</span>                                               <span class="n">Server</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">ClientHello</span>                  <span class="o">--------&gt;</span>
</span><span class='line'>                                                      <span class="n">ServerHello</span>
</span><span class='line'>                                                     <span class="n">Certificate</span><span class="o">*</span>
</span><span class='line'>                                               <span class="n">ServerKeyExchange</span><span class="o">*</span>
</span><span class='line'>                                              <span class="n">CertificateRequest</span><span class="o">*</span>
</span><span class='line'>                                   <span class="o">&lt;--------</span>      <span class="n">ServerHelloDone</span>
</span><span class='line'>      <span class="n">Certificate</span><span class="o">*</span>
</span><span class='line'>      <span class="n">ClientKeyExchange</span>
</span><span class='line'>      <span class="n">CertificateVerify</span><span class="o">*</span>
</span><span class='line'>      <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>      <span class="n">Finished</span>                     <span class="o">--------&gt;</span>
</span><span class='line'>                                               <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>                                   <span class="o">&lt;--------</span>             <span class="n">Finished</span>
</span><span class='line'>      <span class="n">Application</span> <span class="n">Data</span>             <span class="o">&lt;-------&gt;</span>     <span class="n">Application</span> <span class="n">Data</span>
</span><span class='line'>
</span><span class='line'>             <span class="n">Figure</span> <span class="mf">1.</span>  <span class="n">Message</span> <span class="n">flow</span> <span class="k">for</span> <span class="n">a</span> <span class="n">full</span> <span class="n">handshake</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">*</span> <span class="err">表示可选的消息，或者根据上下文在某些情况下会发送的消息。</span><span class="n">Indicates</span> <span class="n">optional</span> <span class="n">or</span> <span class="n">situation</span><span class="o">-</span><span class="n">dependent</span> <span class="n">messages</span> <span class="n">that</span> <span class="n">are</span> <span class="n">not</span>
</span><span class='line'>   <span class="n">always</span> <span class="n">sent</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>注：为了帮助解决管道阻塞的问题，ChangeCipherSpec是一个独立的TLS protocol content type，并不是一个握手消息。</p>

<p>TLS的完整握手过程，要进行RSA/ECDH/ECDSA等非对称计算，非对称计算是很慢的。关于非对称的性能：
例如在2015年的服务器cpu：  Intel&reg; Xeon&reg; CPU E3-1230 V2 @ 3.30GHz 上，
使用如下命令测试：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>openssl speed rsa2048
</span><span class='line'>openssl speed ecdsap256
</span><span class='line'>openssl speed ecdhp256
</span><span class='line'>openssl speed aes-128-cbc
</span><span class='line'>openssl speed -evp aes-128-cbc
</span></code></pre></td></tr></table></div></figure>


<p>结果如下表：</p>

<table>
<thead>
<tr>
<th> 算法   </th>
<th> 性能 </th>
<th> 性能  </th>
</tr>
</thead>
<tbody>
<tr>
<td>RSA-2048 </td>
<td> 私钥运算 723.7 次/秒   </td>
<td> 公钥运算 23505.8 次/秒 </td>
</tr>
<tr>
<td> 256 bit ecdsa (nistp256)  </td>
<td> 签名   8628.4 次/秒    </td>
<td> 验证  2217.0 次/秒 </td>
</tr>
<tr>
<td> 256 bit ecdh (nistp256) </td>
<td>  ECDH协商 2807.8 次/秒</td>
<td></td>
</tr>
<tr>
<td> aes-128-cbc </td>
<td> 加密 121531.39 K/秒</td>
<td></td>
</tr>
<tr>
<td> aes-128-cbc 使用aesni硬件加速</td>
<td>  加密 683682.13 K/秒 </td>
<td></td>
</tr>
</tbody>
</table>


<p>注：非对称的单位是 次/秒，这是由于非对称一般只用于处理一个block，
对称的单位是 K/秒，因为对称一般用于处理大量数据流，所以单位和流量一样。
可以给非对称的 次/秒 乘以 block  size ，就可以和对称做比较了。例如rsa-2048，723.7*2048/8/1024=185.2672 K/秒 ，
故 <strong>RSA-2048 私钥运算性能 是aes-128-cbc 的 $1.5/1000$。是aesni的 $2.6/10000$</strong>。</p>

<p>如上，性能数据惨不忍睹， <strong>简直不能忍！！！</strong></p>

<p>有鉴于此，TLS从设计之初，就采用了万能手段&ndash;<strong>加cache</strong>，有2种cache手段：session id，和session ticket。把握手的结果直接cache起来，绕过握手运算。</p>

<p>当client和server决定恢复一个之前的session，或复用一个已有的session时(可以不用协商一个新的SecurityParameters)，消息流程如下：</p>

<p>   客户端使用要被恢复的session，发送一个ClientHello，把Session ID包含在其中。server在自己的session cache中，查找客户端发来的Session ID，如果找到，sever把找到的session 状态恢复到当前连接，然后发送一个ServerHello，在ServerHello中把Session ID带回去。然后，client和server都必须ChangeCipherSpec消息，并紧跟着发送Finished消息。这几步完成后，client和server 开始交换应用层数据（如下图所示）。如果server在session cache中没有找到Session ID，那server就生成一个新的session ID在ServerHello里给客户端，并且client和server进行完整的握手。</p>

<p>   流程图如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">Client</span>                                                <span class="n">Server</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ClientHello</span>                   <span class="o">--------&gt;</span>
</span><span class='line'>                                                   <span class="n">ServerHello</span>
</span><span class='line'>                                            <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>                                <span class="o">&lt;--------</span>             <span class="n">Finished</span>
</span><span class='line'>  <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>  <span class="n">Finished</span>                      <span class="o">--------&gt;</span>
</span><span class='line'>  <span class="n">Application</span> <span class="n">Data</span>              <span class="o">&lt;-------&gt;</span>     <span class="n">Application</span> <span class="n">Data</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Figure</span> <span class="mf">2.</span>  <span class="n">Message</span> <span class="n">flow</span> <span class="k">for</span> <span class="n">an</span> <span class="n">abbreviated</span> <span class="n">handshake</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L3..handshake..................."></a>
<h3>3. handshake 协议外层结构</h3>

<p>   从消息格式来看，TLS Handshake Protocol 在 TLS Record Protocol 的上层. 这个协议用于协商一个session的安全参数。 Handshake 消息（例如ClientHello，ServerHello等） 被包装进 TLSPlaintext结构里面，传入TLS record层，根据当前session 状态做处理，然后传输。</p>

<p>如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">hello_request</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">client_hello</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">server_hello</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>      <span class="n">certificate</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">server_key_exchange</span> <span class="p">(</span><span class="mi">12</span><span class="p">),</span>
</span><span class='line'>      <span class="n">certificate_request</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">server_hello_done</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span>
</span><span class='line'>      <span class="n">certificate_verify</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">client_key_exchange</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
</span><span class='line'>      <span class="n">finished</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">HandshakeType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">HandshakeType</span> <span class="n">msg_type</span><span class="p">;</span>    <span class="cm">/* handshake type */</span>
</span><span class='line'>      <span class="n">uint24</span> <span class="n">length</span><span class="p">;</span>             <span class="cm">/* bytes in message */</span>
</span><span class='line'>      <span class="n">select</span> <span class="p">(</span><span class="n">HandshakeType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">hello_request</span><span class="p">:</span>       <span class="n">HelloRequest</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">client_hello</span><span class="p">:</span>        <span class="n">ClientHello</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">server_hello</span><span class="p">:</span>        <span class="n">ServerHello</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">certificate</span><span class="p">:</span>         <span class="n">Certificate</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">server_key_exchange</span><span class="p">:</span> <span class="n">ServerKeyExchange</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">certificate_request</span><span class="p">:</span> <span class="n">CertificateRequest</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">server_hello_done</span><span class="p">:</span>   <span class="n">ServerHelloDone</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">certificate_verify</span><span class="p">:</span>  <span class="n">CertificateVerify</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">client_key_exchange</span><span class="p">:</span> <span class="n">ClientKeyExchange</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">finished</span><span class="p">:</span>            <span class="n">Finished</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">session_ticket</span><span class="p">:</span>      <span class="n">NewSessionTicket</span><span class="p">;</span> <span class="cm">/* NEW */</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">body</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">Handshake</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>TLS协议规定，handshake 协议的消息必须按照规定的顺序发，收到不按顺序来的消息，当成fatal error处理。也就是说，TLS协议可以当成状态机来建模编码。</p>

<p>下面按照消息发送必须遵循的顺序，逐个解释每一条握手消息。</p>

<p>handshake协议的外层字段，见这个抓包：</p>

<p>  <img src="https://blog.helong.info//images/blog/tls/handshake_protocol.png" alt="" /></p>

<a name="L4..handshake..--.ClientHello...ServerHello...HelloRequest"></a>
<h3>4. handshake  &ndash; ClientHello，ServerHello，HelloRequest</h3>

<p>Hello消息有3个：ClientHello, ServerHello，HellloRequest
逐个说明：</p>

<a name="L4.1.Client.Hello"></a>
<h4>4.1 Client Hello</h4>

<p>当客户端第一次连接到服务器时，第一条message必须发送ClientHello。
另外，rfc里规定，如果客户端和服务器支持重协商，在客户端收到服务器发来的HelloRequest后，也可以回一条ClientHello，在一条已经建立的连接上开始重协商。(重协商是个很少用到的特性。)</p>

<p>消息结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>   <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">uint32</span> <span class="n">gmt_unix_time</span><span class="p">;</span>
</span><span class='line'>       <span class="n">opaque</span> <span class="n">random_bytes</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
</span><span class='line'>   <span class="p">}</span> <span class="n">Random</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">opaque</span> <span class="n">SessionID</span><span class="o">&lt;</span><span class="mf">0..32</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">uint8</span> <span class="n">CipherSuite</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">enum</span> <span class="p">{</span> <span class="n">null</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="p">}</span> <span class="n">CompressionMethod</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">ProtocolVersion</span> <span class="n">client_version</span><span class="p">;</span>
</span><span class='line'>       <span class="n">Random</span> <span class="n">random</span><span class="p">;</span>
</span><span class='line'>       <span class="n">SessionID</span> <span class="n">session_id</span><span class="p">;</span>
</span><span class='line'>       <span class="n">CipherSuite</span> <span class="n">cipher_suites</span><span class="o">&lt;</span><span class="mf">2..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>       <span class="n">CompressionMethod</span> <span class="n">compression_methods</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>       <span class="n">select</span> <span class="p">(</span><span class="n">extensions_present</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="k">case</span> <span class="nb">false</span><span class="o">:</span>
</span><span class='line'>               <span class="k">struct</span> <span class="p">{};</span>
</span><span class='line'>           <span class="k">case</span> <span class="nb">true</span><span class="o">:</span>
</span><span class='line'>               <span class="n">Extension</span> <span class="n">extensions</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">};</span>
</span><span class='line'>   <span class="p">}</span> <span class="n">ClientHello</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Random 其中：
      gmt_unix_time 是 unix epoch时间戳。
      random_bytes 是 28字节的，用密码学安全随机数生成器 生成出来的随机数。</p>

<hr />

<p>密码学安全的随机数生成，这是个很大的话题，也是一个大陷阱，目前最好的做法就是用 /dev/urandom，或者openssl库的 RAND_bytes()</p>

<p>历史上，恰好就在SSL的random_bytes这个字段，NetScape浏览器早期版本被爆出过随机数生成器漏洞。
被爆菊的随机数生成器使用 pid + 时间戳 来初始化一个seed，并用MD5(seed)得出结果。
见 <a href="http://www.cs.berkeley.edu/~daw/papers/ddj-netscape.html">http://www.cs.berkeley.edu/~daw/papers/ddj-netscape.html</a>，
建议读者检查一下自己的随机数生成器。</p>

<hr />

<dl>
<dt>client_version</dt>
<dd><pre><code> 客户端支持的最高版本号。
</code></pre></dd>
<dt>random</dt>
<dd><pre><code>客户端生成的random。
</code></pre></dd>
</dl>

<p>ClientHello.session_id 唯一标识一个session，用来做session cache。如果为空，表示不做复用，要求服务器生成新的session。
session_id的来源有：</p>

<ol>
<li>之前的协商好的连接的session_id</li>
<li>当前连接的session_id</li>
<li>当前也在使用中的另一条连接的session_id</li>
</ol>


<p>其中第三种允许不做重新握手，就同时建立多条独立的安全连接。这些独立的连接可能顺序创建，也可以同时创建。一个SessionID当握手协商的Finished消息完成后，就合法可用了。存活直到太旧被移除，或者session 关联的某个连接发生fatal error。SessionID的内容由服务器端生成。</p>

<p>注：由于SessionID的传输是不加密，不做MAC保护的，服务器不允许把私密信息发在里面，不能允许伪造的SessionID在服务器造成安全问题。（握手过程中的数据，整体是受Finished消息的保护的）</p>

<p>ClientHello.cipher_suites字段，包含了客户端支持的CipherSuite的列表，按照客户端希望的优先级排序，每个CipherSuite有2个字节，每个CipherSuite由：一个密钥交换算法，一个大量数据加密算法(需要制定key length参数)，一个MAC算法，一个PRF 构成。服务器会从客户端发过来的列表中选择一个；如果没有可以接受的选择，就返回一个 handshake failure 的 alert，并关闭连接。如果列表包含服务器不认识，不支持，或者禁用的CipherSuite，服务器必须忽略。
如果SessionID不为空，则cipher_suites里面起码要包含客户端cache的session里面的那个CipherSuite</p>

<p>compression_methods，类似地，ClientHello里面包含压缩算法的列表，按照客户端优先级排序。当然，如前介绍，服务器一般禁用TLS的压缩。</p>

<p>compression_methods 后面可以跟一组扩展(extensions)， extensions都是可选的，比较有用的扩展如： SNI, session ticket，ALPN，OCSP 等，后文介绍。</p>

<p>客户端发送了ClientHello后，服务器端必须回复ServerHello消息，回复其他消息都会导致 fatal error 关闭连接。</p>

<a name="L4.2..Server.Hello"></a>
<h4>4.2  Server Hello</h4>

<p>当收到客户端发来的ClientHello后，正常处理完后，服务器必须回复ServerHello。</p>

<p>消息结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ProtocolVersion</span> <span class="n">server_version</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Random</span> <span class="n">random</span><span class="p">;</span>
</span><span class='line'>      <span class="n">SessionID</span> <span class="n">session_id</span><span class="p">;</span>
</span><span class='line'>      <span class="n">CipherSuite</span> <span class="n">cipher_suite</span><span class="p">;</span>
</span><span class='line'>      <span class="n">CompressionMethod</span> <span class="n">compression_method</span><span class="p">;</span>
</span><span class='line'>      <span class="n">select</span> <span class="p">(</span><span class="n">extensions_present</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nb">false</span><span class="o">:</span>
</span><span class='line'>              <span class="k">struct</span> <span class="p">{};</span>
</span><span class='line'>          <span class="k">case</span> <span class="nb">true</span><span class="o">:</span>
</span><span class='line'>              <span class="n">Extension</span> <span class="n">extensions</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ServerHello</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<dl>
<dt>server_version</dt>
<dd>  服务器选择 ClientHello.client_version 和 服务器支持的版本号 中的最小的。</dd>
<dt> random</dt>
<dd><pre><code> 服务器生成的random，必须确保和客户端生成的random没有关联。
</code></pre></dd>
<dt> session_id</dt>
<dd><pre><code> 服务器为本连接分配的SessionID。如果ClientHello.session_id不为空，服务器会在自己的本地做查找。
</code></pre></dd>
</dl>

<ul>
<li>如果找到了匹配，并且服务器决定复用找到的session建立连接，服务器应该把ClientHello.session_id同样的 session id填入ServerHello.session_id，这表示恢复了一个session，并且双方会立即发送Finished消息。</li>
<li>否则，回复一个和ClientHello.session_id不同的Serverhello.session_id，来标识新session。服务器可以回复一个空的session_id，来告诉客户端这个session不要cache，不能恢复。
如果一个session 被恢复了，那必须恢复成之前协商的session里面的 CipherSuite。要注意的是，并不要求服务器一定要恢复session，   服务器可以不做恢复。</li>
</ul>


<p>在实践中，session cache在服务器端要求key-value形式的存储，如果tls服务器不止一台的话，就有一个存储怎么共享的问题，要么存储同步到所有TLS服务器的内存里，要么专门搞服务来支持存储，并使用rpc访问，
无论如何，都是很麻烦的事情，相比之下，后文要介绍的session ticket就简单多了，所以一般优先使用session ticket。</p>

<dl>
<dt>   cipher_suite</dt>
<dd><pre><code> 服务器选定的一个CipherSuite。如果是恢复的session，那就是session里的CipherSuite。
</code></pre>

<p> compression_method</p></dd>
<dd><pre><code> 跟上面类似。
</code></pre>

<p>extensions</p></dd>
<dd>  扩展列表。要注意的是，ServerHello.extensions 必须是 ClientHello.extensions的子集。</dd>
</dl>

<a name="L4.3..Hello.Extensions"></a>
<h4>4.3  Hello Extensions</h4>

<p>   The extension 的格式是:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>      <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">ExtensionType</span> <span class="n">extension_type</span><span class="p">;</span>
</span><span class='line'>          <span class="n">opaque</span> <span class="n">extension_data</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">Extension</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">signature_algorithms</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="mi">65535</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">ExtensionType</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p> 其中:</p>

<ul>
<li><p>  &ldquo;extension_type&rdquo; 标识是哪一个扩展类型。</p></li>
<li><p>  &ldquo;extension_data&rdquo; 一坨二进制的buffer，扩展的数据体，各个扩展自己做解析。</p></li>
</ul>


<p>extension_type 只能出现一次，ExtensionType之间不指定顺序。</p>

<p>extensions 可能在新连接创建时被发送，也可能在要求session恢复的时候被发送。所以各个extension都需要规定自己再完整握手和session恢复情况下的行为。
这些情况比较琐碎而微妙，具体案例要具体分析。</p>

<a name="L4.4..Hello.Request"></a>
<h4>4.4  Hello Request</h4>

<p>服务器任何时候都可以发送 HelloRequest 消息。</p>

<p>HelloRequest的意思是，客户端应该开始协商过程。客户端应该在方便的时候发送ClientHello。服务器不应该在客户端刚创建好连接后，就发送HelloRequest，此时应该让客户端发送ClientHello。</p>

<p>客户端收到这个消息后，可以直接忽略这条消息。
服务器发现客户端没有响应HelloRequest后，可以发送fatal error alert。</p>

<p>消息结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span> <span class="p">}</span> <span class="n">HelloRequest</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>   HelloRequest不包含在握手消息的hash计算范围内。</p>

<a name="L5..handshake.--.Server.Certificate"></a>
<h3>5. handshake &ndash; Server Certificate</h3>

<p>当服务器确定了CipherSuite后，根据CipherSuite里面的认证算法，如果需要发送证书给客户端，那么就发送 Server Certificate消息给客户端。Server Certificate总是在ServerHello之后立即发送，所以在同一个RTT里。</p>

<p>Server Certificate里面包含了服务器的证书链。</p>

<p>消息结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">opaque</span> <span class="n">ASN</span><span class="mf">.1</span><span class="n">Cert</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">24</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ASN</span><span class="mf">.1</span><span class="n">Cert</span> <span class="n">certificate_list</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">24</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">Certificate</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<dl>
<dt>   certificate_list</dt>
<dd><pre><code> 证书列表，**发送者的证书必须是第一个，后续的每一个证书都必须是前一个的签署证书。根证书可以省略**
</code></pre></dd>
</dl>

<p>证书申请的时候，一般会收到好几个证书，有的需要自己按照这个格式来拼接成证书链。</p>

<p> 如果服务器要认证客户端的身份，那么服务器会发送Certificate Request消息，客户端应该也以 这条Server Certificate消息的格式回复。</p>

<p>服务器发送的证书必须：</p>

<ul>
<li><p>  证书类型必须是 X.509v3。除非明确地协商成别的了(比较少见，rfc里提到了例如 <a href="https://tools.ietf.org/html/rfc5081">OpenPGP格式</a>)。</p></li>
<li><p>  服务器证书的公钥，必须和选择的密钥交换算法配套。</p></li>
</ul>


<table>
<thead>
<tr>
<th>     密钥交换+认证算法 </th>
<th> 配套的证书中公钥类型 </th>
</tr>
</thead>
<tbody>
<tr>
<td>     RSA  /  RSA_PSK           </td>
<td> RSA 公钥；证书中必须允许私钥用于加密 （即如果使用了X509V3规定的key usage扩展， keyEncipherment比特位必须置位） <strong>这种用法没有前向安全性，因此在 TLS 1.3中被废弃了</strong> </td>
</tr>
<tr>
<td>                </td>
<td></td>
</tr>
<tr>
<td>     DHE_RSA /  ECDHE_RSA        </td>
<td> RSA 公钥；证书中必须允许私钥用于签名(即如果使用了X509V3规定的key usage扩展， digitalSignature比特位必须置位)，并且允许server key exchange消息将要使用的签名模式(例如 PKCS1_V1.5 ，OAEP等)和hash算法(例如sha1, sha256等) </td>
</tr>
<tr>
<td>              </td>
<td></td>
</tr>
<tr>
<td>      DHE_DSS           </td>
<td> DSA 公钥; 历史遗留产物，从来没有被大规模用过，安全性差，废弃状态。证书必须允许私钥用于签名，必须允许server key exchange消息中使用的hash算法。</td>
</tr>
<tr>
<td>        DH_DSS   / DH_RSA  </td>
<td> Diffie-Hellman 公钥; 要求key usage里面的keyAgreement比特位必须置位。 <strong>这种用法没有前向安全性，因此在 TLS 1.3中被废弃了</strong> </td>
</tr>
<tr>
<td>               </td>
<td></td>
</tr>
<tr>
<td>  ECDH_ECDSA   / ECDH_RSA      </td>
<td> 能做 ECDH 用途的公钥；公钥必须使用 客户端支持的ec曲线和点格式。<strong>这种用法没有前向安全性，因此在 TLS 1.3中被废弃了</strong></td>
</tr>
<tr>
<td>            </td>
<td></td>
</tr>
<tr>
<td>  ECDHE_ECDSA        </td>
<td> ECDSA用途的公钥；证书必须运输私钥用作签名，必须允许server key exchange消息里面要用到的hash算法。公钥必须使用客户端支持的ec曲线和点格式。</td>
</tr>
</tbody>
</table>


<ul>
<li>  &ldquo;server_name&rdquo; 和 &ldquo;trusted_ca_keys&rdquo; 扩展用于引导证书选择。</li>
</ul>


<p>其中有5种是ECC密钥交换算法：ECDH_ECDSA, ECDHE_ECDSA, ECDH_RSA, ECDHE_RSA, ECDH_anon。
ECC（椭圆曲线）体制相比RSA，由于公钥更小，性能更高，所以在移动互联网环境下越发重要。
以上ECC的5种算法都用ECDH来计算premaster  secret， 仅仅是ECDH密钥的生命周期和认证算法不同。
其中只有 ECDHE_ECDSA 和 ECDHE_RSA 是前向安全的。</p>

<p>如果客户端在ClientHello里提供了 &ldquo;signature_algorithms&rdquo; 扩展，那么服务器提供的所有证书必须用 &ldquo;signature_algoritms"中提供的 hash/signature算法对 之一签署。要注意的是，这意味着，一个包含某种签名算法密钥的证书，可能被另一种签名算法签署（例如，一个RSA公钥可能被一个ECDSA公钥签署）。(这在TLS1.2和TLS1.1中是不一样的，TLS1.1要求所有的算法都相同。)注意这也意味着DH_DSS,DH_RSA,ECDH_ECDSA,和ECDH_RSA 密钥交换不限制签署证书的算法。固定DH证书可能使用"signature_algorithms"扩展列表中的 hash/签名算法对 中的某一个签署。名字 DH_DSS, DH_RSA, ECDH_ECDSA, 和 ECDH_RSA 只是历史原因，这几个名字的后半部分中指定的算法，并不会被使用，即DH_DSS中的DSS并不会被使用，DH_RSA中并不会使用RSA做签名，ECDH_ECDSA并不会使用ECDSA算法。。。
如果服务器有多个证书，就必须从中选择一个，一般根据服务器的外网ip地址，SNI中指定的hostname，服务器配置来做选择。如果服务器只有一个证书，那么要确保这一个证书符合这些条件。
要注意的是，存在一些证书使用了TLS目前不支持的 算法组合。例如，使用 RSASSA-PSS签名公钥的证书（即证书的SubjectPublicKeyInfo字段是id-RSASSA-PSS）。由于TLS没有给这些算法定义对应的签名算法，这些证书不能在TLS中使用。
如果一个CipherSuite指定了新的TLS密钥交换算法，也会指定证书格式和要求的密钥编码方法。</p>

<a name="L6..handshake..--.Server.Key.Exchange"></a>
<h3>6. handshake  &ndash; Server Key Exchange</h3>

<p>服务器会在 server Certificate 消息之后，立即发送 Server Key Exchange消息。
（如果协商出的CipherSuite不需要做认证，即anonymous negotiation，会在ServerHello之后立即发送Server Key Exchange消息）</p>

<p>只有在server Certificate 消息没有足够的信息，不能让客户端完成premaster的密钥交换时，服务器才发送 server Key Exchange， 主要是对前向安全的几种密钥协商算法，列表如下：</p>

<ol>
<li>DHE_DSS</li>
<li>DHE_RSA</li>
<li>DH_anon</li>
<li>ECDHE_ECDSA</li>
<li>ECDHE_RSA</li>
<li>ECDH_anon</li>
</ol>


<p>对下面几种密钥交换方法，发送ServerKeyExchange消息是非法的：</p>

<ol>
<li>RSA</li>
<li>DH_DSS</li>
<li>DH_RSA</li>
<li>ECDH_ECDSA</li>
<li>ECDH_RSA</li>
</ol>


<p>需要注意的是，ECDH和ECDSA公钥的数据结构是一样的。所以，CA在签署一个证书的时候，可能要使用 X.509 v3 的 keyUsage 和 extendedKeyUsage 扩展来限定ECC公钥的使用方式。</p>

<p>ServerKeyExchange传递足够的信息给客户端，来让客户端交换premaster secret。一般要传递的是：一个 Diffie-Hellman 公钥，或者一个其他算法(例如RSA)的公钥。</p>

<p>在TLS实际部署中，我们一般只使用这4种：ECDHE_RSA, DHE_RSA,  ECDHE_ECDSA，RSA</p>

<p>其中RSA密钥协商（也可以叫密钥传输）算法，由于没有前向安全性，在TLS 1.3里面已经被废除了。参见： <a href="http://www.ietf.org/mail-archive/web/tls/current/msg12266.html">Confirming Consensus on removing RSA key Transport from TLS   1.3 </a></p>

<p>消息格式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">enum</span> <span class="p">{</span> <span class="n">dhe_dss</span><span class="p">,</span> <span class="n">dhe_rsa</span><span class="p">,</span> <span class="n">dh_anon</span><span class="p">,</span> <span class="n">rsa</span><span class="p">,</span> <span class="n">dh_dss</span><span class="p">,</span> <span class="n">dh_rsa</span><span class="p">,</span>    <span class="n">ec_diffie_hellman</span>
</span><span class='line'>       <span class="p">}</span> <span class="n">KeyExchangeAlgorithm</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">dh_p</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">dh_g</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">dh_Ys</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ServerDHParams</span><span class="p">;</span>     <span class="cm">/* Ephemeral DH parameters */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dh_p</span>
</span><span class='line'>     <span class="n">Diffie</span><span class="o">-</span><span class="n">Hellman</span><span class="err">密钥协商计算的大质数模数。</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dh_g</span>
</span><span class='line'>     <span class="n">Diffie</span><span class="o">-</span><span class="n">Hellman</span> <span class="err">的生成元，</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dh_Ys</span>
</span><span class='line'>     <span class="err">服务器的</span><span class="n">Diffie</span><span class="o">-</span><span class="n">Hellman</span><span class="err">公钥</span> <span class="p">(</span><span class="n">g</span><span class="o">^</span><span class="n">X</span> <span class="n">mod</span> <span class="n">p</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">opaque</span> <span class="n">point</span> <span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">ECPoint</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">enum</span> <span class="p">{</span> <span class="n">explicit_prime</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">explicit_char2</span> <span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>           <span class="n">named_curve</span> <span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">reserved</span><span class="p">(</span><span class="mf">248..255</span><span class="p">)</span> <span class="p">}</span> <span class="n">ECCurveType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ECCurveType</span>    <span class="n">curve_type</span><span class="p">;</span>
</span><span class='line'>        <span class="n">select</span> <span class="p">(</span><span class="n">curve_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="nl">named_curve</span><span class="p">:</span>
</span><span class='line'>                <span class="n">NamedCurve</span> <span class="n">namedcurve</span><span class="p">;</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">ECParameters</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ECParameters</span>    <span class="n">curve_params</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ECPoint</span>         <span class="n">public</span><span class="p">;</span> <span class="c1">//ECDH的公钥</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">ServerECDHParams</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">select</span> <span class="p">(</span><span class="n">KeyExchangeAlgorithm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dh_anon</span><span class="p">:</span>
</span><span class='line'>              <span class="n">ServerDHParams</span> <span class="n">params</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dhe_dss</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dhe_rsa</span><span class="p">:</span>
</span><span class='line'>              <span class="n">ServerDHParams</span> <span class="n">params</span><span class="p">;</span>
</span><span class='line'>              <span class="n">digitally</span><span class="o">-</span><span class="kt">signed</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">opaque</span> <span class="n">client_random</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>                  <span class="n">opaque</span> <span class="n">server_random</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>                  <span class="n">ServerDHParams</span> <span class="n">params</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span> <span class="n">signed_params</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">ec_diffie_hellman</span><span class="p">:</span>
</span><span class='line'>              <span class="n">ServerECDHParams</span>    <span class="n">params</span><span class="p">;</span>
</span><span class='line'>              <span class="n">Signature</span>           <span class="n">signed_params</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">rsa</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dh_dss</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dh_rsa</span><span class="p">:</span>
</span><span class='line'>              <span class="k">struct</span> <span class="p">{}</span> <span class="p">;</span>
</span><span class='line'>          <span class="cm">/* message is omitted for rsa, dh_dss, and dh_rsa */</span>
</span><span class='line'>          <span class="cm">/* may be extended, e.g., for ECDH -- see [TLSECC] */</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ServerKeyExchange</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">params</span>
</span><span class='line'>     <span class="err">服务器的密钥交换参数。</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">signed_params</span>
</span><span class='line'>     <span class="err">对需要认证的（即非</span><span class="n">anonymous</span><span class="err">的）密钥交换，对服务器的密钥交换参数的数字签名。</span>
</span></code></pre></td></tr></table></div></figure>


<p>ECParameters 结构比较麻烦，其中ECCurveType是支持3种曲线类型的，可以自行指定椭圆曲线的多项式系数，基点等参数。但是，我们基本不会用到这种功能，因为一般部署都是使用 NamedCurve，即参数已经预先选定，各种密码学库普遍都支持的一组曲线，其中目前用的最广的是 secp256r1 （还被称为 P256，或 prime256v1）</p>

<p>NamedCurve 列表中比较重要的曲线(在TLS1.3中，只保留了这几条曲线。)，定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">secp256r1</span> <span class="p">(</span><span class="mi">23</span><span class="p">),</span> <span class="n">secp384r1</span> <span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="n">secp521r1</span> <span class="p">(</span><span class="mi">25</span><span class="p">),</span>
</span><span class='line'>        <span class="n">reserved</span> <span class="p">(</span><span class="mh">0xFE00</span><span class="p">.</span><span class="mf">.0</span><span class="n">xFEFF</span><span class="p">),</span>
</span><span class='line'>        <span class="p">(</span><span class="mh">0xFFFF</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">NamedCurve</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ECDHE_RSA 密钥交换算法的 SignatureAlgorithm 是 rsa 。
ECDHE_RSA 密钥交换算法的 SignatureAlgorithm 是 ecdsa。</p>

<p>如果客户端提供了 &ldquo;signature_algorithms&rdquo; 扩展， 则签名算法和hash算法必须是列在扩展中的算法。
要注意的是，这个地方可能有不一致，例如客户端可能提供了 DHE_DSS 密钥交换，但是 &ldquo;signature_algorithms"扩展中没有DSA算法，在这类情况下，为了正确地协商，服务器必须确保满足自己选择的CipherSuite满足 "signature_algorithms&rdquo; 的限制。这不优雅，但是是为了把对原来的CipherSuite协商的设计的改动减到最小，而做的妥协。</p>

<p>并且，hash和签名算法，必须和服务器的证书里面的公钥兼容。</p>

<a name="L7..handshake..--.Certificate.Request"></a>
<h3>7. handshake  &ndash; Certificate Request</h3>

<p>TLS规定了一个可选功能：服务器可以认证客户端的身份，这通过服务器要求客户端发送一个证书实现，服务器应该在ServerKeyExchange之后立即发送CertificateRequest消息。</p>

<p>消息结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">rsa_sign</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dss_sign</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">rsa_fixed_dh</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">dss_fixed_dh</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
</span><span class='line'>      <span class="n">rsa_ephemeral_dh_RESERVED</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">dss_ephemeral_dh_RESERVED</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
</span><span class='line'>      <span class="n">fortezza_dms_RESERVED</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>      <span class="n">ecdsa_sign</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">rsa_fixed_ecdh</span><span class="p">(</span><span class="mi">65</span><span class="p">),</span>
</span><span class='line'>      <span class="n">ecdsa_fixed_ecdh</span><span class="p">(</span><span class="mi">66</span><span class="p">),</span>
</span><span class='line'>      <span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ClientCertificateType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">opaque</span> <span class="n">DistinguishedName</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ClientCertificateType</span> <span class="n">certificate_types</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">SignatureAndHashAlgorithm</span>
</span><span class='line'>        <span class="n">supported_signature_algorithms</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">DistinguishedName</span> <span class="n">certificate_authorities</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">CertificateRequest</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<dl>
<dt>certificate_types</dt>
<dd>   客户端可以提供的证书类型。</dd>
</dl>

<ul>
<li>rsa_sign        包含RSA公钥的证书。</li>
<li>dss_sign        包含DSA公钥的证书。</li>
<li>rsa_fixed_dh    包含静态DH公钥的证书。</li>
<li><p>dss_fixed_dh    包含静态DH公钥的证书。</p>

<dl>
<dt>supported_signature_algorithms</dt>
<dd><pre><code> 服务器支持的  hash/signature 算法的列表。
</code></pre></dd>
<dt> certificate_authorities</dt>
<dd><pre><code> 服务器可以接受的CA(certificate_authorities)的 distinguished names 的列表 DER编码格式.
</code></pre></dd>
</dl></li>
</ul>


<p>这些 distinguished names 可能为root CA或者次级CA指定了想要的 distinguished name ，因此，这个消息可以用来描述已知的root，或者希望的授权空间。
如果 certificate_authorities 列表是空的，那么客户端可以发送任何适当的 ClientCertificateType 类型的证书，如果没有别的限制的话。</p>

<p>   certificate_types 和 supported_signature_algorithms 字段的交叉选择很复杂。 certificate_types 这个字段从SSLv3时代就定义了，但是一直都没有详细定义，其大多数功能都被 supported_signature_algorithms 代替了。
   有如下规则：</p>

<ul>
<li><p>  客户端提供的任何证书，必须用一个supported_signature_algorithms 中出现过的  hash/signature 算法对 签名.</p></li>
<li><p>  客户端提供的末端证书必须提供一个和 certificate_types 兼容的key。 如果这个key是一个签名key，那必须能和 supported_signature_algorithms 中提供的某个 hash/signature 算法对配合使用。</p></li>
<li><p>  由于历史原因，某些客户端证书类型的名字，包含了证书的签名算法，例如，早期版本的TLS中， rsa_fixed_dh 意思是一个被RSA算法签署，并且包含一个固定DH密钥的证书。在TLS1.2中，这个功能被 supported_signature_algorithms 淘汰，并且证书类型不再限制用来签署证书的算法。例如，如果服务器发送了 dss_fixed_dh 证书类型，和 { {sha1, dsa}, {sha1,rsa} } 签名类型，客户端可以回复一个 包含静态DH密钥，用RSA-sha1签署的证书。</p></li>
<li><p> 如果协商出来的是匿名CipherSuite，服务器不能要求客户端认证。</p></li>
</ul>


<a name="L8..handshake..--.Server.Hello.Done"></a>
<h3>8. handshake  &ndash; Server Hello Done</h3>

<p>在 ServerHello和相关消息已经处理结束后，服务器发送ServerHelloDone。在发送ServerHelloDone后，服务器开始等待客户端的响应。</p>

<p>ServerHelloDone消息表示，服务器已经发送完了密钥协商需要的消息，并且客户端可以开始客户端的密钥协商处理了。</p>

<p>收到ServerHelloDone后，客户端应该确认服务器提供了合法的证书，并且确认服务器的ServerHello消息里面的参数是可以接受的。</p>

<p>消息格式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span> <span class="p">}</span> <span class="n">ServerHelloDone</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<a name="L9..handshake..--.Client.Certificate"></a>
<h3>9. handshake  &ndash; Client Certificate</h3>

<p>ClientCertificate消息是客户端收到ServerHelloDone后，可以发送的第一条消息。仅当服务器要求了一个证书的情况下，客户端才发送ClientCertificate消息，如果没有可用的合适证书，客户端必须发送一条不包含任何证书的ClientCertificate消息（即 certificate_list 结构长度为0）。</p>

<p>如果客户端没有发送任何证书，服务器自行决定，可以放弃要求客户端认证，继续握手；或者发送一条 fatal handshake_failure的alert消息，断开连接。并且，如果证书链的某些方面是不能接受的（比如证书没有被可信任的CA签署），服务器可以自行决定，是继续握手（放弃要求客户端认证），或者发送一条fatal的alert。</p>

<p>客户端证书使用和ServerCertificate相同的结构发送。</p>

<p>ClientCertificate把客户端的证书链发送给服务器。服务器会使用证书链来验证CertificateVerify 消息（如果使用基于签名的客户端认证），或者来计算premaster secret（对于非短暂的 DH）。证书必须和协商出来的CipherSuite的密钥交换算法配套，并和任何协商的扩展配套。</p>

<p>尤其是：</p>

<ul>
<li> 证书必须是X.509v3 类型的。</li>
<li> 客户端的末级证书的公钥必须和CertificateRequest里列出的证书类型兼容。</li>
</ul>


<table>
<thead>
<tr>
<th>      客户端证书类型  </th>
<th>  证书公钥类型 </th>
</tr>
</thead>
<tbody>
<tr>
<td>  rsa_sign </td>
<td> RSA公钥；证书必须允许公钥用于certificateVerify消息中的数字签名和hash算法 </td>
</tr>
<tr>
<td>  dss_sign </td>
<td> DSA 公钥；证书必须允许密钥使用CertificateVerify中的hahs函数做签名；</td>
</tr>
<tr>
<td>      ecdsa_sign         </td>
<td> 可以用作 ECDSA 的公钥；证书必须允许 公钥用 CertificateVerify中的hash函数做签名；公钥必须使用服务器支持的曲线，和点格式；</td>
</tr>
<tr>
<td>      rsa_fixed_dh / dss_fixed_dh   </td>
<td>   Diffie-Hellman 公钥; 必须使用和服务器key相同的参数。</td>
</tr>
<tr>
<td>      rsa_fixed_ecdh   /  ecdsa_fixed_ecdh </td>
<td>   可以用作 ECDH 的公钥。必须和服务器的公钥使用同样的曲线，同样的点格式</td>
</tr>
</tbody>
</table>


<ul>
<li>  如果 certificate_authorities 列表不是空的，客户端证书链中的某一个证书必须是CA中的某一个签署的。</li>
<li>  证书必须使用 服务器可以接受的 hash/signature 算法对。</li>
</ul>


<p>类似于Server Certificate，有一些证书目前无法在TLS中使用。</p>

<a name="L10..handshake.--.Client.Key.Exchange"></a>
<h3>10. handshake &ndash; Client Key Exchange</h3>

<p>客户端必须在客户端的Certificate消息之后，立即发送ClientKeyExchange消息。
或者必须在ServerHelloDone后立即发送ClientKeyExchange消息。</p>

<p>ClientKeyExchange消息中，会设置premaster secret，通过发送 RSA公钥加密premaster secret的密文，或者发送允许双方得出相同的premaster secret的Diffie-Hellman参数。</p>

<p>当客户端使用短暂的 Diffie-Hellman 密钥对时，ClientKeyExchange包含客户端的 Diffie-Hellman 公钥。如果客户端发送一个包含静态 Diffie-Hellman 指数的证书（比如，在使用固定DH的客户端认证），那么这条消息必须被发送，并且必须为空。</p>

<p>消息结构：
消息的选择取决于选择的密钥交换算法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">select</span> <span class="p">(</span><span class="n">KeyExchangeAlgorithm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">rsa</span><span class="p">:</span>
</span><span class='line'>              <span class="n">EncryptedPreMasterSecret</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dhe_dss</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dhe_rsa</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dh_dss</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dh_rsa</span><span class="p">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">dh_anon</span><span class="p">:</span>
</span><span class='line'>              <span class="n">ClientDiffieHellmanPublic</span><span class="p">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">ec_diffie_hellman</span><span class="p">:</span>
</span><span class='line'>              <span class="n">ClientECDiffieHellmanPublic</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">exchange_keys</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ClientKeyExchange</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L.1....RSA...........Premaster.Secret......."></a>
<h4>(1).  RSA 加密的 Premaster Secret 消息</h4>

<p>如果用RSA做密钥协商和认证，客户端生成 48字节的 premaster secret，使用服务器证书里面的公钥加密，然后把密文EncryptedPreMasterSecret发送给服务器，结构定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">ProtocolVersion</span> <span class="n">client_version</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">random</span><span class="p">[</span><span class="mi">46</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">PreMasterSecret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client_version</span>
</span><span class='line'>     <span class="err">客户端支持的最新协议版本号，这个字段用来检测中间人版本回退攻击。</span><span class="n">T</span>
</span><span class='line'>  <span class="n">random</span>
</span><span class='line'>     <span class="mi">46</span> <span class="err">字节的，安全生成的随机值。</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">public</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">encrypted</span> <span class="n">PreMasterSecret</span> <span class="n">pre_master_secret</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">EncryptedPreMasterSecret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pre_master_secret</span>
</span><span class='line'>     <span class="err">这个随机值由客户端生成，用于生成</span><span class="n">master</span> <span class="n">secret</span><span class="err">。</span>
</span></code></pre></td></tr></table></div></figure>


<p>注：PreMasterSecret里面的 client_version 是 ClientHello.client_version，而不是协商的到的版本号，这个特性用来阻止版本回退攻击。不幸的是，有些不正确的老的代码使用了协商得到的版本号，导致检查client_version字段的时候，和正确的实现无法互通。</p>

<p>客户端实现必须在PreMasterSecret中发送正确的版本号。如果 ClientHello.client_version 的版本号是 TLS 1.1 或者更高，服务器实现必须如下检查版本号。如果版本号是 TLS 1.0 或者更早，服务器必须检查版本号，但是可以通过配置项关闭检查。</p>

<p>要注意的是，如果版本号检查失败了，PreMasterSecret 应该像下面描述的那样填充成随机数。</p>

<p>TLS中的RSA使用的是 PKCS1-V1.5 填充( PKCS1-V1.5也是openssl库RSA的默认填充方式)。Bleichenbacher 在1998年发表了一种针对 PKCS1-V1.5 的选择密文攻击， Klima在2003年发现  PKCS1-V1.5 中 PreMasterSecret 版本号检查的一个侧通道攻击。只要TLS 服务器暴露一条特定的消息是否符合PKCS1-V1.5格式，或暴露PreMasterSecret解密后结构是否合法，或版本号是否合法，就可以用上面2种方法攻击。</p>

<p>Klima 还提出了完全避免这类攻击的方法：对格式不正确的消息，版本号不符的情况，要做出和完全正确的RSA块一样的响应，要让客户端区分不出这3种情况。
具体地说，要如下：</p>

<ol>
<li>生成 46 字节的密码学安全随机值 R</li>
<li>解密消息，获得明文 M</li>
<li>如果 PKCS#1 填充不正确，或者 PreMasterSecret 消息的长度不是48字节，则
pre_master_secret = ClientHello.client_version || R
或者如果 ClientHello.client_version &lt;= TLS 1.0，并且明确禁止了版本号检查，则
pre_master_secret = ClientHello.client_version || M[2..47]</li>
</ol>


<p>注意：明确地用 ClientHello.client_version 构造 pre_master_secret 时，当客户端在原来的 pre_master_secret 中发送了错误的 客户端版本值时，会产生一个不合法的 master_secret 。</p>

<p> 另一种解决问题的方法是，把版本号不符，当成 PKCS-1 格式错误来对待，并且完全随机填充 premaster secret。</p>

<ol>
<li>生成 48 字节的密码学安全随机值 R</li>
<li>解密 PreMasterSecret 恢复出明文 M</li>
<li>如果 PKCS#1 填充不正确，或者消息的长度不是48字节，则
  pre_master_secret = R
或者如果 ClientHello.client_version &lt;= TLS 1.0，并且 明确禁止了版本号检查，则
  pre_master_secret = M
或者如果 M[0..1] != CleintHello.client_version
  pre_master_secret = R
或者
  pre_master_secret = M</li>
</ol>


<p>尽管实践中，还没有发现针对这种结构的攻击，Klima 在论文中描述了几种理论上的攻击方式，因此推荐上述的第一种结构。</p>

<p>在任何情况下，一个 TLS 服务器绝对不能在:1. 处理 RSA 加密的 premaster 消息失败, 2.或者版本号检查失败 时产生alert消息。当遇到这两种情况时，服务器必须用随机生成的 premaster 值继续握手。服务器可以把造成失败的真实原因log下来，用于调查问题，但是必须小心确保不能把这种信息泄漏给攻击者（比如通过时间侧通道，log文件，或者其它通道等泄漏）。</p>

<p>RSAES-OAEP 加密体制，更能抵抗 Bleichenbacher 发表的攻击，然而，为了和早期的TLS版本最大程度保持兼容，TLS 仍然规定使用  RSAES-PKCS1-v1_5 体制。只要遵守了上面列出的建议，目前还没有 Bleichenbacher 的变化形式能攻破 TLS 。</p>

<p>实现的时候要注意：公钥加密的数据用 字节数组 &lt;0..2<sup>16</sup>-1> 的形式表示。因此，ClientKeyExchange中的 RSA加密的PreMasterSecret 前面有2个字节用来表示长度。这2个字节在使用RSA做密钥协商时，是冗余的，因为此时 EncryptedPreMasterSecret 是 ClientKeyExchange 中的唯一字段，因此可以无歧义地得出 EncryptedPreMasterSecret 的长度。因此更早的 SSLv3 规范没有明确规定 public-key-encrypted 数据的编码格式，因此有一些SSLv3的实现没有包含 长度字段，这些实现直接把 RSA 加密的数据放入了 ClientKeyExchange消息里面。
TLS规范要求 EncryptedPreMasterSecret 字段包含长度字段。因此得出的结果会和一些 SSLv3 的实现不兼容。实现者从 SSLv3 升级到 TLS 时，必须修改自己的实现，以接受并且生成带长度的格式。如果一个实现要同时兼容 SSLv3 和 TLS，那就应该根据协议版本确定自己的行为。</p>

<p>注意：根据 Boneh 等在2003年USENIX Security Symposium上发表的论文 &ldquo;Remote timing attacks are practical"，针对 TLS RSA密钥交换的远程时间侧通道攻击，是<strong>实际可行的</strong>，起码当客户端和服务器在同一个LAN里时是可行的。因此，使用静态 RSA 密钥的实现，必须使用 RSA blinding，或者Boneh论文中提到的，其他抵抗时间侧通道攻击的技术。</p>

<p>openssl中的RSA blinding，参见：<a href="http://linux.die.net/man/3/rsa_blinding_on">http://linux.die.net/man/3/rsa_blinding_on</a></p>

<a name="L.2..............Diffie-Hellman......."></a>
<h4>(2).  客户端 Diffie-Hellman 公钥</h4>

<p>这条消息把客户端的 Diffie-Hellman 公钥 ( Yc ) 发送给服务器。</p>

<p>Yc的编码方式由 PublicValueEncoding 决定。</p>

<p>消息的结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">enum</span> <span class="p">{</span> <span class="n">implicit</span><span class="p">,</span> <span class="n">explicit</span> <span class="p">}</span> <span class="n">PublicValueEncoding</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">implicit</span>
</span><span class='line'>     <span class="err">如果客户端已经发送了一个包含合适的</span> <span class="n">DH</span> <span class="err">公钥的证书（即</span> <span class="n">fixed_dh</span> <span class="err">客户端认证方式），那么</span><span class="n">Yc</span><span class="err">已经隐式包含了，不需要再发送。这种情况下，</span><span class="n">ClientKeyExchange</span><span class="err">消息必须发送，并且必须是空的。</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">explicit</span>
</span><span class='line'>     <span class="err">表示</span><span class="n">Yc</span><span class="err">需要发送。</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">select</span> <span class="p">(</span><span class="n">PublicValueEncoding</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">implicit</span><span class="p">:</span> <span class="k">struct</span> <span class="p">{</span> <span class="p">};</span>
</span><span class='line'>          <span class="k">case</span> <span class="nl">explicit</span><span class="p">:</span> <span class="n">opaque</span> <span class="n">dh_Yc</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">dh_public</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ClientDiffieHellmanPublic</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dh_Yc</span>
</span><span class='line'>     <span class="err">客户端的</span> <span class="n">Diffie</span><span class="o">-</span><span class="n">Hellman</span> <span class="err">公钥</span> <span class="n">Yc</span><span class="p">.</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<a name="L.3..............EC.Diffie-Hellman......."></a>
<h4>(3).  客户端 EC Diffie-Hellman 公钥</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">select</span> <span class="p">(</span><span class="n">PublicValueEncoding</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="nl">implicit</span><span class="p">:</span> <span class="k">struct</span> <span class="p">{</span> <span class="p">};</span>
</span><span class='line'>            <span class="k">case</span> <span class="nl">explicit</span><span class="p">:</span> <span class="n">ECPoint</span> <span class="n">ecdh_Yc</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="n">ecdh_public</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="n">ClientECDiffieHellmanPublic</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Diffie-Hellman 推广到椭圆曲线群上，就是 EC Diffie-Hellman ，简称 ECDH，其它的计算，和一般的 DH 计算类似。</p>

<p><strong>ECDH 是目前最重要的密钥协商算法</strong> <a href="http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html">http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html</a></p>

<a name="L11..handshake..--.Cerificate.Verify"></a>
<h3>11. handshake  &ndash; Cerificate Verify</h3>

<p>当需要做客户端认证时，客户端发送CertificateVerify消息，来证明自己确实拥有客户端证书的私钥。这条消息仅仅在客户端证书有签名能力的情况下发送（就是说，除了含有固定 Diffie-Hellman 参数的证书以外的证书）。CertificateVerify必须紧跟在ClientKeyExchange之后发送。</p>

<p>消息结构：
   Structure of this message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">digitally</span><span class="o">-</span><span class="kt">signed</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>           <span class="n">opaque</span> <span class="n">handshake_messages</span><span class="p">[</span><span class="n">handshake_messages_length</span><span class="p">];</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">CertificateVerify</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>此处， handshake_messages 表示所有发送或者接收的握手消息，从client hello开始，一直到CertificateVerify之前的所有消息，包括handshake消息的type和length字段，这是之前所有握手结构体的拼接。要注意，这要求双方在握手过程中，都得缓存所有消息，或者在握手过程中，用每一种可能的hash算法计算到CeritificateVerify为止的hash值。</p>

<p>signature中用的hash和签名算法必须是 CertificateRequest 的 supported_signature_algorithms 中的某一种。另外，hash和签名算法必须和客户端的证书的算法兼容。
RSA公钥可能被用于任何允许的hash函数，只要遵循证书中的限制。</p>

<a name="L12..handshake..--.Finished"></a>
<h3>12. handshake  &ndash; Finished</h3>

<p>在 ChangeCipherSpec 消息之后，应该立即发送 Finished 消息，来确认密钥交换和认证过程已经成功了。ChangeCipherSpec 必须在其它握手消息和 Finished 消息之间。</p>

<p>Finished 消息是第一条用刚刚协商出来的参数保护的消息。接收方必须确认Finished消息的内容是正确的。一旦某一方发送了，并且确认了对端发来的Finished消息，就可以开始在连接上发送和接收应用数据了。</p>

<p>消息结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">verify_data</span><span class="p">[</span><span class="n">verify_data_length</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">Finished</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">verify_data</span>
</span><span class='line'>     <span class="n">PRF</span><span class="p">(</span><span class="n">master_secret</span><span class="p">,</span> <span class="n">finished_label</span><span class="p">,</span><span class="n">Hash</span><span class="p">(</span><span class="n">handshake_messages</span><span class="p">))</span>
</span><span class='line'>        <span class="p">[</span><span class="mf">0.</span><span class="p">.</span><span class="n">verify_data_length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">finished_label</span>
</span><span class='line'>     <span class="err">对客户端发的</span><span class="n">Finished</span><span class="err">消息来说，固定是字符串</span> <span class="s">&quot;client finished&quot;</span><span class="p">.</span>
</span><span class='line'>     <span class="err">对服务器发的</span><span class="n">Finished</span><span class="err">消息来说，固定是字符串</span> <span class="s">&quot;server finished&quot;</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hash表示握手消息的hash。hash函数是前文 PRF 的hash 函数。或者 CipherSuite 规定的用于 Finished 计算的hash函数。</p>

<p>在TLS的之前版本中，verify_data 总是 12 字节。在TLS 1.2中，这取决于CipherSuite。如果CipherSuite没有显式规定 verify_data_length ，就当成12字节处理。将来的CipherSuite可能会规定别的长度，但是不能小于12字节。</p>

<p> Finished 消息必须跟在 ChangeCipherSpec 消息之后，如果顺序错乱，就是 fatal error.</p>

<p>handshake_message 的内容包含从 ClientHello开始，直到 本条Finished之前的所有消息，只包含handshake层的消息体，不包含record层的几个消息头字段。包括CertificateVerify 消息。同时，对客户端和服务器来说，handshake_message 的内容不同， 后发送者必须包含前发送者的 Finished 消息。</p>

<p> 注意：ChangeCipherSpec 消息，alert，和其它的record 类型不是握手消息，不包含在 hash计算中。同时，HelloRequest 消息也不算在内。</p>

<a name="L13..handshake.--.NewSessionTicket"></a>
<h3>13. handshake &ndash; NewSessionTicket</h3>

<p>SessionTicket 定义在 RFC5077 标准里面，2008年发布。</p>

<p>SessionTicket是一种不需要服务器端状态的，恢复TLS session的方式。
SessionTicket可以用于任何CipherSuite。 TLS 1.0, TLS 1.1, TLS 1.2 都适用。</p>

<p>在下面这些场景下，尤其有用：</p>

<p>用户量巨大，session id的方式耗费服务器内存过多
服务器希望长时间缓存session
服务器有多台，不希望服务器间有共享状态
服务器内存不足
客户端在 ClientHello中设置一个 SessionTicket 扩展来标识自己支持 SessionTicket。如果客户端本地没有存之前收到的ticket，就把这个扩展设为空。</p>

<p>如果服务器希望使用 SessionTicket 机制，服务器把本地的 session 状态存入一个ticket中，ticket会被加密，并被MAC保护，无法篡改，加密和算MAC用的key只有服务器知道。
加密并MAC过的ticket用 NewSessionTicket 消息分发给客户端，NewSessionTicket 消息应该在 ChangeCipherSpec 消息之前，在服务器验证通过客户端的Finished消息之后发送。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>      <span class="n">Client</span>                                               <span class="n">Server</span>
</span><span class='line'>      <span class="n">ClientHello</span>
</span><span class='line'>      <span class="p">(</span><span class="n">empty</span> <span class="n">SessionTicket</span> <span class="n">extension</span><span class="p">)</span><span class="o">-------&gt;</span>
</span><span class='line'>                                                      <span class="n">ServerHello</span>
</span><span class='line'>                                  <span class="p">(</span><span class="n">empty</span> <span class="n">SessionTicket</span> <span class="n">extension</span><span class="p">)</span>
</span><span class='line'>                                                     <span class="n">Certificate</span><span class="o">*</span>
</span><span class='line'>                                               <span class="n">ServerKeyExchange</span><span class="o">*</span>
</span><span class='line'>                                              <span class="n">CertificateRequest</span><span class="o">*</span>
</span><span class='line'>                                   <span class="o">&lt;--------</span>      <span class="n">ServerHelloDone</span>
</span><span class='line'>      <span class="n">Certificate</span><span class="o">*</span>
</span><span class='line'>      <span class="n">ClientKeyExchange</span>
</span><span class='line'>      <span class="n">CertificateVerify</span><span class="o">*</span>
</span><span class='line'>      <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>      <span class="n">Finished</span>                     <span class="o">--------&gt;</span>
</span><span class='line'>                                                 <span class="n">NewSessionTicket</span>
</span><span class='line'>                                               <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>                                   <span class="o">&lt;--------</span>             <span class="n">Finished</span>
</span><span class='line'>      <span class="n">Application</span> <span class="n">Data</span>             <span class="o">&lt;-------&gt;</span>     <span class="n">Application</span> <span class="n">Data</span>
</span><span class='line'>   <span class="n">Figure</span> <span class="mi">1</span><span class="o">:</span> <span class="n">Message</span> <span class="n">flow</span> <span class="k">for</span> <span class="n">full</span> <span class="n">handshake</span> <span class="n">issuing</span> <span class="n">new</span> <span class="n">session</span> <span class="n">ticket</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>客户端把收到的ticket和master secret等其它与当前session有关的参数一起，缓存起来。
单客户端希望恢复会话时，就把ticket包含在 ClientHello 的 SessionTicket 扩展中发给服务器。
服务器收到后，解密ticket，算MAC确认ticket没有被篡改过，然后从解密的内容里面，获取session 状态，用来恢复会话。如果服务器成功地验证了ticket，可以在 ServerHello 之后返回一个 NewSessionTicket 消息来更新ticket。</p>

<p>显然，这种情况下，相比完整握手，可以省掉1个RTT。如下图：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>      <span class="n">Client</span>                                                <span class="n">Server</span>
</span><span class='line'>      <span class="n">ClientHello</span>
</span><span class='line'>      <span class="p">(</span><span class="n">SessionTicket</span> <span class="n">extension</span><span class="p">)</span>      <span class="o">--------&gt;</span>
</span><span class='line'>                                                       <span class="n">ServerHello</span>
</span><span class='line'>                                   <span class="p">(</span><span class="n">empty</span> <span class="n">SessionTicket</span> <span class="n">extension</span><span class="p">)</span>
</span><span class='line'>                                                  <span class="n">NewSessionTicket</span>
</span><span class='line'>                                                <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>                                    <span class="o">&lt;--------</span>             <span class="n">Finished</span>
</span><span class='line'>      <span class="p">[</span><span class="n">ChangeCipherSpec</span><span class="p">]</span>
</span><span class='line'>      <span class="n">Finished</span>                      <span class="o">--------&gt;</span>
</span><span class='line'>      <span class="n">Application</span> <span class="n">Data</span>              <span class="o">&lt;-------&gt;</span>     <span class="n">Application</span> <span class="n">Data</span>
</span><span class='line'>        <span class="n">Figure</span> <span class="mi">2</span><span class="o">:</span> <span class="n">Message</span> <span class="n">flow</span> <span class="k">for</span> <span class="n">abbreviated</span> <span class="n">handshake</span> <span class="n">using</span> <span class="n">new</span>
</span><span class='line'>                              <span class="n">session</span> <span class="n">ticket</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果服务器不能，或者不想使用客户端发来的ticket，那服务器可以忽略ticket，启动一个完整的握手流程。</p>

<p>如果服务器此时不希望下发新的ticket，那就可以不回复 SessionTicket 扩展，或者不回复 NewSessionTicket 消息。
此时除了 ClientHello里面的 SessionTicket扩展，就和一般的TLS流程一样了。</p>

<p>如果服务器拒绝收到的ticket，服务器可能仍然希望在完整的握手之后，下发新的ticket。
此时流程和全新 ticket 生成下发的区别，就是ClientHello的SessionTicket不是空的。</p>

<p>NewSessionTicket 消息
服务器在握手过程中，发ChangeCipherSpec之前发送NewSessionTicket消息。
如果服务器在ServerHello中包含了一个SessionTicket扩展，那就必须发送NewSessionTicket消息。
如果服务器没有包含SessionTicket扩展，那绝对不能发送NewSessionTicket消息。
如果服务器在包含了SessionTicket扩展之后，不想发送ticket，那可以发送一个长度为0的NewSessionTicket消息。</p>

<p>在完整握手的情况下，客户端必须在确认服务器的Finished消息正确之后，才能认为NewSessionTicket 里面的ticket合法。</p>

<p>服务器可以NewSessionTicket消息中更新 ticket。</p>

<p>ticket_lifetime_hint 字段包含一个服务器的提示，提示客户端本ticket应该存多长时间就失效。单位是秒，网络字节序。当时间到期时，客户端应该删掉ticket和关联的状态。客户端也可以提前删除。服务器端也可以提前认为ticket失效。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">uint32</span> <span class="n">ticket_lifetime_hint</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">ticket</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">NewSessionTicket</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>SessionTicket 和 Session ID 之间的关系比较繁琐。感兴趣的自行去看RFC吧。</p>

<p>对于客户端来说，ticket就是一块二进制buffer，客户端并不管里面的内容。所以ticket具体怎么加密加MAC服务器可以为所欲为，无需顾及客户端的感受。</p>

<p>RFC5077中推荐了一种ticket的加密保护方法：
服务器使用2个key，一个 aes-128-cbc的key，一个 HMAC-SHA-256 的key。</p>

<p>ticket的格式像这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">key_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">iv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">encrypted_state</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">mac</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ticket</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中，key_name 用来标识一组key，这样服务器端就可以使用多组key。</p>

<p>加密过程，首先随机生成IV，然后用 aes-128-cbc 加密 session 的序列化结果，
然后用 HMAC-SHA-256 对 key_name,IV,encrypted_data 的长度（2字节），encrypted_data 计算MAC。
最好把各个字段填入上面ticket结构体。
显然，此处是 Encrypt-then-MAC的方式，是最安全的。</p>

<p>实际在openssl 中的session，用asn1格式序列化保存了下面这些字段：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="k">typedef</span> <span class="k">struct</span> <span class="n">ssl_session_asn1_st</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">ASN1_INTEGER</span> <span class="n">version</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_INTEGER</span> <span class="n">ssl_version</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_OCTET_STRING</span> <span class="n">cipher</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_OCTET_STRING</span> <span class="n">master_key</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_OCTET_STRING</span> <span class="n">session_id</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_OCTET_STRING</span> <span class="n">session_id_context</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_INTEGER</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_INTEGER</span> <span class="n">timeout</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_INTEGER</span> <span class="n">verify_result</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_OCTET_STRING</span> <span class="n">tlsext_hostname</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_INTEGER</span> <span class="n">tlsext_tick_lifetime</span><span class="p">;</span>
</span><span class='line'>     <span class="n">ASN1_OCTET_STRING</span> <span class="n">tlsext_tick</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span> <span class="n">SSL_SESSION_ASN1</span><span class="p">;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<a name="L6..ChangeCipherSpec......."></a>
<h2>6. ChangeCipherSpec 协议</h2>

<p>ChangeCipherSpec用来通知对端，开始启用协商好的Connection State做对称加密，内容只有1个字节。
这个协议是冗余的，在TLS 1.3里面直接被删除了。</p>

<p>  changeCipherSpec协议抓包：
  <img src="https://blog.helong.info//images/blog/tls/changeCipherSpec.png" alt="" /></p>

<a name="L7..Alert......."></a>
<h2>7. Alert 协议</h2>

<p>一种返回码机制，简单</p>

<pre><code>  enum { warning(1), fatal(2), (255) } AlertLevel;

  struct {
      AlertLevel level;
      AlertDescription description;
  } Alert;
</code></pre>

<p>其中level是等级，不同等级要求不同的处理。</p>

<p>其中有一种：close_notify，用来通知对端，我不会再发送更多数据了。这个可以让对端主动close fd，这样可以减少我方tcp timewait状态的socket 量。</p>

<p>  alert协议：
  <img src="https://blog.helong.info//images/blog/tls/alert_protocol.png" alt="" /></p>

<a name="L8..application.data......"></a>
<h2>8. application data协议</h2>

<p>application data协议，就是把应用数据直接输入record层，做分段，算MAC，加密，传输。
   抓包举例如下：</p>

<p>  <img src="https://blog.helong.info//images/blog/tls/application_data_protocol.png" alt="" /></p>

<a name="L8..TLS....................."></a>
<h2>8. TLS协议的安全分析</h2>

<p>安全分析，重中之重，也是大家最关心的。</p>

<p>安全分析的第一步是建立攻击模型，TLS的攻击模式是：
*  攻击者有充足的计算资源
*  攻击者无法得到私钥，无法得到客户端和服务器内存里面的密钥等保密信息
*  攻击者可以抓包，修改包，删除包，重放包，篡改包。</p>

<p>这个模型其实就是密码学里面一般假定的攻击模型。</p>

<p>好了，在这个模型下，TLS的安全性分析如下：</p>

<a name="L1...................................."></a>
<h3>1. 认证和密钥交换 的安全性</h3>

<p>TLS有三种认证模式：双方认证，服务器认证，无认证。
只要包含了有服务器端认证，就可以免疫 man-in-the-middle 攻击。但是完全匿名的会话是可以被 MITM 攻击的。匿名的服务器不能认证客户端。</p>

<p>密钥交换的目的，是产生一个只有通信双方知道的共享密钥 pre_master_secret 。pre_master_secret 用来生成 master_secret 。 master_secret 用来生成 Finished 消息，加密key，和MAC key。通过发送正确的Finished消息，双方可以证明自己知道正确的 pre_master_key。</p>

<a name="L1...................."></a>
<h4>1. 匿名密钥交换</h4>

<p>匿名密钥交换是一种历史遗留的不安全方式。 匿名密钥交换缺失认证(Authentication)，所以绝大多数场景下，我们应该禁用这种方式。</p>

<a name="L2..RSA......................"></a>
<h4>2. RSA 密钥交换和认证</h4>

<p>当使用RSA的时候，合并了密钥交换 和 服务器端认证。
RSA公钥包含在服务器证书中。要注意的是，一旦服务器证书的RSA私钥泄露，之前用该证书保护的所有流量都会变成可以破解的，即没有前向安全性(Perfect Forward Secrecy)。
需要前向安全性的TLS用户，应该使用 DHE 或者 EC
   TLS users desiring Perfect Forward Secrecy should use DHE 类的CcipherSuite。这样，如果私钥泄露，只需要更换私钥和证书就行，不会有更大的损失。</p>

<p>RSA密钥交换和认证的安全性基于，在验证了服务器的证书之后，客户端用服务器的公钥加密一个 pre_master_secret 。成功地解密 pre_master_secret 并产生正确地 Finished 消息之后，就可以确信服务器拥有证书对应的私钥。</p>

<p>如果使用了客户端认证，通过 CertificateVerify 消息来认证客户端。客户端会签署一个之前所有握手消息的hash值，这些握手消息包括 服务器的证书，ServerHello.random 。其中服务器证书确保客户端签署了和本服务器有关的绑定(即不能重放和别的服务器的握手)，ServerHello.random 确保签名和当前握手流程绑定(即不能重放)。</p>

<a name="L3..Diffie-Hellman......................"></a>
<h4>3. Diffie-Hellman 密钥交换和认证</h4>

<p>当使用 DH 密钥交换的时候，服务器:</p>

<ol>
<li>或者发送包含固定 DH参数的证书</li>
<li>或者发送一组临时DH参数，并用 ECDSA/RSA/DSA 证书的私钥签署。而且在签署之前，临时DH参数和 hello.random 都参与hash计算，来确保攻击者不能重放老的签名值。</li>
</ol>


<p>无论如何，客户端都可以通过验证证书，或者验证签名，来确保收到的DH参数确实来自真正的服务器。</p>

<p>如果客户端有一个包含固定 Diffie-Hellman 参数的证书，则证书包含完成密钥交换所需的参数。要注意的是，这种情况下，客户端和服务器每次都会协商出相同的 DH 结果(就是 pre_master_secret)。
为了尽可能减少 pre_master_secret 存在在内存里面的时间，当不再需要的时候，尽快将其清除，pre_master_secret 应该尽早转换成 master_secret 的形式。
为了进行密钥交换，客户端发送的 Diffie-Hellman 参数必须和服务器发送的兼容。</p>

<p>如果客户端有一个标准的 DSA 或者 RSA 证书，或者 客户端没有被认证，那么客户端在ClientKeyExchange中发送一组临时参数，或者可选地发送一个CertificateVerify消息来证明自己的身份。</p>

<p>如果相同的 DH 密钥对，被多次用于握手协商，不管是由于客户端或服务器使用了固定DH密钥的证书，还是服务器在重用 DH 密钥，都必须小心避免 small subgroup 攻击。实现都必须遵循 rfc2785 中的标准。</p>

<p>最简单避免 small subgroup 攻击的方法是使用一种 DHE CipherSuite，并且每次都握手都生成一个新的 DH 私钥 X。如果选择了一个合适的base（例如2），g<sup>X</sup> mod p 的计算可以非常快，因而性能开销会最小化。并且每次都使用一个新的DH密钥，可以提供前向安全性。当使用  DHE 类的CipherSuite时，实现必须每次握手都生成一个全新的DH私钥（即 X ）。</p>

<p>由于TLS允许服务器提供任意的 DH 群，客户端必须确认服务器提供的DH 群的大小适合本地策略。
客户端必须确认 DH 公共指数有足够的大小。
如果DH群已知的话，客户端做简单比对就行了，因此服务器可以使用一个已知的群，来方便客户端的检查。</p>

<a name="L2...................."></a>
<h3>2. 版本回退攻击</h3>

<p>由于 TLS 历史上出现过多个版本，服务器端实现可能会兼容多个版本的协议，而像 SSL 2.0 这样的版本是有严重安全问题的，因此攻击者可能会尝试诱骗客户端和服务器，来使TLS连接回退到 SSL 2.0这种老版本。</p>

<p>TLS 对此的解决办法，就是PreMasterSecret里面包含版本号。</p>

<a name="L3............................."></a>
<h3>3. 针对握手过程的攻击</h3>

<p>攻击者可能会尝试影响握手过程，来使双方选择不安全的加密算法。</p>

<p>对这种攻击的解决办法是，如果握手消息被篡改了，那么在Finished消息里，客户端和服务器都会计算 握手消息的hash，如果攻击者篡改了握手消息，那么双方得出的hash就不一样，这样Finished消息就会验证不过。就会发现攻击。</p>

<a name="L4.........Resuming.Sessions.........."></a>
<h3>4. 针对 Resuming Sessions 的攻击</h3>

<p>当使用 session resuming的时候，会产生新的 ClientHello.random 和 ServerHello.random ，并和session的 master_secret 一同被hash。只要master_secret没有泄漏，并且PRF中用来生成加密key和MAC key的hash算法是安全的，连接就是安全的，并且独立于前一个连接(被恢复的前一个连接)。</p>

<p>只有在客户端和服务器都同意的情况下，才会做session resuming。只要有任意一方怀疑 session 泄漏，或者证书过期/被吊销，就可以要求对端做完整的握手。
一个session的生命周期建议定位24小时。由于如果攻击者获得了 master_secret 就可以在session ID过期之前伪装成被泄漏者，所以要加一个生命期限制。
运行在不安全环境的应用程序，不应该把session ID写入持久存储。</p>

<a name="L5..................................."></a>
<h3>5. 针对应用数据保护的攻击</h3>

<p>master_secret 和 ClientHello.random 及   ServerHello.random 一起做 hash，来生成每个连接唯一的加密key和MAC key（就算是session resuming得到的连接，也是不同的）。</p>

<p>在CBC和stream cipher的情况下，
发送出去的数据，在发送前用MAC保护，来避免消息重放，避免篡改。
MAC根据 MAC key，序列号，消息长度，消息内容，固定字符串算出。
消息类型字段（content type）是必须的，来确保握手消息，ChangeCipherSpec消息，应用数据消息不会被混淆。
序列号用来确保删除包或者打乱包顺序的攻击无法得逞。
由于序列号是64位的，可以认为不会回绕。
从一方发给对端的消息，不能被插入对端发来的字节流中，这是用于两端使用不同的 MAC key。
类似地，server write key 和 client write key相互独立。因此stream cipher的key只使用了一次，避免了类似问题。</p>

<p>如果攻击者获取了加密key，那么就可以解密所有的消息。
类似地，泄漏MAC key，会使攻击者可以篡改消息。</p>

<p>AEAD就简单了。</p>

<a name="L6.........IV............"></a>
<h3>6. 显式 IV的安全性</h3>

<p>如前文所述，TLS 1.0是把前一条消息的最后一个block，当作下一条消息的第一个IV的，这促成了2004年公开的 BEAST 攻击，后来就改成这种显式IV的更安全的方式了。</p>

<a name="L7...........MAC........................"></a>
<h3>7. 加密和MAC组合模式的安全性</h3>

<p>前文介绍CBC和AEAD时已有分析，此处略过。</p>

<a name="L8..DOS......................"></a>
<h3>8. DOS 攻击下的安全性</h3>

<p>TLS容易遭受某些 DoS 攻击。例如，攻击者创建很多TCP连接，就可以让服务器忙于做 RSA 解密计算。然而，由于TLS运行在TCP之上，只要操作系统TCP栈的 SYN-ACK里seqnum是随机的，攻击者就无法隐藏自己的ip，这样就可以和一般的TCP连接一样做DOS防御。</p>

<p>由于TLS运行在TCP上，每个独立的连接都可能遭受一系列DOS攻击。尤其是，攻击者可以伪造RST包，来中断一条TCP+TLS连接。或者伪造部分TLS记录，导致连接阻塞挂起。不过这些攻击都是任何TCP协议都有问题，不是TLS特有的。</p>

<a name="L9.Session.Ticket................"></a>
<h3>9.Session Ticket 的安全分析</h3>

<p>Ticket必须: 1.有MAC （即 authenticated，不可篡改），2.加密（即保密）。</p>

<p>下面分析在各种攻击方法下的安全性。</p>

<a name="L1...........Session"></a>
<h4>1. 无效的Session</h4>

<p>TLS协议要求当发现错误的时候，把TLS session变为无效。</p>

<p>这不会影响到ticket的安全性。</p>

<a name="L2.........Tickets"></a>
<h4>2. 窃取 Tickets</h4>

<p>攻击者或者中间人，可能会窃取到ticket，并且尝试用来和server建立会话。
然而，由于ticket是加密过的，并且攻击者不知道密钥，窃取到的ticket无法使攻击者恢复会话。
TLS服务器必须使用强加密和MAC算法，来保护ticket。</p>

<a name="L3.........Tickets"></a>
<h4>3. 伪造 Tickets</h4>

<p>一个恶意用户可能会伪造，或者篡改一个ticket，来恢复一个会话，来延长ticket的生命周期，或者假装成另一个用户。</p>

<p>然而，由于服务器使用了强的校验保护算法，比如带密码的 HMAC-SHA1 ，因此无法得逞。</p>

<a name="L4..DoS......."></a>
<h4>4. DoS 攻击</h4>

<p>推荐ticket 格式中的 key_name 字段帮助服务器有效地拒绝不是自己签发的票据。
因此，一个攻击者可能发送大量的ticket，让服务器忙于验证ticket。
然而，只要服务器使用了高效的加密和MAC算法，就不会有问题。（现实中，加密和MAC算法效率都极高，这根本不是问题）</p>

<a name="L5.........Ticket....key.........."></a>
<h4>5. 加密 Ticket 的key 的管理</h4>

<p>加密ticket的key的管理，推荐的做法：</p>

<ul>
<li>key 应该用密码学安全的随机数生成器生成，按照RFC4086。</li>
<li>key 和加密算法最少应该是 128 比特安全程度的。</li>
<li>key 除了加密和解密ticket以外，不应该有其他用途。</li>
<li>key 应该定期更换</li>
<li>当ticket格式更换，或者算法更换时，应该更换key</li>
</ul>


<a name="L6..Ticket............."></a>
<h4>6. Ticket 的有效期</h4>

<p>TLS服务器控制ticket的生命周期。服务器根据配置来决定可以接受的ticket生命周期。
ticket的生命周期可能会长于24小时。TLS客户端可能会接受到一个ticket生命周期的提示，当然，客户端本地的策略最终决定ticket保存多久。</p>

<a name="L7............Ticket......................"></a>
<h4>7. 其他的 Ticket 格式和分发方法</h4>

<p>如果没使用推荐的ticket格式，那必须小心地分析方案的安全性。尤其是，如果保密数据比如保密密钥传输给了客户端，那必须用加密方式传输，来防止泄露或篡改。</p>

<a name="L8..Identity.Privacy..Anonymity..and.Unlinkability"></a>
<h4>8. Identity Privacy, Anonymity, and Unlinkability</h4>

<p>ticket的加密和加MAC，就保证了敏感信息不会泄露。</p>

<p>由于在ticket解密之前的TLS握手，无法隐藏客户端的特征，因此中间人可能根据相同的ticket被复用，发现相同的ticket属于相同的用户。TLS对这种情况不提供保证。</p>

<a name="L9..TLS......:"></a>
<h2>9. TLS扩展:</h2>

<p><a href="https://tools.ietf.org/html/rfc6066">https://tools.ietf.org/html/rfc6066</a></p>

<p>几个比较重要的TLS扩展：</p>

<ol>
<li><p>Server Name Indication (SNI)
由于在SNI提出之前，tls握手过程中没有字段标明客户端希望连接服务器端的哪个域名，这样如果一个服务器端口上有多个域名，服务器就无法给出正确的证书。随着ipv4地址空间紧张，这个问题越发突出。因此提出了SNI。</p></li>
<li><p>TLSEXT_ALPN
上层协议协商，就是在握手过程中，标明TLS里面是什么协议，例如 http2就是 h2</p></li>
<li><p>Maximum Fragment Length Negotiation
主要用于嵌入式环境，需要客户端发送。</p></li>
<li><p>Session Ticket
Session Ticket，就是把session cache加密后存入客户端，这样服务器端就不需要任何存储了。</p></li>
<li><p>TLSEXT_SAFE_RENEGOTIATION
重协商</p></li>
<li><p>Certificate Status Request:
OCSP ，OCSP 主要是为了减少客户端查询 证书撤销列表（Ceritificate Revoke List)的网络调用，而提出的。</p></li>
</ol>


<a name="L10..TLS............PKI......"></a>
<h2>10. TLS的配套：PKI体系</h2>

<a name="L1..X.509........"></a>
<h3>1. X.509  证书</h3>

<p>X.509是PKI的一个标准，其中内容包括：</p>

<ul>
<li> 公钥证书</li>
<li> 证书撤销列表，CRL</li>
<li> 证书路径验证算法（CA/证书 链的格式）</li>
</ul>


<p>X.509使用ASN.1语法做序列化/反序列化</p>

<p>ASN1 就是一个数据序列化/反序列化格式，跟 protobuf 差不多，可以算作竞争对手。</p>

<p>DER 就是用 ASN1 序列化某些数据结构的格式。</p>

<p>PEM 就是 DER做base64，加上一些其他字段。</p>

<p>证书链，以一个或多个CA证书开头的证书的列表，其中:</p>

<ul>
<li>每一个证书的 Issuer 和下一个证书的 Subject 相同</li>
<li>每一个证书都被下一个证书的私钥签署</li>
<li>最后一个证书是 根证书(&ldquo;root CA&rdquo;)，在TLS握手中不会被发送</li>
</ul>


<p><img src="https://blog.helong.info//images/blog/tls/handshake_certificate_chain.png" alt="" /></p>

<p>证书里面包含公钥，和其它一些字段（比如证书用途，有效期，签发者等等）
x509.v3证书的字段：
<img src="https://blog.helong.info//images/blog/tls/tls_certificate_x509_example.png" alt="" /></p>

<p>mozilla的ca证书列表
<a href="https://www.mozilla.org/en-US/about/governance/policies/security-group/certs/">https://www.mozilla.org/en-US/about/governance/policies/security-group/certs/</a></p>

<p><a href="https://www.apple.com/certificateauthority/ca_program.html">https://www.apple.com/certificateauthority/ca_program.html</a>
苹果对CA提的要求：</p>

<p>1.CA必须取得完整的 WebTrust for Certification Authorities audit （WebTrust CA审计：<a href="http://www.webtrust.org/%EF%BC%89">http://www.webtrust.org/%EF%BC%89</a>
2.你的root CA证书必须为apple平台的用户提供广泛的商业价值。例如，一个组织内内部使用的证书不能被接受为root证书。
3.你签的证书必须含有可以公开访问的CRL地址。</p>

<p>Webtrust审计介绍：
Webtrust是由世界两大著名注册会计师协会（美国注册会计师协会，AICPA和加拿大注册会计师协会，CICA）制定的安全审计标准，主要对申请对象的系统及业务运作逻辑安全性、保密性等共计七项内容进行近乎严苛的审查和鉴证。只有通过Webtrust国际安全审计认证，才有可能成为全球主流浏览器根信任的证书签发机构。</p>

<p><a href="https://www.geotrust.com/">https://www.geotrust.com/</a>
的网站上右下角，有个图标: <img src="https://www.geotrust.com/assets/images/CA-Webtrust-KPMG.gif" alt="" />
点开就可以看到 KPMG 对 geotrust 公司的 webtrust 审计报告:
<a href="https://cert.webtrust.org/SealFile?seal=1567&amp;file=pdf">https://cert.webtrust.org/SealFile?seal=1567&amp;file=pdf</a></p>

<p> 2011年 荷兰CA公司DigiNotar颁发假google，Facebook，微软证书被发现，后发现被入侵，导致该公司破产。
<a href="http://www.cnbeta.com/articles/154375.htm">http://www.cnbeta.com/articles/154375.htm</a></p>

<p><a href="https://news.ycombinator.com/item?id=530600">https://news.ycombinator.com/item?id=530600</a>
CA公司签署一个证书的成本是0 。
CA公司的主要成本构成：审核 ，验证CSR成本，支持成本，法律成本(保险费用，担保费用)。
要进入各个浏览器的根证书列表，CA公司每年必须过 WebTrust 年度审计，是很大的开销。
一些浏览器厂商还会对植入根证书列表的CA收费。
基础设施开销，CRL 和 OCSP 服务器成本。
验证CSR：就是提交证书申请后，CA要做多项验证，越是高级的证书（比如EV）验证越麻烦。不固定开销，有些要花费很多人力和时间来完成。
法律开销：CA公司得买保险，保险费跑不了。
CA链费用：新开的CA公司要等5-10年，才会被普遍信任，才能广泛进入根证书链。要想加快点，就得给别的大牌CA公司掏钱，买次级证书。</p>

<a name="L2.......PKI........................"></a>
<h3>2.现有PKI体系暴露出的问题</h3>

<p><a href="http://googleonlinesecurity.blogspot.com/2015/03/maintaining-digital-certificate-security.html">http://googleonlinesecurity.blogspot.com/2015/03/maintaining-digital-certificate-security.html</a></p>

<p><a href="https://blog.mozilla.org/security/2015/04/02/distrusting-new-cnnic-certificates/">https://blog.mozilla.org/security/2015/04/02/distrusting-new-cnnic-certificates/</a></p>

<p><a href="https://www.dfn-cert.de/dokumente/workshop/2013/FolienSmith.pdf">https://www.dfn-cert.de/dokumente/workshop/2013/FolienSmith.pdf</a></p>

<p><a href="https://www.cs.utexas.edu/~shmat/shmat_ccs12.pdf">https://www.cs.utexas.edu/~shmat/shmat_ccs12.pdf</a></p>

<p>解决方案：</p>

<a name="L1..public.key.pin"></a>
<h3>1. public key pin</h3>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Public_Key_Pinning">https://developer.mozilla.org/en-US/docs/Web/Security/Public_Key_Pinning</a></p>

<a name="L2..HSTS"></a>
<h3>2. HSTS</h3>

<p><a href="http://www.chromium.org/hsts">http://www.chromium.org/hsts</a>
收录进chrome的默认HSTS列表：   <a href="https://hstspreload.appspot.com/">https://hstspreload.appspot.com/</a></p>

<a name="L11..TLS........................................................."></a>
<h2>11. TLS协议历史上出现过的漏洞，密码学常见陷阱</h2>

<a name="L1..TLS........."></a>
<h3>1. TLS的漏洞</h3>

<p>漏洞分析很耗时间，这里总结一些资料，有兴趣的自己看吧。</p>

<p>虽然TLS的设计已经尽可能的严密，但是随着技术进步的滚滚车轮，历史上还是出现过很多漏洞，
可以参看这个rfc，做了总结：</p>

<p><a href="https://tools.ietf.org/html/rfc7457">Summarizing Known Attacks on Transport Layer Security (TLS) and Datagram TLS (DTLS)</a></p>

<p>还有这个文档：
<a href="https://hynek.me/talks/tls/">The Sorry State Of SSL</a></p>

<p><a href="http://hyperelliptic.org/internetcrypto/OpenSSLPresentation.pdf">http://hyperelliptic.org/internetcrypto/OpenSSLPresentation.pdf</a></p>

<p>TLS 协议最近一些年被爆出过的设计缺陷，尤其是在用的最多的 AES-CBC 和 RC4 上。</p>

<p>AES-CBC 发现了:
1.  padding oracle 攻击
2.  BEAST 攻击
3.  Lucky 13 攻击
4.  TIME 攻击
5.  POODLE攻击</p>

<p>2013 年, AlFardan发表了对 RC4 的一个攻击分析，展示如何恢复 RC4 传输的连接上的数据。这种恢复攻击利用了RC4的一些已知弱点，例如RC4最初的一些字节的显著统计特征。</p>

<p>最近几年，TLS的代码实现引起了安全研究者的关注，这导致了新漏洞不断发现。
2014年，OpenSSL库爆出了好几个漏洞，例如 HeartBleed，还有 CVE-2014-6321 ( Microsoft SChannel 的实现漏洞)等.</p>

<p>TLS的问题:</p>

<p>• 很多问题是由于TLS使用了一些“史前时代”的密码学算法(- Eric Rescorla)
• CBC 和 Mac-Pad-then-Encrypt
• RSA-PKCS#1v1.5 的 RSA padding
• RC4 的任何使用
• 很蠢的设计：临时 RSA 密钥协商，GOST 类CipherSuite，Snap Start 等
• 可怕的向后兼容要求，导致迟迟不能废弃一些老算法。</p>

<p>The Most Dangerous Code in the World: Validating SSL Certificates in Non-Browser Software</p>

<p><a href="http://crypto.stanford.edu/~dabo/pubs/abstracts/ssl-client-bugs.html">http://crypto.stanford.edu/~dabo/pubs/abstracts/ssl-client-bugs.html</a></p>

<p><a href="https://www.cs.utexas.edu/~shmat/shmat_ccs12.pdf">https://www.cs.utexas.edu/~shmat/shmat_ccs12.pdf</a></p>

<p><a href="https://www.dfn-cert.de/dokumente/workshop/2013/FolienSmith.pdf">Why Eve and Mallory Love Android An Analysis of Android SSL (In)Security</a></p>

<a name="L2......................."></a>
<h3>2. 密码学常见陷阱</h3>

<p>先举几个加密协议被破解的例子，给大家助兴：</p>

<ul>
<li> <a href="https://www.91ri.org/8928.html">人人网使用256比特RSA加密登录密码，3分钟可破</a></li>
<li> <a href="http://www.happybearsoftware.com/you-are-dangerously-bad-at-cryptography.html">Flickr length extension attack 漏洞</a></li>
<li> <a href="https://blog.thijsalkema.de/blog/2013/10/08/piercing-through-whatsapp-s-encryption/">分析whatsapp协议缺陷的一个文章</a></li>
<li> <a href="https://cryptanalysis.eu/blog/2012/02/02/dont-trust-satellite-phones-the-gmr-1-and-gmr-2-ciphers-have-been-broken/">卫星电话的私有gmr-1/gmr-2加密算法被逆向并破解</a></li>
<li> <a href="http://cryptofails.blogspot.ca/2013/07/cakephp-using-iv-as-key.html">http://cryptofails.blogspot.ca/2013/07/cakephp-using-iv-as-key.html</a></li>
<li> <a href="http://cryptofails.blogspot.ca/2013/07/saltstack-rsa-e-d-1.html">http://cryptofails.blogspot.ca/2013/07/saltstack-rsa-e-d-1.html</a></li>
</ul>


<p>网上有一些资料，有兴趣自己看吧:</p>

<ul>
<li><a href="https://www.schneier.com/essays/archives/1998/01/security_pitfalls_in.html">https://www.schneier.com/essays/archives/1998/01/security_pitfalls_in.html</a></li>
<li><a href="https://www.schneier.com/essays/archives/1999/03/cryptography_the_imp.html">https://www.schneier.com/essays/archives/1999/03/cryptography_the_imp.html</a></li>
<li><a href="http://www.lauradhamilton.com/10-cryptography-mistakes-amateurs-make">http://www.lauradhamilton.com/10-cryptography-mistakes-amateurs-make</a></li>
<li><a href="http://www.cryptofails.com/">http://www.cryptofails.com/</a></li>
<li><a href="http://cryptofails.blogspot.ca/">http://cryptofails.blogspot.ca/</a></li>
</ul>


<p>密码学常见应用错误
<a href="http://security.stackexchange.com/questions/2202/lessons-learned-and-misconceptions-regarding-encryption-and-cryptology">http://security.stackexchange.com/questions/2202/lessons-learned-and-misconceptions-regarding-encryption-and-cryptology</a></p>

<ul>
<li>不要自己发明加密算法。Don&rsquo;t roll your own crypto.</li>
<li>不要使用不带MAC的加密 Don&rsquo;t use encryption without message authentication.</li>
<li>在拼接多个字符串做hash之前，要特别小心 Be careful when concatenating multiple strings, before hashing.</li>
<li>要特别小心使用的随机数生成器，确保有足够的熵 Make sure you seed random number generators with enough entropy.</li>
<li>不要重用 nonce 或者。IV Don&rsquo;t reuse nonces or IVs.</li>
<li>加密和MAC不要使用同样的key，非对称加密和签名不要使用相同的key Don&rsquo;t use the same key for both encryption and authentication. Don&rsquo;t use the same key for both encryption and signing.</li>
<li>不要使用ECB模式做对称加密 Don&rsquo;t use a block cipher with ECB for symmetric encryption</li>
<li>Kerckhoffs定律，一个密码学系统的安全性必须建立在密码保密的基础上，其他都是公开的。Kerckhoffs&rsquo;s principle: A cryptosystem should be secure even if everything about the system, except the key, is public knowledge</li>
<li>不要把用户产生的密码作为加密的key。Try to avoid using passwords as encryption keys.</li>
<li>在密码学协议中，任何2条消息的密文都不应该一样。In a cryptographic protocol: Make every authenticated message recognisable: no two messages should look the same</li>
<li>不要把相同的key用在通信的2个方向上。Don&rsquo;t use the same key in both directions.</li>
<li>不要使用不安全的key长度。Don&rsquo;t use insecure key lengths.</li>
<li>&hellip;</li>
</ul>


<a name="L13...........TLS:.TLS.1.3"></a>
<h2>13. 下一代TLS: TLS 1.3</h2>

<p>tls 1.3的草案在 <a href="http://tlswg.github.io/tls13-spec/">http://tlswg.github.io/tls13-spec/</a>
相比tls 1.2,  1.3改动巨大，这些改动对加密通信协议的一般设计也有重要启发。</p>

<p>TLS 1.3 的改动
值得关注的重大改进有：</p>

<ul>
<li>0-RTT支持</li>
<li>1-RTT握手支持</li>
<li>改为使用HKDF做密钥拓展</li>
<li>彻底禁止RC4</li>
<li>彻底禁止压缩</li>
<li>彻底禁止aead以外的其他算法</li>
<li>去除aead的显式IV</li>
<li>去除了AEAD的AD中的长度字段</li>
<li>去除ChangeCipherSpec</li>
<li>去除重协商</li>
<li>去除静态RSA和DH密钥协商</li>
</ul>


<p>移动互联网兴起之后，rtt延迟变得更重要，可以看到，tls 1.3 的各项改进，主要就是针对移动互联网场景的。</p>

<p>TLS 1.3 去掉了 ChangeCipherSpec ，这样record之上有3个协议：handshake，alert，application data</p>

<a name="L1..record.............................."></a>
<h3>1. record层的密码学保护的改动</h3>

<p>由于只保留了aead，所以不需要MAC key了。</p>

<p>aead的具体参数用法也有调整，前文有。</p>

<p>KDF 换成了标准的HKDF，有2种 tls_kdf_sha256, tls_kdf_sha384</p>

<a name="L2.handshake..............."></a>
<h3>2.handshake协议的改动</h3>

<p>鉴于session ticket如此之好用，简直人见人爱，所以 TLS 1.3 直接把session ticket内置了，并改名叫 PSK</p>

<p>要注意的是，此 PSK 和 tls 1.2中一个很生僻的psk(见 <a href="https://tools.ietf.org/html/rfc4279">rfc4279</a> )并不是一回事。</p>

<p>综合考虑了 session resuming ，session ticket后，
TLS 1.3 提出了3种handshake模式：</p>

<ol>
<li>Diffie-Hellman （ 包含 DH 和 ECDH 两种，下文说到 ECDH 的地方，请自行脑补成 &ldquo;ECDH/DH"）.</li>
<li>A pre-shared symmetric key (PSK) ，预先共享的对称密钥，此处用统一的模型来处理session resuming 和 rfc4279的psk</li>
<li>A combination of a symmetric key and Diffie-Hellman ，前两者合体</li>
</ol>


<a name="L3.1-RTT......."></a>
<h3>3.1-RTT 握手</h3>

<p>首先，TLS 1.2 的握手有2个rtt，第一个rtt是 ClientHello/ServerHello，第二个rtt是ClientKeyExchange/ServerKeyExchange，
之所以KeyExchange要放在第二个rtt，是由于tls1.2要支持多种密钥交换算法，和各种不同参数(比如 DH还是ECDH还是RSA，ECDHE用什么曲线，DH用什么群生成元，用什么模数，等等)，这些算法和参数都依赖第一个rtt去协商出来，
TLS1.3大刀阔斧地砍掉了各种自定义DH群，砍掉了ECDH的自定义曲线，砍掉了RSA协商，密钥协商的算法只剩下不多几个，而且其实大家实际应用中基本都用 ECDH P-256，也没啥人用别的，所以干脆让客户端缓存服务器上一次用的是啥协商算法，把 KeyExchange直接和入第一个rtt，客户端在第一个rtt里直接就用缓存的这个算法发KeyExchange的公钥，如果服务器发现客户端发上来的算法不对，那么再告诉正确的，让客户端重试好了。
这样，就引入了 HelloRetryRequest 这个消息。</p>

<p>这样，基本没有副作用，就可以降到 1-RTT。
这是TLS 1.3 的完整握手。</p>

<p> <strong>显然，如果一个协议只有一种密钥协商算法，比如定死为 ECDH P-256，那一定可以做到 1-RTT</strong></p>

<a name="L4...................0-RTT......"></a>
<h3>4.  有副作用的 0-RTT握手</h3>

<p>0-RTT应该是受Google的QUIC协议的启发，
如果服务器把自己的 ECDH 公钥长期缓存在客户端，那么客户端就可以用缓存里的ECDHE公钥，构造一个电子信封，在第一个RTT里，直接就发送应用层数据了。
这个长期缓存在客户端的ECDH公钥，称为 半静态 ECDH 公钥（ semi-static (EC)DH share ）
ECDH公钥通过 ServerConfiguration 消息发送给客户端。</p>

<p>这个0-rtt优化是有副作用的：</p>

<ol>
<li>0-RTT发送的应用数据没有前向安全性。</li>
<li>跨连接可以重放0-RTT里的应用数据（任何服务器端无共享状态的协议，都无法做到跨连接防重放）</li>
<li>如果服务器端 半静态 ECDH公钥对应的私钥泄露了，攻击者就可以伪装成客户端随意篡改数据了。</li>
</ol>


<p>服务器在 ServerConfiguration 消息里把半静态 ECDH 公钥发送给客户端。
ServerConfiguration 值得关注一下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">configuration_id</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">uint32</span> <span class="n">expiration_date</span><span class="p">;</span>
</span><span class='line'>      <span class="n">NamedGroup</span> <span class="n">group</span><span class="p">;</span>
</span><span class='line'>      <span class="n">opaque</span> <span class="n">server_key</span><span class="o">&lt;</span><span class="mf">1..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">EarlyDataType</span> <span class="n">early_data_type</span><span class="p">;</span>
</span><span class='line'>      <span class="n">ConfigurationExtension</span> <span class="n">extensions</span><span class="o">&lt;</span><span class="mf">0..2</span><span class="o">^</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">ServerConfiguration</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中的 expiration_date 是本 ServerConfiguration 最后的有效期限。
这个值绝对不允许大于7天。
客户端绝对不允许存储 ServerConfiguration 大于7天，不管服务器怎么填这个值。</p>

<p>0-RTT 中的应用数据，放在 EarlyDataIndication 中发送，</p>

<p>TLS 1.3 还特意给 EarlyDataIndication  定义了一种 ContentType : early_handshake
（共四种 alert(21), handshake(22),      application_data(23), early_handshake(25) ）</p>

<a name="L5...Resumption......PSK"></a>
<h3>5.  Resumption 和  PSK</h3>

<p>TLS 1.3 里面，把session resumption/session ticket 恢复出来的key，和 psk (rfc4279)， 统一在一个 handshake PSK 模式下处理。</p>

<p>PSK CipherSuite可以 把PSK和ECDHE结合起来用，这样是有前向安全性的。
也可以仅仅使用PSK，这样就没有前向安全性。</p>

<a name="L6..Key.Schedule................"></a>
<h3>6. Key Schedule 过程的改动</h3>

<p>TLS 1.3 中，综合考虑的 session ticket的各种情况后，提出了 ES，SS 两个概念，统一处理密钥协商的各种情况。
在各种handshake模式下，ES和SS的取值来源不同。</p>

<dl>
<dt>Ephemeral Secret (ES)</dt>
<dd> 每个连接新鲜的 ECDHE 协商得出的值。凡是从 ES 得出的值，都是前向安全的（当然，在 PSK only模式下，不是前向安全的）。</dd>
<dt>Static Secret (SS)</dt>
<dd> 从静态，或者半静态key得出的值。例如psk，或者服务器的半静态 ECDH 公钥。</dd>
</dl>

<p>在各种 handshake 模式下：</p>

<p>|    Key Exchange       |     Static Secret (SS) |    Ephemeral Secret (ES) |
|    &mdash;&mdash;&mdash;&mdash;       |     &mdash;&mdash;&mdash;&mdash;&mdash;&mdash; |   &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;  |
|(EC)DHE (完整握手)|Client ephemeral  w/ server ephemeral | Client ephemeral w/ server ephemeral|
|(EC)DHE (w/ 0-RTT)|Client ephemeral w/ server static |Client ephemeral w/ server ephemeral |
|    PSK                    |     Pre-Shared Key    |       Pre-shared key  |
|    PSK + (EC)DHE          |     Pre-Shared Key    |    Client ephemeral  w/ server ephemeral |                                              <br/>
如上表所示：</p>

<ol>
<li>完整的 1-RTT握手的时候， SS 和 ES 都是用的 ephemeral key ，这样是一定有前向安全性的。</li>
<li>使用 0-RTT 的握手的时候，使用客户端的 ephemeral key 和 服务器端的半静态 ECDH 公钥生成 SS，</li>
<li>纯 PSK，这种场景完全没有前向安全性，应该避免。</li>
<li>PSK +　ECDHE，这种场景比较有意思，SS是用的Pre-Shared Key，没有前向安全性，ES 用的 ephemeral key，有前向安全性。</li>
</ol>


<p>可以看到，相比 TLS 1.2 的 session ticket，TLS 1.3 中 的 PSK + ECDHE，是结合了 ES 的，这样就有了前向安全性，相对更安全。</p>

<p>和 TLS 1.2 不同的是，TLS 1.3的 master_secret 是使用 ES和SS 两个得出的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="o">-</span><span class="n">Label</span><span class="p">(</span><span class="n">Secret</span><span class="p">,</span> <span class="n">Label</span><span class="p">,</span> <span class="n">HashValue</span><span class="p">,</span> <span class="n">Length</span><span class="p">)</span> <span class="o">=</span>
</span><span class='line'>       <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="p">(</span><span class="n">Secret</span><span class="p">,</span> <span class="n">Label</span> <span class="o">+</span> <span class="sc">&#39;\0&#39;</span> <span class="o">+</span> <span class="n">HashValue</span><span class="p">,</span> <span class="n">Length</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mf">1.</span> <span class="n">xSS</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SS</span><span class="p">,</span> <span class="s">&quot;extractedSS&quot;</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mf">2.</span> <span class="n">xES</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ES</span><span class="p">,</span> <span class="s">&quot;extractedES&quot;</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mf">3.</span> <span class="n">master_secret</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">xSS</span><span class="p">,</span> <span class="n">xES</span><span class="p">,</span> <span class="s">&quot;master secret&quot;</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="mf">4.</span> <span class="n">finished_secret</span> <span class="o">=</span> <span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="o">-</span><span class="n">Label</span><span class="p">(</span><span class="n">xSS</span><span class="p">,</span>
</span><span class='line'>                                         <span class="s">&quot;finished secret&quot;</span><span class="p">,</span>
</span><span class='line'>                                         <span class="n">handshake_hash</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p> Traffic Key Calculation</p>

<p> 加密流量用的key，在 TLS 1.3 里面称为 Traffic Key，由于多引入了一种ContentType，在不同的ContentType下，Traffic Key 并不相同。
 如下表：</p>

<table>
<thead>
<tr>
<th>  Record Type </th>
<th> Secret </th>
<th> Label     </th>
<th>                         Handshake Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>  Early data  </td>
<td>   xSS  </td>
<td> &ldquo;early data key expansion&rdquo;        </td>
<td>    ClientHello </td>
</tr>
<tr>
<td>  Handshake   </td>
<td>  xES   </td>
<td> &ldquo;handshake key expansion&rdquo;         </td>
<td> ClientHello&hellip;      ServerKeyShare</td>
</tr>
<tr>
<td>  Application </td>
<td> master secret </td>
<td> &ldquo;application data key expansion&rdquo;  </td>
<td>  All handshake messages but     Finished</td>
</tr>
</tbody>
</table>


<p>要关注的是， Early Data 的 Traffic Key 是用 xSS 算出来的。也就是说，是用 Pre-Shared Key决定的。因此是没有前向安全性的。</p>

<p>在一个TLS 连接中，究竟是用哪种 handshake 模式，是由 CipherSuite 协商决定的。</p>

<a name="L.....TLS....................."></a>
<h1>三. TLS协议的代码实现</h1>

<p>TLS的主要实现：</p>

<ul>
<li>OpenSSL</li>
<li>libressl</li>
<li>boringssl(Google)</li>
<li>libressl</li>
<li>s2n(Amazon)</li>
<li>nss(Mozilla)</li>
<li>polarssl</li>
<li>botan</li>
<li>gnutls(gpl)</li>
<li>cyassl</li>
<li>go.crypto</li>
</ul>


<p>openssl 的 tls 协议实现有 6W 行，libressl 3.68W行， polarssl 1.29 W行， Botan 1.13 W行</p>

<p>openssl是其中代码最糟糕的（没有之一）。
openssl提供了的api都太过于底层，api设计的也很费解，而且严重匮乏文档。
请参考 <a href="http://blog.csdn.net/dog250/article/details/24552307">《令人作呕的OpenSSL》</a></p>

<p>不幸的是，OpenSSL是用的最广泛的，是事实上的标准。</p>

<p>boringssl
Google’s OpenSSL fork by Adam Langley (@agl__)</p>

<p><a href="https://github.com/sweis/crypto-might-not-suck">https://github.com/sweis/crypto-might-not-suck</a></p>

<a name="L.....TLS........................"></a>
<h1>四. TLS协议的部署与优化</h1>

<p>这个方面网上的文章还是不少的，本文就简略一点。</p>

<p>全站https时代正在到来!，
移动互联网对人们生活的介入越来越深人，用户越来越多的隐私数据和支付数据通过网络传输，人们的隐私意识安全意识不断提高；运营商流量劫持，强行插入广告越来越引起反感。因此，各互联网大厂都开始切换到https。</p>

<p>例如，2015年3月百度全站切换到https，百度运维部的介绍文章：<a href="http://op.baidu.com/2015/04/https-index/">《全站 https 时代的号角 : 大型网站的 https 实践系列》</a>。</p>

<p>不久后淘宝切了全站https，<a href="https://www.taobao.com/">https://www.taobao.com/</a>
<a href="http://velocity.oreilly.com.cn/2015/index.php?func=session&amp;id=8">http://velocity.oreilly.com.cn/2015/index.php?func=session&amp;id=8</a></p>

<p>国外：由Snowden爆料，美国人发现NSA在大范围深度地监听互联网; 还有openssl连续被爆多个严重安全漏洞。之后近2年，各种加密通信协议，软件，项目开始热门，各大厂商开始关注密码协议，做数据加密，信息安全。(openssl资助，pfs被重视，)</p>

<p>Google的性能数据：</p>

<blockquote><p>“In January this year (2010), Gmail switched to using HTTPS for
everything by default. .. In order to do this we had to deploy no
additional machines and no special hardware. On our production
frontend machines, <strong>SSL accounts for &lt; 1% of the CPU load,</strong> &lt; 10 KB of
memory per connection, and &lt; 2% of network overhead…</p>

<p>If you stop reading now you only need to remember one thing: SSL is
not computationally expensive any more.”</p>

<p>&ndash; Overclocking SSL blog post by Adam Langley (Google   <a href="https://www.imperialviolet.org/2010/06/25/overclocking-ssl.html">https://www.imperialviolet.org/2010/06/25/overclocking-ssl.html</a> )</p></blockquote>

<p>google的优化：
<a href="https://bit.ly/gottls">https://bit.ly/gottls</a>
<a href="https://www.imperialviolet.org/2010/06/25/overclocking-ssl.html">https://www.imperialviolet.org/2010/06/25/overclocking-ssl.html</a>
<a href="https://istlsfastyet.com/">https://istlsfastyet.com/</a>
<a href="https://www.ssllabs.com/downloads/SSL_TLS_Deployment_Best_Practices.pdf">https://www.ssllabs.com/downloads/SSL_TLS_Deployment_Best_Practices.pdf</a>
<a href="http://chimera.labs.oreilly.com/books/1230000000545/ch04.html">http://chimera.labs.oreilly.com/books/1230000000545/ch04.html</a></p>

<p><img src="https://blog.helong.info//images/blog/tls/google_ecdsa_chacha20.png" alt="" /></p>

<p>baidu的经验：
<a href="http://op.baidu.com/2015/04/https-index/">http://op.baidu.com/2015/04/https-index/</a></p>

<p>aws的配置
<a href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/elb-https-load-balancers.html">http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/elb-https-load-balancers.html</a></p>

<p>可以参考byron之前给出的一个介绍nginx配置的文章 <a href="https://blog.helong.info//blog/2015/05/08/https-config-optimize-in-nginx/">Nginx下配置高性能，高安全性的https TLS服务</a>，本人提供售后咨询服务，哈哈。</p>

<p>CipherSuite配置(Mozilla的权威配置)
<a href="https://wiki.mozilla.org/Security/Server_Side_TLS">https://wiki.mozilla.org/Security/Server_Side_TLS</a></p>

<p>hardenedlinux的这个文档：SSL/TLS部署最佳实践v1.4:
<a href="http://hardenedlinux.org/jekyll/update/2015/07/28/ssl-tls-deployment-1.4.html">http://hardenedlinux.org/jekyll/update/2015/07/28/ssl-tls-deployment-1.4.html</a></p>

<p>全站切https，值得关注的一个点是cdn切https，如果cdn资源不使用cdn提供商的域名的话，之前会有私钥必须得交给cdn提供商的安全风险，但是幸运的是cloudflare提出了keyless ssl方案，解决了这个问题
<a href="https://github.com/cloudflare/keyless">https://github.com/cloudflare/keyless</a>，cdn切https应该可以借鉴。</p>

<p>有时候我们会用wireshark之类的工具抓包，来调试http协议，但是切换到https后，都变成二进制密文了，直接抓包是行不通了，那怎么调试协议呢？
有个简单的解决办法：<a href="http://km.oa.com/group/19582/articles/show/220857">小技巧:如何在wireshark里查看https的明文数据</a>
参考 <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format</a></p>

<a name="L................................case...QUIC...iMessage...TextSecure..otr...ios.HomeKit...libsodium"></a>
<h1>五. 更多的加密通信协议case：QUIC，iMessage，TextSecure, otr,  ios HomeKit，libsodium</h1>

<p>时间有限，下面有些协议就没有做详细的分析了，读者自己去看吧。</p>

<a name="L1..QUIC"></a>
<h3>1. QUIC</h3>

<p><strong>QUIC =  TCP+TLS+SPDY</strong>
<a href="https://www.chromium.org/quic">https://www.chromium.org/quic</a></p>

<p>其中的 crypto design文档是本文关注的。</p>

<p><a href="http://network.chinabyte.com/162/13361162.shtml">http://network.chinabyte.com/162/13361162.shtml</a>
<a href="http://blog.chromium.org/2015/04/a-quic-update-on-googles-experimental.html">http://blog.chromium.org/2015/04/a-quic-update-on-googles-experimental.html</a>
截止2015.04，从Chrome到Google server的流量的大概50% 是走的QUIC协议，而且还在不断增加。
据说减少了YouTube的30%的卡顿。</p>

<p><a href="https://github.com/devsisters/libquic">https://github.com/devsisters/libquic</a></p>

<p>QUIC值得借鉴的地方有：crypto算法选择，0-RTT的实现方法，证书压缩省流量</p>

<p>QUIC的crypto算法选择：
密钥交换算法只有2种：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Key exchange methods</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kP256</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">);</span>   <span class="c1">// ECDH, Curve P-256</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kC255</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">);</span>   <span class="c1">// ECDH, Curve25519</span>
</span></code></pre></td></tr></table></div></figure>


<p>对称加密只使用AEAD，并且只有2种：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// AEAD algorithms</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kNULL</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>   <span class="c1">// null algorithm</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kAESG</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">);</span>   <span class="c1">// AES128 + GCM-12</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kCC12</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">);</span>   <span class="c1">// ChaCha20 + Poly1305</span>
</span></code></pre></td></tr></table></div></figure>


<p>证书类型2种，RSA证书， 和 RSA/ECDSA双证书</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Proof types (i.e. certificate types)</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kX509</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="err">‘</span><span class="n">X</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="mi">5</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="mi">0</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="mi">9</span><span class="err">’</span><span class="p">);</span>   <span class="c1">// X.509 certificate, all key types</span>
</span><span class='line'><span class="k">const</span> <span class="n">QuicTag</span> <span class="n">kX59R</span> <span class="o">=</span> <span class="n">TAG</span><span class="p">(</span><span class="err">‘</span><span class="n">X</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="mi">5</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="mi">9</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="n">R</span><span class="err">’</span><span class="p">);</span>   <span class="c1">// X.509 certificate, RSA keys only</span>
</span></code></pre></td></tr></table></div></figure>


<p> handshake的结果是为了协商出来下面这些参数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Parameters negotiated by the crypto handshake.</span>
</span><span class='line'><span class="k">struct</span> <span class="n">NET_EXPORT_PRIVATE</span> <span class="n">QuicCryptoNegotiatedParameters</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Initializes the members to 0 or empty values.</span>
</span><span class='line'>  <span class="n">QuicCryptoNegotiatedParameters</span><span class="p">();</span>
</span><span class='line'>  <span class="o">~</span><span class="n">QuicCryptoNegotiatedParameters</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">QuicTag</span> <span class="n">key_exchange</span><span class="p">;</span>
</span><span class='line'>  <span class="n">QuicTag</span> <span class="n">aead</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">initial_premaster_secret</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">forward_secure_premaster_secret</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// subkey_secret is used as the PRK input to the HKDF used for key extraction.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">subkey_secret</span><span class="p">;</span>
</span><span class='line'>  <span class="n">CrypterPair</span> <span class="n">initial_crypters</span><span class="p">;</span>
</span><span class='line'>  <span class="n">CrypterPair</span> <span class="n">forward_secure_crypters</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// Normalized SNI: converted to lower case and trailing &#39;.&#39; removed.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sni</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">client_nonce</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">server_nonce</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// hkdf_input_suffix contains the HKDF input following the label: the</span>
</span><span class='line'>  <span class="c1">// ConnectionId, client hello and server config. This is only populated in the</span>
</span><span class='line'>  <span class="c1">// client because only the client needs to derive the forward secure keys at a</span>
</span><span class='line'>  <span class="c1">// later time from the initial keys.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hkdf_input_suffix</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// cached_certs contains the cached certificates that a client used when</span>
</span><span class='line'>  <span class="c1">// sending a client hello.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">cached_certs</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// client_key_exchange is used by clients to store the ephemeral KeyExchange</span>
</span><span class='line'>  <span class="c1">// for the connection.</span>
</span><span class='line'>  <span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">KeyExchange</span><span class="o">&gt;</span> <span class="n">client_key_exchange</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// channel_id is set by servers to a ChannelID key when the client correctly</span>
</span><span class='line'>  <span class="c1">// proves possession of the corresponding private key. It consists of 32</span>
</span><span class='line'>  <span class="c1">// bytes of x coordinate, followed by 32 bytes of y coordinate. Both values</span>
</span><span class='line'>  <span class="c1">// are big-endian and the pair is a P-256 public key.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">channel_id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Used when generating proof signature when sending server config updates.</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">x509_ecdsa_supported</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Used to generate cert chain when sending server config updates.</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">client_common_set_hashes</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">client_cached_cert_hashes</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到：QUIC内置支持sni
而且区分 initial_premaster_secret 和 forward_secure_premaster_secret。</p>

<p>先这样吧，后续再分析。</p>

<a name="L2..apple.ios.iMessage"></a>
<h3>2. apple ios iMessage</h3>

<p>iOS Security Guide : <a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf">https://www.apple.com/business/docs/iOS_Security_Guide.pdf</a></p>

<p>Apple 的 iMessage系统的密码学安全机制设计，端到端加密，前向安全(PFS)，签名使用ECDSA P-256，非对称加密使用RSA 1280 bit，苹果自己维护一个 用户名&ndash;》公钥 的目录服务。</p>

<p>iMessage在注册时，给每个用户生成一对 RSA-1280 密钥用作非对称加密，一对 NIST P-256 ECDSA 密钥用作签名，2个私钥本地保存，公钥上传给Apple的目录服务器(IDS)。</p>

<p>当要发送消息的时候，根据接收方的用户名，从IDS里面找到RSA公钥 和 APNS 地址。然后随机生成 128 比特密钥，用 AES-CTR-128 加密要发送的消息，用接收方的 RSA 1280 公钥，使用 OAEP 填充加密 128比特aes密钥。然后拼接 aes密文和rsa密文，对结果使用发送方的 ECDSA 私钥，用sha1算一次数字签名。
然后把aes密文，rsa密文，数字签名拼接起来，发给 APNS 投递给接收方。</p>

<p>如果要发送大文件，就生成一个key，用 aes-ctr-256 加密文件，并计算一个sha1，然后把key和sha1 放入消息里面发送。</p>

<blockquote><p>Apple iMessage is a messaging service for iOS devices and Mac
computers. iMessage supports text and attachments such as photos,
contacts, and locations.Apple does not log messages or attachments, and their
contents are protected by end-to-end encryption so no one but the
sender and receiver can access them. Apple cannot decrypt the data.
&hellip;
When a user turns on iMessage on a device, the device generates two
pairs of keys for use with the service: an RSA 1280-bit key for
encryption and an ECDSA 256-bit key on the NIST P-256 curve for
signing. The private keys for both key pairs are saved in the device’s
keychain and the public keys are sent to Apple’s directory service
(IDS), where they are associated with the user’s phone number or email
address, along with the device’s APNs address.
&hellip;</p>

<p>Users start a new iMessage conversation by entering an address or name.
If the user enters a name, the device first utilizes
 the user’s Contacts app to gather the phone numbers and email
 addresses associated with that name, then gets the public keys and
 APNs addresses from the IDS. The user’s outgoing message is
 individually encrypted for each of the receiver’s devices. The public
 RSA encryption keys of the receiving devices are retrieved from IDS.
 For each receiving device, the sending device generates a random
 128-bit key and encrypts the message with it using AES in CTR mode.
 This per-message AES key is encrypted using RSA-OAEP to the public key
 of the receiving device. The combination of the encrypted message text
 and the encrypted message key is then hashed with SHA-1, and the hash
 is signed with ECDSA using the sending device’s private signing key.
 The resulting messages, one for each receiving device, consist of the
 encrypted message text, the encrypted message key, and the sender’s
 digital signature. They are then dispatched to the APNs for delivery.
 Metadata, such as the timestamp and APNs routing information, is not
 encrypted. Communication with APNs is encrypted using a forwardsecret
 TLS channel.</p>

<p> APNs can only relay messages up to 4 KB or 16 KB in size, depending
on iOS version. If the message text is too long, or if an attachment
such as a photo is included, the attachment is encrypted using AES in
CTR mode with a randomly generated 256-bit key and uploaded to iCloud.
The AES key for the attachment, its URI (Uniform Resource Identifier),
and a SHA-1 hash of its encrypted form are then sent to the recipient
as the contents of an iMessage, with their confidentiality and
integrity protected through normal iMessage encryption,</p></blockquote>

<a name="L3..apple.ios.HomeKit"></a>
<h3>3. apple ios HomeKit</h3>

<p>iOS Security Guide : <a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf">https://www.apple.com/business/docs/iOS_Security_Guide.pdf</a></p>

<p>Apple的HomeKit，是 WWDC2014 上提出的 iot 智能家居开发平台 （iot啊，目前最火的概念啊，各种高大上啊）。
可以看到 HomeKit 作为一个全新的协议， 抛弃了历史遗留算法，直接采用了目前最先进的算法</p>

<p>HomeKit 密码学安全机制的设计：
使用Ed25519做 公钥签名/验证，使用 SRP(3072 bit) 做来在iOS设备和HomeKit配件之间交换密码并做认证，使用 ChaCha20-Poly1305做对称加密，
使用HKDF-SHA512做密钥拓展。每个session的开始用Station-to-Station 协议做密钥协商和认证，
随后使用Curve25519做密钥协商，生成共享key。</p>

<blockquote><p> HomeKit provides a home automation infrastructure that utilizes
 iCloud and iOS security to protect and synchronize private data
 without exposing it to Apple.<br/>
 &hellip;
 HomeKit identity and
 security are based on Ed25519 public-private key pairs. An Ed25519 key
 pair is generated on the iOS device for each user for HomeKit, which
 becomes his or her HomeKit identity. It is used to authenticate
 communication between iOS devices, and between iOS devices and
 accessories.<br/>
 &hellip;  <br/>
 Communication with HomeKit accessories
 HomeKit accessories generate their own Ed25519 key pair for use in
 communicating with iOS devices.
 To establish a  relationship between an iOS device and a HomeKit accessory, keys are
 exchanged using Secure Remote Password (3072-bit) protocol, utilizing
 an 8-digit code provided by the accessory’s manufacturer and entered
 on the iOS device by the user, and then encrypted using
 ChaCha20-Poly1305 AEAD with HKDF-SHA-512-derived keys. The accessory’s
 MFi certification is also verified during setup.  When the iOS device
 and the HomeKit accessory communicate during use, each authenticates
 the other utilizing the keys exchanged in the above process. Each
 session is established using the Station-to-Station protocol and is
 encrypted with HKDF-SHA-512 derived keys based on per-session
 Curve25519 keys. This applies to both IP-based and Bluetooth Low
 Energy accessories.</p></blockquote>

<a name="L4..TextSecure"></a>
<h3>4. TextSecure</h3>

<p>TextSecure是一个端到端im加密通信协议，由WhisperSystem公司设计，目前whatsapp和WhisperSystem公司有合作，看网上资料，2014年11月开始，whatsapp已经开始使用TextSecure协议来做端到端加密(消息来源:  <a href="https://whispersystems.org/blog/whatsapp/">https://whispersystems.org/blog/whatsapp/</a>
<a href="http://www.wired.com/2014/11/whatsapp-encrypted-messaging/">http://www.wired.com/2014/11/whatsapp-encrypted-messaging/</a>)。</p>

<p>TextSecure V2 协议：
<a href="https://github.com/WhisperSystems/TextSecure/wiki/ProtocolV2">https://github.com/WhisperSystems/TextSecure/wiki/ProtocolV2</a>
<a href="https://github.com/trevp/axolotl/wiki">https://github.com/trevp/axolotl/wiki</a>
<a href="https://whispersystems.org/blog/advanced-ratcheting/">https://whispersystems.org/blog/advanced-ratcheting/</a></p>

<p>The TextSecure encrypted messaging protocol 是otr的一个衍生协议，主要有2个不同点:
1.ECDSA代替DSA
2.某些数据结构压缩</p>

<a name="L5..otr......."></a>
<h3>5. otr 协议</h3>

<p>标准文档见：<a href="https://otr.cypherpunks.ca/Protocol-v3-4.0.0.html">https://otr.cypherpunks.ca/Protocol-v3-4.0.0.html</a></p>

<p>open kullo协议
<a href="https://www.kullo.net/protocol/">https://www.kullo.net/protocol/</a></p>

<p>Choice of algorithms
Whenever we write about symmetric or asymmetric encryption or signatures, we mean the following algorithms, modes and parameters:</p>

<p>symmetric encryption: AES-256 in GCM mode
asymmetric encryption: RSA-4096 with OAEP(SHA-512) padding
asymmetric signatures: RSA-4096 with PSS(SHA-512) padding</p>

<a name="L6...libsodium.NaCL"></a>
<h3>6.  libsodium/NaCL</h3>

<p>libsodium/NaCL 值得重点介绍，大力推广 。
新的没有兼容包袱的系统，都值得考虑用 NaCL来代替 openssl。
libsodium是对NaCL的封装，NaCL大有来头，作者 DJB 是密码学领域的权威人物，chacha20，Curve25519 的作者 。
没有历史包袱的项目，强烈建议使用 libsodium/NaCL。</p>

<p>这篇文章介绍了NaCL和openssl相比的各方面改进
<a href="http://cr.yp.to/highspeed/coolnacl-20120725.pdf">http://cr.yp.to/highspeed/coolnacl-20120725.pdf</a>
<a href="https://cryptojedi.org/peter/data/tenerife-20130121.pdf">https://cryptojedi.org/peter/data/tenerife-20130121.pdf</a>
<a href="http://nacl.cr.yp.to/">http://nacl.cr.yp.to/</a></p>

<a name="L7..Tox.im"></a>
<h3>7. Tox.im</h3>

<p>一款实用NaCL的端到端加密im
<a href="https://github.com/irungentoo/toxcore/blob/master/docs/updates/Crypto.md">https://github.com/irungentoo/toxcore/blob/master/docs/updates/Crypto.md</a></p>

<a name="L8..CurveCP"></a>
<h3>8. CurveCP</h3>

<p>CurveCP值得重点介绍，
<a href="http://curvecp.org/security.html">http://curvecp.org/security.html</a></p>

<blockquote><p>CurveCP的安全考量：
Confidentiality and integrity
server authentication?
client authentication?
replay attacks?
man-in-the-middle attacks?
passive forward secrecy?
active forward secrecy?
against traffic analysis? internet destination, exact timing, and approximate length of each packet that you send.</p>

<p>Availability availability, i.e., to make denial-of-service attacks more difficult.
Blind amplification
Unauthenticated memory consumption
CPU consumption</p>

<p>Efficiency
CPU overhead
Network overhead without packet loss
Latency without packet loss</p>

<p>Decongestion</p></blockquote>

<a name="L9..tcpcrypt"></a>
<h3>9. tcpcrypt</h3>

<p><a href="http://tcpcrypt.org/">http://tcpcrypt.org/</a></p>

<a name="L10.noise"></a>
<h3>10.noise</h3>

<p><a href="https://github.com/trevp/noise/wiki">https://github.com/trevp/noise/wiki</a></p>

<a name="L11.tcpcrypt"></a>
<h3>11.tcpcrypt</h3>

<p><a href="http://tcpcrypt.org/">http://tcpcrypt.org/</a></p>

<a name="L12..netflix.MSL"></a>
<h3>12. netflix MSL</h3>

<p><a href="http://techblog.netflix.com/2014/10/message-security-layer-modern-take-on.html">http://techblog.netflix.com/2014/10/message-security-layer-modern-take-on.html</a></p>

<p><a href="http://www.infoq.com/cn/news/2014/11/netflix-safe-communication">http://www.infoq.com/cn/news/2014/11/netflix-safe-communication</a></p>

<a name="L12.Amazon.KMS............................."></a>
<h3>12.Amazon KMS 密钥管理服务 白皮书</h3>

<p><a href="https://d0.awsstatic.com/whitepapers/KMS-Cryptographic-Details.pdf">https://d0.awsstatic.com/whitepapers/KMS-Cryptographic-Details.pdf</a></p>

<p>值得注意和借鉴的点：</p>

<ul>
<li>对称加密算法选择了 AES-GCM-256</li>
<li>数字签名有2种：ECDSA，RSA，

<ul>
<li> ECDSA 的曲线选择了 secp384r1 （P384），hash 算法选择了 SHA384</li>
<li> RSA 选择2048位，签名体制选择 RSASSA-PSS，hash 算法选择了 SHA256</li>
</ul>
</li>
<li>密钥协商，使用ECDH，选择曲线 secp384r1 (P384)，有2种用法

<ul>
<li> one-pass ECDH.</li>
<li> ECDHE</li>
</ul>
</li>
<li>电子信封加密，KMS内置了电子信封。</li>
</ul>


<p> 电子信封就是，你预先知道对方的长期公钥，你有一个消息要发送给对方，所以你生成一个随机的msgKey,然后 ciphertext = Encrypt(msgKey, message), 并且用对方的公钥加密 msgKey： encKey = Encrypt(k, msgKey),  最后把(encKey, ciphertext) 发给对方，这样，只有公钥对应私钥的拥有者才能打开信封。典型应用比如 OpenPGP。</p>

<p>其中的 one-pass ECDH，大概意思是：
发起方有一对长期使用的签名密钥对，发起方生成一对临时的 ECDH 密钥，用自己的长期签名密钥签署 临时ECDH公钥。对端有一对长期 ECDH 密钥，收到发起方发来的 ECDH 公钥后，验证签名，并且用自己的长期ECDH私钥和收到的公钥协商出共享密钥。
整个过程中，只是用了一对临时ECDH密钥，2对长期密钥。</p>

<p>ECDHE就是比较典型的ECDHE了，和TLS用法一样：双方都持有一对长期使用的签名密钥对，并拥有对方的签名公钥，然后分别生成一对临时ECDH密钥，用自己的签名私钥签署ECDH公钥，把得出的签名和ECDH公钥发给对方，
双方收到对方的ECDH公钥后，验证签名，通过后用对方的ECDH公钥和自己的ECDH私钥协商出共享密钥。DONE。</p>

<p>白皮书中还举了几个例子，</p>

<a name="L......TLS.........................--..............................."></a>
<h1>六.  TLS协议给我们的启发 &ndash; 现代加密通信协议设计</h1>

<p>在看了这么多的分析和案例之后，我们已经可以归纳出加密通信协议设计的普遍问题，和常见设计决策，</p>

<p>设计决策点：</p>

<ol>
<li><p>四类基础算法 加密/MAC/签名/密钥交换 如何选择？
对称加密目前毫无疑问应该直接用aead，最佳选择就是 aes-128-gcm/aes-256-gcm/chacha20-poly1305了
数字签名/验证方案，如果是移动互联网，应该考虑直接放弃 RSA，考虑 P-256 的 ECDSA 公钥证书，或者更进一步的 ed25519 公钥证书。
密钥交换算法，目前最佳选择就是 curve25519，或者 P-256。</p></li>
<li><p>对称加密算法+认证算法，如何选择？或者直接用aead？</p></li>
<li><p>签名算法如何选择？RSA or ECDSA or Ed25519？</p></li>
<li><p>考虑将来的算法调整，要加版本号机制吗？
建议是加上，起码在密钥协商的步骤，要加上版本号。便于将来更新算法。</p></li>
<li><p>RSA用作密钥交换是一个好的选择吗？考虑PFS
建议直接放弃RSA，RSA服务器端性能比ECDSA更差，签名更大费流量，而且没有前向安全性，给私钥保管带来更大风险。</p></li>
<li><p>自建PKI，是个好的选择吗？crl如何解决？
自建PKI可以做到更安全，比如简单的客户端内置数字签名公钥。可是当需要紧急吊销一个证书的时候，只能通过紧急发布新版客户端来解决。</p></li>
<li><p>必须用糟糕的openssl吗？or something better？crypto++,botan, nacl/libsodium, polarssl？libsodium: ed25519+curve2519+chacha20+poly1305</p></li>
<li><p>重放攻击如何解决？某种seq？或者nonce如何生成？</p></li>
<li><p>握手过程被中间人篡改的问题怎么解决？</p></li>
<li><p>性能：私钥运算的cpu消耗可以承受吗？加上某种cache？
要解决私钥运算的高cpu消耗，必然就需要 session ticket/session id 这种cache机制。显然session ticket 更好</p></li>
<li><p>延迟：密钥协商需要几个rtt？最少多少？加上cache后？和tcp对比如何</p></li>
<li><p>TLS的性能(主要指服务器cpu消耗)还有空间可以压榨吗？我能设计一个性能更牛逼的吗？</p></li>
</ol>


<a name="L..................................."></a>
<h1>七. 附录：密码学基础概念</h1>

<p>本文已经很长了，基础概念的内容更多，再展开介绍就太长了，下面就列一下点，贴一下参考资料，就先这样,以后再说吧。</p>

<p>当然，最好的资料是下面列的书。</p>

<a name="L1..................block.cipher"></a>
<h2>1. 块加密算法 block cipher</h2>

<p> AES 等</p>

<p>《AES后分组密码的研究现状 及发展趋势》
<a href="http://www.ccf.org.cn/resources/1190201776262/2010/04/15/019026.pdf">http://www.ccf.org.cn/resources/1190201776262/2010/04/15/019026.pdf</a></p>

<p>aead的介绍（作者是大神）
<a href="https://www.imperialviolet.org/2015/05/16/aeads.html">https://www.imperialviolet.org/2015/05/16/aeads.html</a></p>

<p>3种组合方式之争
<a href="http://www.thoughtcrime.org/blog/the-cryptographic-doom-principle/">http://www.thoughtcrime.org/blog/the-cryptographic-doom-principle/</a></p>

<p>CBC模式+MAC-then-encrypt的padding oracle 攻击, tls POODLE 漏洞
<a href="http://drops.wooyun.org/papers/3194">http://drops.wooyun.org/papers/3194</a>
<a href="https://defuse.ca/blog/recovering-cbc-mode-iv-chosen-ciphertext.html">https://defuse.ca/blog/recovering-cbc-mode-iv-chosen-ciphertext.html</a></p>

<p>128 bit 和 256 bit key size之争
<a href="https://www.schneier.com/blog/archives/2009/07/another_new_aes.html">https://www.schneier.com/blog/archives/2009/07/another_new_aes.html</a></p>

<p>nist 对 aes gcm 的技术标准，官方权威文档：
<a href="http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-spec.pdf">http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-spec.pdf</a></p>

<p>一个gcm的调用范例
<a href="https://github.com/facebook/conceal/blob/master/native/crypto/gcm_util.c">https://github.com/facebook/conceal/blob/master/native/crypto/gcm_util.c</a></p>

<p>DES
1天之内破解DES（2008年）
<a href="http://www.sciengines.com/company/news-a-events/74-des-in-1-day.html">http://www.sciengines.com/company/news-a-events/74-des-in-1-day.html</a></p>

<p>iPhone 5S开始，A7芯片也有了aes硬件指令 (ARMv8 指令集)，有825%的性能提升：
<a href="http://www.anandtech.com/show/7335/the-iphone-5s-review/4">http://www.anandtech.com/show/7335/the-iphone-5s-review/4</a></p>

<a name="L2..................stream.cipher"></a>
<h2>2. 流加密算法 stream cipher</h2>

<p> RC4，ChaCha20 等</p>

<p> 序列密码发展现状
<a href="http://www.ccf.org.cn/resources/1190201776262/2010/04/15/019018.pdf">http://www.ccf.org.cn/resources/1190201776262/2010/04/15/019018.pdf</a></p>

<p>rc4 : <a href="http://www.rc4nomore.com/">http://www.rc4nomore.com/</a></p>

<p>[RC4加密已不再安全，破解效率极高（含视频）]  <a href="http://www.freebuf.com/news/72622.html">http://www.freebuf.com/news/72622.html</a></p>

<a name="L3..Hash.......hash.funtion"></a>
<h2>3. Hash函数 hash funtion</h2>

<p>  MD5，sha1，sha256，sha512 , ripemd 160，poly1305 等</p>

<p>MD5被碰撞:
<a href="http://natmchugh.blogspot.com/2014/10/how-i-created-two-images-with-same-md5.html">http://natmchugh.blogspot.com/2014/10/how-i-created-two-images-with-same-md5.html</a></p>

<p><a href="http://blog.avira.com/md5-the-broken-algorithm/">http://blog.avira.com/md5-the-broken-algorithm/</a></p>

<a name="L4........................message.authentication.code"></a>
<h2>4. 消息验证码函数 message authentication code</h2>

<p>  HMAC-sha256，AEAD 等</p>

<p>为什么要用MAC
<a href="http://www.happybearsoftware.com/you-are-dangerously-bad-at-cryptography.html">http://www.happybearsoftware.com/you-are-dangerously-bad-at-cryptography.html</a></p>

<p>Flickr的漏洞案例：
<a href="http://netifera.com/research/flickr_api_signature_forgery.pdf">http://netifera.com/research/flickr_api_signature_forgery.pdf</a></p>

<p><a href="http://www.ietf.org/rfc/rfc2104.txt">http://www.ietf.org/rfc/rfc2104.txt</a></p>

<a name="L5...............key.exchange"></a>
<h2>5. 密钥交换 key exchange</h2>

<p> DH，ECDH，RSA，PFS方式的（DHE，ECDHE）等</p>

<p><a href="https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/">https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/</a></p>

<p>关于 前向安全性( Perfect Forward Secrecy )
<a href="http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html">http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html</a></p>

<p><a href="http://www.cryptopp.com/wiki/Elliptic_Curve_Cryptography">http://www.cryptopp.com/wiki/Elliptic_Curve_Cryptography</a></p>

<p>google对openssl里面的椭圆曲线的优化：
<a href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/37376.pdf">http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/37376.pdf</a></p>

<p><a href="http://www.math.brown.edu/~jhs/Presentations/WyomingEllipticCurve.pdf">http://www.math.brown.edu/~jhs/Presentations/WyomingEllipticCurve.pdf</a></p>

<p>ripple从nistp256k1曲线迁移到ed25519
<a href="https://ripple.com/uncategorized/curves-with-a-twist/">https://ripple.com/uncategorized/curves-with-a-twist/</a></p>

<p>openssh 6.5 开始支持 ed25519, curve25519, chacha20-poly1305
<a href="http://www.openssh.org/txt/release-6.5">http://www.openssh.org/txt/release-6.5</a></p>

<a name="L6...............public-key.encryption"></a>
<h2>6. 公钥加密 public-key encryption</h2>

<p> RSA，rabin-williams 等</p>

<p>RSA入门必读（斯坦福，普渡的课件）：
<a href="http://crypto.stanford.edu/~dabo/courses/cs255_winter07/rsa.ppt">http://crypto.stanford.edu/~dabo/courses/cs255_winter07/rsa.ppt</a>
<a href="https://engineering.purdue.edu/kak/compsec/NewLectures/Lecture12.pdf">https://engineering.purdue.edu/kak/compsec/NewLectures/Lecture12.pdf</a></p>

<p>PKCS1 标准，应用RSA必读：
<a href="https://www.ietf.org/rfc/rfc3447">https://www.ietf.org/rfc/rfc3447</a></p>

<p>RSA 的公钥为什么比AES的key长？
<a href="http://crypto.stackexchange.com/questions/8687/security-strength-of-rsa-in-relation-with-the-modulus-size">http://crypto.stackexchange.com/questions/8687/security-strength-of-rsa-in-relation-with-the-modulus-size</a></p>

<p><a href="http://cryptofails.blogspot.ca/2013/07/saltstack-rsa-e-d-1.html">http://cryptofails.blogspot.ca/2013/07/saltstack-rsa-e-d-1.html</a></p>

<p>使用什么padding？ OAEP，为什么不要用PKCS V1.5</p>

<p><a href="http://stackoverflow.com/questions/2991603/pkcs1-v2-0-encryption-is-usually-called-oaep-encryption-where-can-i-confirm-i">http://stackoverflow.com/questions/2991603/pkcs1-v2-0-encryption-is-usually-called-oaep-encryption-where-can-i-confirm-i</a></p>

<p><a href="http://crypto.stackexchange.com/questions/12688/can-you-explain-bleichenbachers-cca-attack-on-pkcs1-v1-5">http://crypto.stackexchange.com/questions/12688/can-you-explain-bleichenbachers-cca-attack-on-pkcs1-v1-5</a>
<a href="http://en.wikipedia.org/wiki/Adaptive_chosen-ciphertext_attack">http://en.wikipedia.org/wiki/Adaptive_chosen-ciphertext_attack</a></p>

<p>PKCS #1 &ndash; #15标准协议官方网站：
<a href="http://www.emc.com/emc-plus/rsa-labs/standards-initiatives/public-key-cryptography-standards.htm">http://www.emc.com/emc-plus/rsa-labs/standards-initiatives/public-key-cryptography-standards.htm</a>
<a href="http://arxiv.org/pdf/1207.5446v1.pdf">http://arxiv.org/pdf/1207.5446v1.pdf</a></p>

<p>blinding 一种实现上的技术，用来解决 timing 侧通道攻击的问题
<a href="https://en.wikipedia.org/wiki/Blinding_">https://en.wikipedia.org/wiki/Blinding_</a>(cryptography)
<a href="http://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf">http://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf</a></p>

<p>Twenty Years of Attacks on the RSA Cryptosystem:
<a href="http://crypto.stanford.edu/~dabo/papers/RSA-survey.pdf">http://crypto.stanford.edu/~dabo/papers/RSA-survey.pdf</a></p>

<p> 电子信封(digital envelope)
<a href="http://www.emc.com/emc-plus/rsa-labs/standards-initiatives/what-is-a-digital-envelope.htm">http://www.emc.com/emc-plus/rsa-labs/standards-initiatives/what-is-a-digital-envelope.htm</a></p>

<p>在openssl的evp接口中有直接支持：
<a href="https://wiki.openssl.org/index.php/EVP_Asymmetric_Encryption_and_Decryption_of_an_Envelope">https://wiki.openssl.org/index.php/EVP_Asymmetric_Encryption_and_Decryption_of_an_Envelope</a></p>

<a name="L7.....................signature.algorithm"></a>
<h2>7. 数字签名算法 signature algorithm</h2>

<p>RSA，DSA，ECDSA (secp256r1 , ed25519) 等</p>

<p>三大公钥体制：RSA，DSA，ECDSA
RSA目前是主流，占据绝大多数市场份额
DSA已经被废弃
ECDSA是未来的趋势，例如bitcoin就用ECDSA
<a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/</a>
<a href="https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/">https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/</a></p>

<a name="L8.....................key.derivation.function"></a>
<h2>8. 密码衍生函数 key derivation function</h2>

<p> TLS-12-PRF(SHA-256) , bcrypto，scrypto，pbkdf2 等</p>

<p>hkdf：        <a href="http://tools.ietf.org/html/rfc5869">http://tools.ietf.org/html/rfc5869</a>
<a href="https://cryptography.io/en/latest/hazmat/primitives/key-derivation-functions/">https://cryptography.io/en/latest/hazmat/primitives/key-derivation-functions/</a></p>

<a name="L9.....................random.number.generators"></a>
<h2>9. 随机数生成器 random number generators</h2>

<p>  /dev/urandom 等</p>

<p><a href="https://blog.helong.info//blog/2015/06/05/modern-crypto/">现代密码学实践指南[2015年]</a></p>

<a name="L...................."></a>
<h1>八. 参考文献：</h1>

<a name="TLS.SSL.......RFC........."></a>
<h3>TLS/SSL 相关RFC及标准</h3>

<ul>
<li><a href="https://tools.ietf.org/html/rfc5246">TLS 1.2</a></li>
<li><a href="https://github.com/tlswg/tls13-spec">TLS 1.3 draft specification</a></li>
<li><a href="https://tools.ietf.org/html/rfc5288">AES GCM for TLS</a></li>
<li><a href="https://tools.ietf.org/html/rfc4492">ECC cipher suites for TLS</a></li>
<li><a href="https://tools.ietf.org/html/rfc6066">TLS extensions</a></li>
<li><a href="https://tools.ietf.org/html/rfc7301">Application-Layer Protocol Negotiation Extension</a></li>
<li><a href="https://tools.ietf.org/html/rfc4210">X.509 PKI</a></li>
<li><a href="https://tools.ietf.org/html/rfc5280">X.509 PKI and CRLs</a></li>
<li><a href="http://csrc.nist.gov/groups/ST/toolkit/index.html">美国国家标准局NIST 的密码学标准</a></li>
<li><a href="http://csrc.nist.gov/publications/nistpubs/800-90A/SP800-90A.pdf">NIST SP 800-90A </a></li>
<li><a href="https://www.nsa.gov/ia/programs/suiteb_cryptography/">nsa 的 SuiteB 密码学标准</a></li>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS on wikipedia</a></li>
</ul>


<a name="L.................."></a>
<h3>协议分析文章</h3>

<ul>
<li><a href="http://www.root.org/talks/TLS_Design20071129_2.pdf">http://www.root.org/talks/TLS_Design20071129_2.pdf</a></li>
<li><a href="http://www-brs.ub.ruhr-uni-bochum.de/netahtml/HSS/Diss/MeyerChristopher/diss.pdf">20 Years of SSL/TLS Research An Analysis of the Internet&rsquo;s Security Foundation</a></li>
<li><a href="https://www.slideshare.net/yassl/securing-data-in-transit">https://www.slideshare.net/yassl/securing-data-in-transit</a></li>
<li><a href="http://security.stackexchange.com/questions/20803/how-does-ssl-tls-work">http://security.stackexchange.com/questions/20803/how-does-ssl-tls-work</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/cc785811(v=ws.10">SSL/TLS in Detail</a>.aspx>)</li>
<li><a href="http://www.spiegel.de/media/media-35511.pdf">SSL/TLS</a></li>
<li><a href="https://hynek.me/talks/tls/">The Sorry State Of SSL</a></li>
<li><a href="http://hyperelliptic.org/internetcrypto/OpenSSLPresentation.pdf">What&rsquo;s the matter with TLS?</a></li>
<li><a href="http://blog.csdn.net/CaesarZou/article/details/9331993">http://blog.csdn.net/CaesarZou/article/details/9331993</a></li>
<li>&lt;tools.ietf.org/html/rfc4210>)</li>
<li><a href="https://tools.ietf.org/html/rfc5280">X.509 PKI and CRLs</a></li>
<li><a href="http://luca.ntop.org/Teaching/Appunti/asn1.html">Layman&rsquo;s Guide to ASN.1</a></li>
</ul>


<a name="L........................"></a>
<h3>实际部署调优相关</h3>

<ul>
<li><a href="https://bit.ly/gottls">https://bit.ly/gottls</a></li>
<li><a href="https://istlsfastyet.com/">https://istlsfastyet.com/</a></li>
<li><a href="https://www.imperialviolet.org/">https://www.imperialviolet.org/</a></li>
<li><a href="https://letsencrypt.org/">https://letsencrypt.org/</a></li>
<li><a href="http://chimera.labs.oreilly.com/books/1230000000545/ch04.to/crypto.html">http://chimera.labs.oreilly.com/books/1230000000545/ch04.to/crypto.html</a></li>
<li><a href="http://www.rsaconference.com/writable/presentations/file_upload/dsp-f03-new-trends-in-cryptographic-algorithm-suites-used-for-tls-communications.pdf">RSA Conference 2015 : New Trends In Cryptographic Algorithm Suites Used For TLS Communications</a></li>
</ul>


<a name="L..............."></a>
<h3>密码学相关</h3>

<ul>
<li><a href="https://www.coursera.org/course/crypto">Stanford Cryptography open course</a></li>
<li><a href="http://crypto101.io">crypto101，一本很棒的开源电子书</a></li>
<li><a href="https://book.douban.com/subject/1172109/">现代密码学理论与实践</a> - 毛文波</li>
<li><a href="http://book.douban.com/subject/5954556/">现代密码学:原理与协议</a> - Katz and Lindell</li>
<li><a href="http://saweis.net/pdfs/weis-modern-crypto-defcon-2015.pdf">&ldquo;Modern Crypto: 15 Years of Advancement in Cryptography&rdquo;  &ndash; 2015 defcon 大会Steve Weis 演讲</a></li>
<li>强烈建议不要看90年代的书，普遍严重过时，比如《应用密码学：协议、算法与C源程序（原书第2版）》</li>
<li><a href="http://cr.yp.to/crypto.html">DJBs crypto page</a></li>
<li><a href="http://blog.cr.yp.to/20140205-entropy.html">DJBs entropy attacks</a></li>
<li><a href="https://gist.github.com/tqbf/be58d2d39690c3b366ad">Cryptographic Right Answers</a></li>
<li><a href="http://www.slideshare.net/yassl/securing-data-in-transit">http://www.slideshare.net/yassl/securing-data-in-transit</a></li>
<li>[Schneier 关于密码学2010年现状的评述]( &lt;<a href="https://www.schneier.com/blog/archives/2013/07/is_cryptography.html">https://www.schneier.com/blog/archives/2013/07/is_cryptography.html</a>)</li>
<li><a href="http://security.stackexchange.com/questions/2202/lessons-learned-and-misconceptions-regarding-encryption-and-cryptology">http://security.stackexchange.com/questions/2202/lessons-learned-and-misconceptions-regarding-encryption-and-cryptology</a></li>
<li><a href="http://chargen.matasano.com/chargen/2009/7/22/if-youre-typing-the-letters-a-e-s-into-your-code-youre-doing.html">http://chargen.matasano.com/chargen/2009/7/22/if-youre-typing-the-letters-a-e-s-into-your-code-youre-doing.html</a></li>
<li><a href="http://kodu.ut.ee/~swen/publications/articles/laur-thesis-binded.pdf">http://kodu.ut.ee/~swen/publications/articles/laur-thesis-binded.pdf</a></li>
<li><a href="https://www.enisa.europa.eu/activities/identity-and-trust/library/deliverables/study-on-cryptographic-protocols">https://www.enisa.europa.eu/activities/identity-and-trust/library/deliverables/study-on-cryptographic-protocols</a></li>
<li><a href="https://github.com/sweis/crypto-might-not-suck">https://github.com/sweis/crypto-might-not-suck</a></li>
<li><a href="http://pages.uoregon.edu/joe/crypto-bcp/crypto-bcp.pdf">Cryptographic Best Practices in the Post-Snowden Era</a></li>
<li><a href="http://en.wikipedia.org/wiki/Crypto_Wars">Crypto War</a></li>
<li><a href="http://www.cs.bris.ac.uk/Research/CryptographySecurity/knowledge.html">52 Things People Should Know To Do Cryptography</a></li>
<li><a href="http://bristolcrypto.blogspot.com/">http://bristolcrypto.blogspot.com/</a></li>
<li><a href="https://www.schneier.com/">https://www.schneier.com/</a></li>
<li><a href="https://www.imperialviolet.org/2015/05/16/aeads.html">https://www.imperialviolet.org/2015/05/16/aeads.html</a></li>
<li><a href="https://crypto.stanford.edu/~dabo/cryptobook/draft_0_2.pdf">https://crypto.stanford.edu/~dabo/cryptobook/draft_0_2.pdf</a></li>
<li><a href="http://saweis.net/pdfs/weis-modern-crypto-defcon-2015.pdf">http://saweis.net/pdfs/weis-modern-crypto-defcon-2015.pdf</a></li>
</ul>


<a name="L.................."></a>
<h3>相关开源项目</h3>

<ul>
<li><a href="http://golang.org/pkg/crypto/tls/">GoTLS</a> - go语言自己搞的 TLS 协议实现</li>
<li><a href="https://www.openssl.org/">OpenSSL</a> - 事实上的标准</li>
<li><a href="http://www.libressl.org/">LibreSSL</a> - OpenBSD搞的OpenSSL的分支，代码可读性大大提高</li>
<li><a href="https://boringssl.googlesource.com/boringssl/">BoringSSL</a> - Google Security team 维护的OpenSSL分支</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS">NSS</a> - Mozilla 维护的TLS协议实现</li>
<li><a href="https://github.com/awslabs/s2n/">s2n</a> - Amazon搞的tls协议实现</li>
<li><a href="http://www.mitls.org/wsgi/home">MiTLS</a> ,  <a href="http://www.mitls.org/wsgi/tls-attacks">TLS Attacks</a></li>
<li><a href="http://nacl.cr.yp.to/">NaCL</a> and <a href="https://github.com/jedisct1/libsodium">libsodium</a></li>
<li><a href="http://www.tarsnap.com/spiped.html">spiped</a></li>
</ul>


<p><embed src="//music.163.com/style/swf/widget.swf?sid=4236464&type=2&auto=0&width=320&height=66" width="340" height="86"  allowNetworking="all"></embed></p>

<!--
![][pay_me_ad]
![][pay_me]
-->


<hr />
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[现代密码学实践指南[2015年]]]></title>
    <link href="https://blog.helong.info//blog/2015/06/05/modern-crypto/"/>
    <updated>2015-06-05T22:32:55+00:00</updated>
    <id>https://blog.helong.info//blog/2015/06/05/modern-crypto</id>
    <content type="html"><![CDATA[<hr />

<p>本文介绍目前现代密码学的最先进技术，
前半部分主要翻译自  <a href="https://gist.github.com/tqbf/be58d2d39690c3b366ad">《Cryptographic Right Answers》</a>，附上收集的资料，和byron个人的理解。</p>

<p>密码学理论艰深，概念繁多，本人知识水平有限，错误难免，如果您发现错误，请务必指出，非常感谢!</p>

<hr />

<a name="L...................................................................................."></a>
<h5>下文分类介绍在各种适用场景下，你应该使用的现代密码学算法</h5>

<a name="L1....strong...............strong..:"></a>
<h3>1.  <strong>加密数据</strong> :</h3>

<p>按照优先级，应该选择:</p>

<p>(1)   首选 NaCl库，或者libsodium库，使用里面的crypto_secretbox()/crypto_secretbox_open() 函数
(2)   Chacha20-Poly1305 算法
(3)   AES-GCM 算法</p>

<p>适用场景:当你需要避免把明文数据在网络上传输的时候。</p>

<p>以上3种算法，都是AEAD类的算法，AEAD是2015年最好的选择。
其中的(2)和(3)在结构上类似：一个流加密模式的算法，配合一个多项式结构的MAC。
(2)是一个流加密算法，配合一个为通用cpu优化的MAC算法，
对密码学库的实现者来说，Poly1305也比GCM更容易安全地实现。
AES-GCM是工业标准(TLS目前主要用的就是AES-GCM)，现代CPU通常都有专门为AES-GCM设计的硬件指令，但是在没有硬件指令支持的CPU上(比如32位的arm)，(3)性能低于(2)。</p>

<!--more-->


<p>此外，应该</p>

<ul>
<li>避免AES-CBC(说来话长，后文有解释)</li>
<li>避免AES-CTR</li>
<li>避免64bit块大小的块加密算法&ndash;(说的就是你&ndash;BlowFish)</li>
<li>避免OFB模式</li>
<li>不要使用RC4，RC4已经被攻破</li>
</ul>


<a name="L2....strong.....................strong..:"></a>
<h3>2.  <strong>对称密钥长度</strong> :</h3>

<p>选择使用256bit长度的密钥</p>

<p>适用场景：只要你在使用密码学，你就应该注意<strong>对称密钥长度</strong></p>

<p>请记住：不要把对称加密（如AES）的key长度，和非对称加密(如RSA)的key长度搞混淆了，对称加密的key通常比非对称加密的key短多了。</p>

<p>下表对比了相同安全程度时，不同算法的密钥长度，单位:bit</p>

<table>
<thead>
<tr>
<th> Symmetric</th>
<th>   ECC   </th>
<th>DH/DSA/RSA</th>
</tr>
</thead>
<tbody>
<tr>
<td>   80     </td>
<td>   163   </td>
<td>     1024 </td>
</tr>
<tr>
<td>  112     </td>
<td>   233   </td>
<td>     2048 </td>
</tr>
<tr>
<td>  128     </td>
<td>   283   </td>
<td>     3072 </td>
</tr>
<tr>
<td>  192     </td>
<td>   409   </td>
<td>     7680 </td>
</tr>
<tr>
<td>  256     </td>
<td>   571   </td>
<td>    15360 </td>
</tr>
</tbody>
</table>


<p>此外，应该</p>

<ul>
<li>避免使用巨大key的算法(使用远大于256的key，只能说明使用者没有安全概念)</li>
<li>避免把多个加密算法串联叠加起来使用，这并没有什么卵用</li>
<li>避免128bit以下的key长度(比如，哥们求你别再提DES这种56bit密钥的古董了)</li>
</ul>


<a name="L3....strong...............strong.:"></a>
<h3>3.  <strong>对称签名</strong>:</h3>

<p>应该选择 HMAC 类的算法</p>

<p>适用场景：安全加固一个API，如各种开放API的调用方认证</p>

<p>如果对一个API，你需要做认证(authenticating)，但是不需要做加密(encrypting)，记得千万不要自己发明算法，你自己发明的MAC算法基本都有安全漏洞，如果不信，请Google一下 &ldquo;长度扩展攻击&rdquo;
<a href="http://en.wikipedia.org/wiki/Length_extension_attack">长度扩展攻击</a>
<a href="http://netifera.com/research/flickr_api_signature_forgery.pdf">Flickr的漏洞案例</a></p>

<p>同时，必须要注意的是，要使用一个<strong>常数时间字符串对比算法</strong>（这个地方和码农的常识完全相反，请务必留意）</p>

<p>此外，应该</p>

<ul>
<li>避免自行设计的“带密码的hash”结构，你的设计基本都是有安全漏洞的</li>
<li>避免HMAC-MD5，避免HMAC-SHA1，使用HMAC-SHA256, HMAC-SHA512等</li>
<li>避免复杂的多项式MAC</li>
<li>避免加密hash值的结构</li>
<li>避免CRC</li>
</ul>


<a name="L4....strong.Hashing.HMAC.........strong."></a>
<h3>4.  <strong>Hashing/HMAC 算法</strong></h3>

<p>应该选择<a href="http://en.wikipedia.org/wiki/SHA-2">SHA2</a>类的算法:: SHA-256, SHA-384, SHA-512, SHA-512/256</p>

<p>优先使用 SHA-512/256，SHA-512/256这个算法把 SHA-512 的512bit输出截短到256bit，避开了length extension 攻击。
同时，目前SHA-2是很安全可靠的，你不需要升级到SHA-3.</p>

<p>此外，应该</p>

<ul>
<li>避免SHA-1</li>
<li>避免MD5</li>
<li>避免MD6</li>
</ul>


<a name="L5....strong.......ID..strong."></a>
<h3>5.  <strong>随机ID</strong></h3>

<p>应该使用256 bit的随机值</p>

<p>一定要使用 /dev/urandom，请认准这个</p>

<p>此外，应该</p>

<ul>
<li>避免用户空间的随机数生成器如:havaged,prngs,egd,等</li>
<li>避免/dev/random</li>
</ul>


<a name="L6....strong...............strong."></a>
<h3>6.  <strong>密码处理</strong></h3>

<p>按照优先级顺序,选择：</p>

<ul>
<li>scrypt</li>
<li>bcrypt</li>
<li>如果以上2个都没有，那就用PBKDF2</li>
</ul>


<p>此外，应该</p>

<ul>
<li>避免直接SHA-2</li>
<li>避免直接SHA-1</li>
<li>避免直接MD5</li>
</ul>


<a name="L7....strong..................strong."></a>
<h3>7.  <strong>非对称加密</strong></h3>

<p>应该使用NaCl库</p>

<p>适用场景：当你需要加密消息，发给陌生人，并且对方异步接收消息，做离线解密时。这是一个很窄的应用案例，这种用法有个名字叫<em>电子信封(digital envelope)</em>，典型比如gpg加密文件后发送。</p>

<p>这条是几条之中最难做正确的，不要使用底层的密码学库，比如OpenSSL或者BouncyCastle。</p>

<p>你应该停止使用RSA，并且切换到椭圆曲线类体制，原因是：</p>

<ul>
<li>对RSA的攻击能力的进步 &mdash; 定义在传统质数域上的乘法运算(应用包括DH,DSA,ElGamal等)，要比椭圆曲线域上的乘法运算快得多。这是由于质数域上数域筛法（number field sieve,NFS）的进展，而在椭圆曲线域上，没有NFS这类算法。</li>
<li>RSA (和DH) 或迫使你考虑“向后兼容性”，而椭圆曲线体制没有这种兼容性包袱。TLS最近的几个安全漏洞，部分愿意也是由于这种向后兼容性，导致已经被破解的陈旧算法存在</li>
<li>RSA在一般场景中，都是直接用公钥做非对称加密，这种用法丧失了<strong>前向安全性(Perfect Forward Secrecy)</strong>。而椭圆曲线就不提倡，也很难这样使用，这样你就不会害死自己了。</li>
<li>在椭圆曲线体制下，保证正确性和安全性的重任，主要由密码学家承担，密码学家会提供一组曲线参数，在某一性能水平下，针对安全性和性能做优化。这样程序员不容易误用而害死自己。在RSA体制下，正好相反，程序员必须提供参数来保证正确性和安全性，就算是RSA-OAEP这种很好的设计，程序员也必须知道怎么提供参数，这样程序员很容易搞错。</li>
</ul>


<p>如果你必须使用RSA，一定要使用RSA-OAEP with SHA256，指数使用 65537</p>

<ul>
<li>避免 RSA-PKCS1v15</li>
<li>避免 ElGamal</li>
<li>避免 RSA</li>
</ul>


<a name="L8....strong..................strong."></a>
<h3>8.  <strong>非对称签名</strong></h3>

<p>应该使用NaCl，Ed25519，或者RFC6979</p>

<p>应用场景：如果你在设计一种新的比特币，或者一个给Ruby Gems或者Vagrant imges文件签名的系统，或者数字版权保护系统(DRM)，其中一系列的文件需要离线做认证；
或者你在设计一个加密消息传输层</p>

<p>上一条的内容在此处全部适用。</p>

<p>在10+年做付费软件安全评估的工作经历中，我只有屈指可数的几次，遇到使用RSA-PSS的用户，RSA-PSS是一个学术界的推荐算法。</p>

<p>过去10年，非对称签名最主要的应用场景是比特币，和前向安全的密钥协商（TLS协议里面的ECDHE）。
其中最主要的算法全都是基于椭圆曲线体制的。务必警惕新出现的使用RSA签名的系统，很有可能有问题。</p>

<p>在过去几年中，业界有一种趋势：放弃传统DSA签名，改为难以误用的<strong>确定性签名体制</strong>，其中的EdDSA(不要和ECDSA搞混了喂！)和RFC6979是最好的例子。这种趋势的主要是受到2010年索尼PlayStation 3的 ECDSA私钥被破解事件的影响，在这个案例中，索尼公司的码农错误地把一个随机数重复使用来做ECDSA签名，形成了漏洞，使得破解者据此直接把私钥算出来了。<strong>确定性签名体制</strong>在设计中不再依赖随机数生成器，因此彻底避开此类误用。所以你应该优先使用确定性签名体制。</p>

<ul>
<li>避免RSA-PKCS1v15，避免RSA，避免ECDSA，避免DSA</li>
<li>特别要避免常规的DSA和ECDSA</li>
</ul>


<a name="L9....strong.Diffie-Hellman...............strong."></a>
<h3>9.  <strong>Diffie-Hellman 密钥交换</strong></h3>

<p>应该使用NaCl，Curve25519，或者DH-2048</p>

<p>适用场景:<em>如果你在设计加密消息传输系统，并且无法使用固定对称密码</em></p>

<p>这是很棘手的一条，主要考量如下：</p>

<ul>
<li>如果你能使用NaCl库，那就使用NaCl库。你甚至不需要管NaCl是什么。</li>
<li>如果你能使用一个可信赖的第三方库，那就使用Curve25519，这是一条现代的ECDH曲线，有丰富的开源代码，性能经过高度优化，被彻底地安全分析过。并且Curve25519即将进入TLS 1.3版本标准。</li>
<li>但是绝对不要自己实现Curve25519，也绝对不要自己移植Curve25519的C代码</li>
<li>如果你不能使用第三方ECDH库，但是可以使用DH库，那就使用DH-2048，使用1个标准的2048 bit的群。</li>
<li>但是不要使用传统的DH，如果你需要协商DH参数，或者和其他实现互操作</li>
<li>如果你一定要做握手协商，或者和旧软件互操作，那么考虑使用NIST P-256, NIST P-256 有广泛的软件支持。</li>
<li>写死在代码里的DH-2048参数，比NIST P-256更安全。NIST P-256比协商出来的DH更安全。</li>
<li>但是，由于NIST P-256的实现有一些陷阱，所以一定要谨慎选择可信赖的，广泛使用使的第三方库</li>
<li>P-256 可能是NIST曲线中最安全的，不要使用P-224。</li>
</ul>


<p>DH（密钥协商）算法确实很难用，但是它很重要。</p>

<ul>
<li>避免，传统常规的 DH, SRP, J-PAKE 握手和协商</li>
<li>避开任何只使用了块加密算法和srand(time())的密钥协商模式（肯定有漏洞）</li>
</ul>


<a name="L10....strong...............strong."></a>
<h3>10.  <strong>网站安全</strong></h3>

<p>应该使用OpenSSL，或者Google的BoringSSL，或者直接使用 AWS的 ELB</p>

<p>此处网站安全，指的是让网站支持HTTPS协议。
如果你不能把这个任务交给Amazon的云服务去做，把难题留给Amazon去解决，那么OpenSSL目前仍然是正确选择。</p>

<ul>
<li>避免不常见的TLS库，例如polarssl，GnuTLS，MatrixSSL等</li>
</ul>


<a name="L11....strong..........-.........................................strong...."></a>
<h3>11.  <strong>客户端-服务器结构的应用程序的安全</strong>：</h3>

<p>应该使用TLS</p>

<p>适用场景：如果你以为自己理解了前面关于公钥加密的介绍。。。</p>

<p>通常，在你设计了自己的RSA协议之后的1至18个月，你肯定会发现，你犯了某个错误，使你的协议没有任何安全性。
比如Salt Stack，Salt Stack的协议使用了 e=1 的RSA 公钥。。。</p>

<p>听起来，TLS有下面这些黑历史：</p>

<ul>
<li>The Logjam DH negotiation attack</li>
<li>The FREAK export cipher attack</li>
<li>The POODLE CBC oracle attack</li>
<li>The RC4 fiasco</li>
<li>The CRIME compression attack</li>
<li>The Lucky13 CBC padding oracle timing attack</li>
<li>The BEAST CBC chained IV attack</li>
<li>Heartbleed</li>
<li>Renegotiation</li>
<li>Triple Handshakes</li>
<li>Compromised CAs</li>
</ul>


<p>但是，你仍然应该使用TLS做传输协议，因为：</p>

<ul>
<li>这些漏洞中的大部分，仅仅是针对浏览器的，因为他们依赖受害者执行攻击者控制的JavaScript脚本，这些JavaScript脚本生成重复的明文，或特定的明文。</li>
<li>这些漏洞中的大部分，其影响都可以被减轻，只需要你在代码和配置里面写死 TLS v1.2, ECDHE，和 AES-GCM就行。这听起来很棘手，但是这远远没有你自己设计使用ECDHE和AES-GCM的传输协议棘手。</li>
<li><p>在一个自定义的传输协议的场景中，你并不需要依赖CA，你可以用一个自签名证书，嵌入到你的客户端里面。</p></li>
<li><p>不要自己设计加密传输协议，这是<strong>极其困难而易错的工程难题</strong></p></li>
<li>使用TLS，但是不要使用默认配置</li>
</ul>


<a name="L12....strong...............strong."></a>
<h3>12.  <strong>在线备份</strong></h3>

<p>应该使用Tarsnap</p>

<hr />

<a name="L............"></a>
<h1>名词解释</h1>

<p>本文的内容比较新，相关中文资料极少，因此文中的名词对读者可能有点陌生，故byron这里介绍一下文中提到的一些名词：</p>

<a name="L1...NaCl...:"></a>
<h3>1.  NaCl库:</h3>

<p><a href="http://nacl.cr.yp.to/">http://nacl.cr.yp.to/</a>
是密码学学术权威 Daniel J. Bernstein教授 设计的一个密码学算法库，2008年发开始公布。NaCl的特点是：api简洁而易用，高性能，高安全性，主要用于网络通信，加密，解密，签名等，NaCl提供了构建高层密码学工具的核心功能。</p>

<a name="L2...libsodium...:"></a>
<h3>2.  libsodium库:</h3>

<p><a href="https://download.libsodium.org/doc/">https://download.libsodium.org/doc/</a>
libsodium是对NaCl库的一个分支，进一步改进接口易用性，和可移植性。</p>

<a name="L3...AEAD:"></a>
<h3>3.  AEAD:</h3>

<p><a href="https://www.imperialviolet.org/2014/02/27/tlssymmetriccrypto.html">https://www.imperialviolet.org/2014/02/27/tlssymmetriccrypto.html</a>
AEAD的概念:
在通常的密码学应用中，Confidentiality  (保密) 用加密实现，Message authentication (消息认证) 用MAC实现。这两种算法的配合方式，引发了很多安全漏洞，过去曾经有3种方法：1. Encrypt-and-MAC  2.MAC-then-Encrypt 3.Encrypt-then-MAC ，后来发现，1和2都是有安全问题的，所以，2008年起，
逐渐提出了“用一个算法在内部同时实现cipher+MAC”的idea，称为AEAD(Authenticated encryption with additional data)。
在AEAD这种概念里，cipher+MAC 被 一个AEAD算法替换。
<a href="http://en.wikipedia.org/wiki/Authenticated_encryption">http://en.wikipedia.org/wiki/Authenticated_encryption</a></p>

<a name="L4...ChaCha20-poly1305"></a>
<h3>4.  ChaCha20-poly1305</h3>

<p>ChaCha20-poly1305是一种AEAD，提出者是Daniel J. Bernstein教授，针对移动互联网优化，目前Google对移动客户端的所有流量都使用ChaCha20-Poly1305</p>

<a name="L5...AES-GCM"></a>
<h3>5.  AES-GCM</h3>

<p>AES-GCM是一种AEAD，是目前TLS的主力算法，互联网上https流量的大部分依赖使用AES-GCM。</p>

<a name="L6...AES-GCM...ChaCha20-Poly1305...........................:"></a>
<h3>6.  AES-GCM和ChaCha20-Poly1305的性能对比测试结果:</h3>

<table>
<thead>
<tr>
<th> Chip  </th>
<th style="text-align:center;"> AES-128-GCM speed </th>
<th style="text-align:center;"> ChaCha20-Poly1305 speed   </th>
</tr>
</thead>
<tbody>
<tr>
<td> OMAP 4460 </td>
<td style="text-align:center;"> 24.1 MB/s     </td>
<td style="text-align:center;"> 75.3 MB/s </td>
</tr>
<tr>
<td> Snapdragon S4 Pro </td>
<td style="text-align:center;">41.5 MB/s  </td>
<td style="text-align:center;">   130.9 MB/s  </td>
</tr>
<tr>
<td> Sandy Bridge Xeon (AESNI) </td>
<td style="text-align:center;">900 MB/s   </td>
<td style="text-align:center;">   500 MB/s    </td>
</tr>
</tbody>
</table>


<a name="L7...AES-CBC"></a>
<h3>7.  AES-CBC</h3>

<p>关于AES-CBC，在AES-GCM流行之前，TLS主要依赖AES-CBC，而由于历史原因，TLS在设计之初固定选择了MAC-then-Encrypt结构，AES-CBC和MAC-then-encrypt结合，为选择密文攻击(CCA)创造了便利条件，TLS历史上有多个漏洞都和CBC模式有关：</p>

<ul>
<li>The POODLE CBC oracle attack:参考:
<a href="http://www.thoughtcrime.org/blog/the-cryptographic-doom-principle/">1.POODLE的一个分析</a>
<a href="https://www.openssl.org/~bodo/tls-cbc.txt">2.openssl的分析</a>
<a href="http://drops.wooyun.org/papers/3194">3.乌云的文章</a></li>
<li>The CRIME compression attack:</li>
<li>The Lucky13 CBC padding oracle timing attack:</li>
<li>The BEAST CBC chained IV attack:</li>
</ul>


<a name="L8...SHA2"></a>
<h3>8.  SHA2</h3>

<p><a href="http://en.wikipedia.org/wiki/SHA-2">http://en.wikipedia.org/wiki/SHA-2</a></p>

<a name="L9...Curve25519"></a>
<h3>9.  Curve25519</h3>

<p><a href="http://cr.yp.to/ecdh.html">http://cr.yp.to/ecdh.html</a>
Curve25519 是目前最高水平的 Diffie-Hellman函数，适用于广泛的场景，由Daniel J. Bernstein教授设计。由于NIST P-256的设计过程不透明，有来历不明的参数，被广泛怀疑有后门，所以设计了Curve25519，Curve25519的设计过程完全公开，没有任何来历不明的参数。
部署情况：<a href="http://ianix.com/pub/curve25519-deployment.html">http://ianix.com/pub/curve25519-deployment.html</a></p>

<a name="L10...Ed25519"></a>
<h3>10.  Ed25519</h3>

<p><a href="http://ed25519.cr.yp.to/">http://ed25519.cr.yp.to/</a>
Ed25519是一个数字签名算法，</p>

<ul>
<li>签名和验证的性能都极高， 一个4核2.4GHz 的 Westmere cpu，每秒可以验证 71000 个签名</li>
<li>安全性极高，等价于RSA约3000-bit</li>
<li>签名过程不依赖随机数生成器，不依赖hash函数的防碰撞性，没有时间通道攻击的问题</li>
<li>并且签名很小，只有64字节，公钥也很小，只有32字节。
部署情况：<a href="http://ianix.com/pub/ed25519-deployment.html">http://ianix.com/pub/ed25519-deployment.html</a></li>
</ul>


<a name="L11.................."></a>
<h3>11.  前向安全性</h3>

<p>前向安全性( Perfect Forward Secrecy )
<a href="http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html">http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html</a>
前向安全性指的是，如果攻击者抓取并保存流量，那么将来私钥泄露后，攻击者也无法利用泄露的私钥解密这些流量。</p>

<a name="L12...Diffie-Hellman............."></a>
<h3>12.  Diffie-Hellman 密钥交换</h3>

<p><a href="http://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">http://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange</a>
在任何一本密码学教材里面都会重点介绍的</p>

<a name="L13...constant.time.compare"></a>
<h3>13.  constant time compare</h3>

<p>针对Timing attack，<a href="http://en.wikipedia.org/wiki/Timing_attack">http://en.wikipedia.org/wiki/Timing_attack</a> （这种攻击真是脑洞大开！）
当一个算法的运行时间和输入数据有关的时候，可以根据运行时间这一信息，破解出密钥等。
典型的，比如要验证一个对称签名，如果你用了C库里面的memcmp()，那你就会被timing attack方式攻击。
因此，涉及到密码学数据的memcmp，必须要用运行时间和输入无关的函数，比如OpenSSL库里面的<code>CRYPTO_memcmp()</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nginx下配置高性能，高安全性的https TLS服务]]></title>
    <link href="https://blog.helong.info//blog/2015/05/08/https-config-optimize-in-nginx/"/>
    <updated>2015-05-08T20:32:55+00:00</updated>
    <id>https://blog.helong.info//blog/2015/05/08/https-config-optimize-in-nginx</id>
    <content type="html"><![CDATA[<p>下文以nginx为例，介绍如何部署一个高性能，高安全性的https服务器。</p>

<p>并附送一个优化出来的openssl编译脚本，可以编译出一个高性能，高安全性的openssl库，您可以直接复制粘贴使用。</p>

<p>此处直接给出实践指导，后续再写文章解释tls协议的这些原理细节。</p>

<p>nginx下https配置的优化点，主要有:</p>

<ol>
<li>session ticket</li>
<li>session id cache</li>
<li>ocsp stapling</li>
<li>http KeepAlive</li>
<li>ECDHE等ciphersuite优化</li>
<li>openssl 编译优化</li>
</ol>


<a name="L.......nginx.https........."></a>
<h3>一， nginx https的配置</h3>

<p>先贴一下nginx配置，如下。</p>

<p>是根据<a href="https://wiki.mozilla.org/Security/Server_Side_TLS#Nginx">mozilla的权威文档</a>
,和<a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">生成工具</a>(选择 nginx，intermediate ) 生成的配置为基础，加入session ticket等配置的结果</p>

<!--more-->




<figure class='code'><figcaption><span>tls_nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">server</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">listen</span> <span class="mi">443</span> <span class="n">ssl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp"># certs sent to the client in SERVER HELLO are concatenated in ssl_certificate</span>
</span><span class='line'>    <span class="n">ssl_certificate</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">signed_cert_plus_intermediates</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_certificate_key</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">private_key</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_session_timeout</span> <span class="mi">1</span><span class="n">d</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_session_cache</span> <span class="nl">shared</span><span class="p">:</span><span class="nl">SSL</span><span class="p">:</span><span class="mi">50</span><span class="n">m</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ssl_session_ticket_key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">tls_session_ticket</span><span class="p">.</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_session_tickets</span> <span class="n">on</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">keepalive_timeout</span> <span class="mi">75</span><span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp"># Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits</span>
</span><span class='line'>    <span class="n">ssl_dhparam</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">dhparam</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp"># intermediate configuration. tweak to your needs.</span>
</span><span class='line'>    <span class="n">ssl_protocols</span> <span class="n">TLSv1</span> <span class="n">TLSv1</span><span class="mf">.1</span> <span class="n">TLSv1</span><span class="mf">.2</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_ciphers</span> <span class="err">&#39;</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">kEDH</span><span class="o">+</span><span class="nl">AESGCM</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="nl">AES</span><span class="p">:</span><span class="nl">CAMELLIA</span><span class="p">:</span><span class="n">DES</span><span class="o">-</span><span class="n">CBC3</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="o">!</span><span class="nl">aNULL</span><span class="p">:</span><span class="o">!</span><span class="nl">eNULL</span><span class="p">:</span><span class="o">!</span><span class="nl">EXPORT</span><span class="p">:</span><span class="o">!</span><span class="nl">DES</span><span class="p">:</span><span class="o">!</span><span class="nl">RC4</span><span class="p">:</span><span class="o">!</span><span class="nl">MD5</span><span class="p">:</span><span class="o">!</span><span class="nl">PSK</span><span class="p">:</span><span class="o">!</span><span class="nl">aECDH</span><span class="p">:</span><span class="o">!</span><span class="n">EDH</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">DES</span><span class="o">-</span><span class="n">CBC3</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="o">!</span><span class="n">EDH</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">DES</span><span class="o">-</span><span class="n">CBC3</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="o">!</span><span class="n">KRB5</span><span class="o">-</span><span class="n">DES</span><span class="o">-</span><span class="n">CBC3</span><span class="o">-</span><span class="n">SHA</span><span class="err">&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_prefer_server_ciphers</span> <span class="n">on</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp"># HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)</span>
</span><span class='line'>    <span class="n">add_header</span> <span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span> <span class="n">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">15768000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp"># OCSP Stapling ---</span>
</span><span class='line'>    <span class="cp"># fetch OCSP records from URL in ssl_certificate and cache them</span>
</span><span class='line'>    <span class="n">ssl_stapling</span> <span class="n">on</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ssl_stapling_verify</span> <span class="n">on</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">## verify chain of trust of OCSP response using Root CA and Intermediate certs</span>
</span><span class='line'>    <span class="n">ssl_trusted_certificate</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">signed_cert_plus_intermediates</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resolver</span> <span class="mf">114.114.114.114</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">....</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L..............................."></a>
<h3>二， 其中的几个配置项</h3>

<a name="L1...path.to.signed_cert_plus_intermediates"></a>
<h5>1. /path/to/signed_cert_plus_intermediates</h5>

<p>是你的证书链，就是ca签署之后发给你的文件，是一串这样的内容</p>

<figure class='code'><figcaption><span>tls_nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</span><span class='line'><span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L2...path.to.private_key"></a>
<h5>2. /path/to/private_key</h5>

<p>是你的私钥，一定要保密，最好chown+chmod限制只有http server可以读取！内容大致是：</p>

<figure class='code'><figcaption><span>tls_nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L3...path.to.dhparam.pem"></a>
<h5>3. /path/to/dhparam.pem</h5>

<p>是dhe密钥协商的参数，生成方法：</p>

<pre><code>     openssl  dhparam -out dhparam.pem 2048
</code></pre>

<a name="L4...etc.nginx.conf.d.tls_session_ticket.key"></a>
<h5>4. /etc/nginx/conf.d/tls_session_ticket.key</h5>

<p>是用来加解密session ticket的密码文件，这个文件的安全等级应该和私钥一样，最好chmod+chown限制只有http server能读取。 生成方法:</p>

<pre><code>     openssl rand 48 &gt; tls_session_ticket.key
</code></pre>

<p>最好定期（比如2天一次）轮换，配置文件里把新的key文件放在最前面，旧的在下面，如下</p>

<pre><code>    ssl_session_ticket_key current.key;
    ssl_session_ticket_key previous.key;
</code></pre>

<a name="L5..ssl_trusted_certificate..path.to.signed_cert_plus_intermediates"></a>
<h5>5. ssl_trusted_certificate /path/to/signed_cert_plus_intermediates</h5>

<p>ssl_trusted_certificate，是用来验证ocsp响应的各个ca证书+中级证书，和信任的ca根证书列表。当用来验证ocsp响应的时候，应该配置为你的ca根证书+和中级ca证书的列表，此处可以简单和ssl_certificate使用同一个证书列表文件。<br/>
其中当需要使用tls的客户端认证的时候（大多数https server都用不到客户端认证），需要指定信任的ca根证书列表文件, 这个文件在centos里面是/etc/ssl/certs/ca-bundle.trust.crt 这个文件。</p>

<p>配置完成之后，使用ssllabs的这个在线检查工具<a href="https://www.ssllabs.com/ssltest/analyze.html">https://www.ssllabs.com/ssltest/analyze.html</a> 做检查，里面提出的警告，都需要改正。</p>

<a name="L........openssl............"></a>
<h3>三，  openssl编译优化</h3>

<p>主流的https server，都是依赖openssl来提供tls协议，openssl本身代码复杂，概念繁多，最近对这方面做了研究，下面是一个深入分析过后的最优化编译配置，可以编译出一个高性能，高安全性的openssl版本，您可以直接复制粘贴使用。</p>

<p>openssl请使用最新的1.0.2a版本，这个版本有intel针对ecdh p256曲线的优化，编译脚本见本文末尾。</p>

<p>编译好之后，需要让nginx使用我们编译的这个openssl库，在centos下，可以用LD_LIBRARY_PATH的办法：</p>

<pre><code>sudo vim /usr/lib/systemd/system/nginx.service
</code></pre>

<p>在其中添加一行Environment，如下：</p>

<pre><code>[Service]
...
Environment=LD_LIBRARY_PATH=/usr/local/bin/openssl-1.0.2a_64_build/lib/
ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf
...
</code></pre>

<p>其中的路径，请自行修改。</p>

<p>还需要创建软连接，解决so库版本号的问题，如下</p>

<pre><code>ln -s libcrypto.so.1.0.0 libcrypto.so.10
ln -s libssl.so.1.0.0 libssl.so.10
</code></pre>

<p>脚本中包含了一个cloudflare的patch，增加chacha20_poly1305 cipher，使用了这个patch之后，可以使用<a href="https://github.com/cloudflare/sslconfig/blob/master/conf">cloudflare的ciphers配置</a></p>

<p><a href="https://github.com/byronhe/modern-crypto-toolbox/blob/master/build_openssl.sh">https://github.com/byronhe/modern-crypto-toolbox/blob/master/build_openssl.sh</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[【翻译】密码学一小时必知]]></title>
    <link href="https://blog.helong.info//blog/2015/04/12/translate-Everything-you-need-to-know-about-cryptgraphy-in-1-hour/"/>
    <updated>2015-04-12T14:05:55+00:00</updated>
    <id>https://blog.helong.info//blog/2015/04/12/translate-Everything-you-need-to-know-about-cryptgraphy-in-1-hour</id>
    <content type="html"><![CDATA[<p>本文翻译了Colin Percival 于2010年在bsdcan的演讲ppt</p>

<p>原文标题：Everything you need to know about cryptography in 1 hour</p>

<p>演讲时间：May 13, 2010</p>

<p>原文在 <a href="https://www.bsdcan.org/2010/schedule/attachments/135_crypto1hr.pdf">https://www.bsdcan.org/2010/schedule/attachments/135_crypto1hr.pdf</a></p>

<p>演讲视频在 <a href="https://www.youtube.com/watch?v=jzY3m5Kv7Y8">https://www.youtube.com/watch?v=jzY3m5Kv7Y8</a> ( 请自行翻墙 )</p>

<p>Colin Percival 是密码学方面的专家，FreeBSD项目的安全长官，Tarsnap在线备份服务的创始人，scrypt密钥衍生算法的作者，致力于改进软件中密码学的应用，向程序员传播密码学的正确使用。</p>

<!--more-->


<hr />

<p>为什么要 cryptography in 1 hour：</p>

<p>因为有例如下面这些错误的使用案例：</p>

<ol>
<li><p>Google keyczar(时间通道攻击)</p></li>
<li><p>SSL( session renegotiation)</p></li>
<li><p>Amazon AWS 签名方法 (可能碰撞的签名算法)</p></li>
<li><p>Flicker API 签名(hash length-extension) 错误地使用了错误的工具</p></li>
<li><p>Intel Hyper Threading (architectual side channel) 不常用的环境</p></li>
<li><p>WEP,WPA,GSM&hellip;（多种漏洞）</p></li>
</ol>


<p>密码学被攻破通常是由于：</p>

<ol>
<li><p>愚蠢</p></li>
<li><p>使用了错误的工具，或者以错误的方式使用它们</p></li>
<li><p>不常用的环境</p></li>
</ol>


<hr />

<p>经验智慧：不要亲自写密码学代码！</p>

<ol>
<li>使用SSL做传输</li>
<li>使用GPG保护静止数据</li>
</ol>


<p>&ldquo;如果你在输入A-E-S到你的代码里，你已经开始犯错&rdquo; &ndash; Tomas Ptacek</p>

<p>现实：如果你无论如何都要写密码学代码，你最好知道你在干什么</p>

<p>现实：大多数应用程序只需要众所周知的标准模式的一个子集，而这是很容易保证正确的</p>

<p>55分钟后，你应该：</p>

<p>知道在99%的情况下应该怎么做</p>

<p>知道一些常见的错误在哪里</p>

<p>知道当你在做一些非标准的事情的时候，你真的需要咨询一个密码学专家</p>

<hr />

<p>密码学做保护，并对抗一些攻击，但不能对抗所有攻击：</p>

<p>贿赂，盗窃，敲诈</p>

<p>监狱刑罚</p>

<p>攻击人通常比攻击数据更贵</p>

<p>攻击人通常比攻击数据更危险</p>

<p>数据被拷打时不会开记者招待会来控诉</p>

<p>密码学的目的是强迫美国政府拷打你</p>

<p>希望他们认为你的信息不是这么重要</p>

<hr />

<p>密码学有3个主要目的：<em>加密 Encryption</em> ，<em>认证 Authentication </em>，<em>识别  Identification</em></p>

<ol>
<li>加密阻止恶意者读取你的数据</li>
<li>认证阻止恶意者在不被发现的情况下改动你的数据</li>
<li>识别阻止恶意者假装你</li>
</ol>


<p>有时认证和识别在一个步骤中进行：“这条消息自从我写下它之后没有被篡改”和“我是Colin”
可以替换成“这条消息自从Colin写下它之后没有被改过”</p>

<p>在大多数case里，你需要把2个，或者更多的密码学组件合起来使用</p>

<hr />

<p>概念定义</p>

<ol>
<li>plaintext是我们关心的数据</li>
<li>ciphertext是恶意者可以得到的数据</li>
<li>key用于在这两者之间做转换，有时候我们需要多个key</li>
</ol>


<p>对称密码学就是 ，使用相同的key，来把plaintext转换成ciphertext，和把ciphertext转换成
plaintext</p>

<p>非对称密码学就是，这两个方向的转换使用不同的key</p>

<p>理想的密码学组件并不存在，但是如果一个密码学组件被识别出不理想，一般就认为它是被攻破的</p>

<hr />

<p>hashing</p>

<p>一个理想的hash函数H(x)是一个函数映射，把任意长度的输入映射成n-bit的输出，
保证：</p>

<p><em>抵抗碰撞</em></p>

<p><em>单向</em></p>

<p>抵抗碰撞意味着需要 2<sup>n/2</sup>的时间来找到2个输入，使得它们的hash相同</p>

<p>单向意味着给定hash后，需要2<sup>n</sup>的时间来找到一个输入，使得它的hash是给定hash</p>

<p><em>没有保证任何其他性质</em></p>

<p>特别是：
知道H(x)可能允许一个攻击者计算某些y的H(y)</p>

<hr />

<p>实践：</p>

<p>使用 SHA-256</p>

<p>考虑切换到SHA-3，在未来5-10年内（2010年算起）</p>

<p>使用一个hash，如果你可以安全地分布 H(x)，并且想验证不安全地收到的x'实际上等于x</p>

<p>不要使用：MD2 MD4 MD5 SHA-1 RIPEMD</p>

<p>不要把 FreeBSD-8.0-RELEASE-amd64-disc1.iso和CHECKSUM.SHA256放到同一个FTP
服务器上，还以为自己干了件有用的事情</p>

<p>不要尝试把一个hash函数当成对称签名用</p>

<hr />

<p>对称认证</p>

<p>对称认证是通过提供一个消息认证码（MAC，message authentication code）来进行的。</p>

<p>一个理想的 MAC fk(x)使用一个key，来把任意长度的输入映射到n-bit的输出，确保需要 2<sup>n</sup>
的时间，一个攻击者才能在得到任意(x, fx(x))对的情况下，生成任意(y,fk(y))对。
有时MAC被称作随机函数</p>

<p>与hashing不同，知道fk(x)不能使你对另一个key计算出 fk(y)，</p>

<p> Flicker的API使用了hashing来认证API请求，他们实际需要的是 MAC</p>

<hr />

<p>对称认证</p>

<p>实践</p>

<p>使用 HMAC-SHA256</p>

<p>确保同样的输入，HMAC-SHA256不会生成不同的消息</p>

<p>Amazon和Flicker都做错了</p>

<p>不要使用 CBC-MAC</p>

<p>理论上安全，但是把你的块加密算法暴露给了攻击者</p>

<p>不要使用 Poly1305</p>

<p>太新，除非你是Daniel Bernstein(Poly 1305的发明者)，否则你基本不可能做出一个</p>

<p>安全和正确的实现</p>

<p>不要 当验证一个签名的时候，通过timing side channel的形式泄露信息</p>

<hr />

<p>Side channel 攻击</p>

<p>一个side channel 是攻击者除了ciphertext以外可以获取信息的任何方式</p>

<p>密码系统是以它们的数学设计被定义的，但是side channel 是由于密码系统的人工实现导致的。</p>

<p>最常见的side channel是timing &ndash; 你花费多长时间来 加密/解密/签名/验证 一个消息</p>

<p>其他side channel包括：电磁辐射，电力消耗，和微架构特征（例如L1缓存替换，在支持
HyperThreading的Intel CPU上）</p>

<hr />

<p>Side channel 攻击
实践</p>

<p>咨询一个密码学专家，如果你计划使恶意者可以物理接触到任何密码设备</p>

<p>咨询一个密码学专家，如果你计划允许恶意者在你允许密码学的物理硬件上运行代码(虚拟化系统)</p>

<p>咨询一个密码学专家，如果你计划发布一个以新方式泄露信息的CPU</p>

<p> intel可能做错了
不要写其运行时间泄露信息的代码</p>

<hr />

<p>Timing attacks</p>

<p>避免 依赖于key，或者依赖于plaintext的表查找</p>

<p>不要有依赖于key，或者依赖于plaintext的分支(if, for, while , foo?bar:baz 等代码指令)</p>

<p>不要想这种代码：</p>

<pre><code>for(int i=0;i&lt;MACLEN;i++){
    if(MAC-computed[i] != MAC-received[i])
        return MAC_IS_BAD ;
return  MAC_IS_GOOD;
</code></pre>

<p>应该这样写</p>

<pre><code>for(int i=0;i&lt;MACLEN;i++){
    x  |= (MAC-computed[i] - MAC-received[i]);

return  x?MAC_IS_BAD:MAC_IS_GOOD;
</code></pre>

<p>Google Keyczar就做错了</p>

<hr />

<p>块加密</p>

<p>对称加密通常构建在块加密算法的基础之上</p>

<p>一个理想的块加密算法使用一个key来双向地把n-bit的输入x转换成n-bit的输出Ek(x)，这样当
知道(x,Ek(x))时，对任意的(x',k')!=(x,k)，你没法以大于2^-n的概率猜出(x',Ek'(x'))</p>

<p>有时被称为“随机排列”</p>

<p>通常我们关心的是Ek(x)不透露出 当x!=x'时Ek(x')的信息。</p>

<p>如果一个攻击者可以通过观察一个块加密算法怎么处理不同key，来获取有用信息，该块加密算法
被认为可被  key相关攻击 （key-related attack）攻破。</p>

<hr />

<p>实践：</p>

<p>使用 AES-256</p>

<p>AES-256有related key攻击漏洞，但是当你把其它事情做对时，这并不是问题</p>

<p>AES-128理论上足够强壮，但是块加密算法很难没有side channel地正确实现 ，</p>

<p>并且key里面的额外bit 在key的一些bit泄露之后是有用的。</p>

<p>不要使用 blowfish</p>

<p>想都不要想使用DES</p>

<p>避免 triple-des(3des)</p>

<p>不要使用块加密算法"raw"，替代地，在一个已经建立的操作模式中使用它(?)。</p>

<hr />

<p>块加密算法操作模式</p>

<p>一个块加密算法操作模式告诉你怎么使用一个块加密算法来保护数据流</p>

<p>在很多case中，plaintext需要被填充到块大小的整数倍，块密码算法操作模式会
告诉你怎么做到这一点</p>

<p>流行的模式有: ECB ，CBC  , CFB , OFB，CTR，IAPM，CCM，EAX，GCM &hellip;</p>

<p>大多数模式只提供了加密，但也有一些提供了认证</p>

<p>实践：
使用：CTR模式</p>

<p>不要使用同时提供加密和认证的模式</p>

<p>想都不要想使用ECB</p>

<p>使用一个MAC（例如HMAC-SHA256）来认证你的加密数据</p>

<p>如果你认为你不需要这么做，咨询一个密码学专家，他会告诉你你为什么是错的。</p>

<p>验证你的加密数据的真实性，在你揭秘数据之前。</p>

<hr />

<p>非对称加密</p>

<p>一个非对称加密模式使用一个签名key来把plaintext转换成ciphertext，使用一个认证码来把
ciphertext转化成plaintext或者“错误的签名”</p>

<p>签名key不能从认证key算出，但是认证key可以从签名key算出</p>

<p>ciphertext通常由 plaintext加一个签名构成</p>

<p>如果一个攻击者接触到了验证key，并且可以说服你签名任意的plaintext，那就可以认为这个
非对称加密系统被攻破了。</p>

<hr />

<p>非对称认证</p>

<p>使用 RSASSA-PSS（RSA签名，使用Probabilistic Signature Scheme padding）</p>

<p>使用 2048-bit的RSA key，使用65537作为公钥的公共幂，和SHA256</p>

<p>不要使用 PKCS v1.5 padding</p>

<p>想都不要想 使用不带消息padding的RSA(即RAW)</p>

<p>可能避免： DSA</p>

<p>可能避免：椭圆曲线签名模式</p>

<p>想都不要想使用相同的RSA key既做认证，又做加密</p>

<hr />

<p>非对称加密</p>

<p>非对称加密类似于非对称签名，除了方向相反，使用公钥把plaintext转成ciphertext，但是要
使用私钥把ciphertext转成plaintext</p>

<p>一个</p>

<p>大多数非对称加密模式都限制能加密的消息大小到一个很低的数字以下。</p>

<hr />

<p>非对称加密</p>

<p>使用 RSAES-OAEP（RSA加密，使用Optimal Asymmeric Encryption Padding）</p>

<p>使用2048-bit的RSA key，以65537为幂底数，SHA256和MGF1-SHA256</p>

<p>不要使用 PCKS v1.5 padding</p>

<p>不要使用不带消息padding的RSA</p>

<p>生成一个随机key，用这个key使用对称加密加密你的消息，然后使用非对称加密算法加密你的key</p>

<p>小心避免RSAES-OAEP的timing攻击通道</p>

<hr />

<p>密码</p>

<p>密码通常被直接用于识别，但是也可以被用于加密或者认证。</p>

<p>实践：</p>

<p>尽可能避免密码</p>

<p>使用一个key继承函数，来尽快把密码转成key。</p>

<p>使用PBKDF2，如果你跟随流行趋势</p>

<p>使用scrypt，如果你希望2<sup>8</sup>倍地比严肃的攻击者更安全</p>

<p>想都不要想把用户的密码存储在服务器上。绝对不能，就算它们被加密了也不能。</p>

<hr />

<p>SSL</p>

<p>SSL是一个可怕的系统</p>

<p>SSL的复杂性导致它很难别安全地实现</p>

<p>SSL给了攻击者很多攻击选项</p>

<p>SSL要求你决定你想信任什么CA</p>

<p>你相信中国政府吗？</p>

<p>不幸的是，SSL是唯一可行的选项</p>

<p>实践：</p>

<p>随客户端分发非对称签名key，并且使用这个key开始你的整个密码系统</p>

<p>使用SSL加密你的网站，Email，和其他公开的标准面向Internet的服务器。</p>

<p>认真地想想你信任哪些CA。</p>

<hr />

<p>奇奇怪怪地部分：</p>

<p>咨询一个密码学专家，如果</p>

<p>你的密码学硬件设备，攻击者可以物理接触到。（例如smartcards）</p>

<p>你想使用最少的电力消耗（例如在手机上）</p>

<p>你需要处理尽可能大的数据流量（例如 10Gbps的 IPSec 隧道）</p>

<p>你需要传输尽可能少的bit（例如和一个核潜艇的通信）</p>

<p>你想忽视我在这个talk中提出的任何建议</p>

<hr />

<p>QA</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[【翻译/介绍】jump Consistent hash:零内存消耗，均匀，快速，简洁，来自Google的一致性哈希算法]]></title>
    <link href="https://blog.helong.info//blog/2015/03/13/jump_consistent_hash/"/>
    <updated>2015-03-13T10:05:55+00:00</updated>
    <id>https://blog.helong.info//blog/2015/03/13/jump_consistent_hash</id>
    <content type="html"><![CDATA[<a name="L......"></a>
<h2>简介</h2>

<p>jump consistent hash是一种一致性哈希算法, 此算法<strong>零内存消耗</strong>，<strong>均匀分配</strong>，<strong>快速</strong>，并且<strong>只有5行代码</strong>。</p>

<p>此算法适合使用在分shard的分布式存储系统中 。</p>

<p>此算法的作者是 Google 的 John Lamping 和 Eric Veach，论文原文在 <a href="http://arxiv.org/ftp/arxiv/papers/1406/1406.2294.pdf">http://arxiv.org/ftp/arxiv/papers/1406/1406.2294.pdf</a></p>

<p>完整代码：</p>

<figure class='code'><figcaption><span>JumpConsistentHash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int32_t</span> <span class="nf">JumpConsistentHash</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">num_buckets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_buckets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">b</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span><span class='line'>        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">*</span> <span class="mi">2862933555777941757ULL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">/</span> <span class="kt">double</span><span class="p">((</span><span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mi">33</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输入是一个64位的key，和桶的数量（一般对应服务器的数量），输出是一个桶的编号。</p>

<!--more-->


<a name="L..............."></a>
<h2>原理解释：</h2>

<p>下面byron根据论文的推导过程，做个翻译：</p>

<p>jump consistent hash的设计目标是：</p>

<ol>
<li>平衡性，把对象均匀地分布在所有桶中。</li>
<li>单调性，当桶的数量变化时，只需要把一些对象从旧桶移动到新桶，不需要做其它移动。</li>
</ol>


<p>jump consistent hash的设计思路是：<strong>计算当bucket数量变化时，有哪些输出需要变化</strong>。</p>

<p>让我们循序渐进地思考：</p>

<ul>
<li>记 ch(key,num_buckets) 为num_buckets时的hash函数。</li>
<li>当num_buckets=1时，由于只有1个桶，显而易见，对任意k，有ch(k,1)==0。</li>
<li>当num_buckets=2时，为了使hash的结果保持均匀，ch(k,2)的结果应该有占比1/2的结果保持为0，有1/2跳变为1。</li>
<li>由此，一般规律是：num_buckets从n变化到n+1后，ch(k,n+1) 的结果中，应该有占比 n/(n+1)  的结果保持不变，而有 1/(n+1) 跳变为 n+1。</li>
</ul>


<p>因此，我们可以用一个随机数生成器，来决定每次要不要跳变，并且让这个随机数生成器的状态仅仅依赖于key。就得到下面这个初步代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int</span> <span class="nf">ch</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_buckets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// This will track ch(key, j +1) .</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_buckets</span><span class="p">;</span> <span class="n">j</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">next</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="n">b</span> <span class="o">=</span> <span class="n">j</span> <span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>显而易见，这个算法是O(n)的。同时我们可以发现，大多数情况下b=j 是不会执行的，而且随着 j 越来越大，这个概率越来越低。
那么有没有办法根据一个随机数，直接得出下一个跳变的 j ，降低时间复杂度呢？</p>

<p>ok,请把你的大脑切换到概率论模式。</p>

<p>我们可以把 ch(key,bum_buckets) 看做一个随机变量，</p>

<p>上述算法，追踪了桶编号的的跳变过程，我们记上一个跳变结果是b，假设下一个结果以一定概率是 j ，那么从b+1到j-1，这中间的多次增加桶都不能跳变。 对于在区间 (b, j) 内的任意整数 i ，j是下一个结果的概率可以记为:</p>

<p>P( j>=i )  =  P( ch(k,i)==ch(k,b+1) )</p>

<p>其中 ch(k,i)==ch(k,b+1) 意即从b+1到i的过程中，连续多次增加桶的时候都没有跳变，这个概率也就是连续多次不跳变事件概率的乘积，因此：</p>

<p>P(j>=i) = P( ch(k,b+1)==ch(k,b+2)) *  P( ch(k,b+2)==ch(k,b+3)) *  P( ch(k,b+3)==ch(k,b+4)) * &hellip;&hellip; *  P( ch(k,i-1)==ch(k,i))</p>

<p>由于单次不跳变的概率：</p>

<p>P( ch(k,i)==ch(k,i+1) ) = i/(i+1)</p>

<p>所以连续多次不跳变的概率</p>

<p>P(j>=i) = (b+1)/(b+2) * (b+2)/(b+3) * &hellip; * (i-1)/i</p>

<p>前后项分子分母相互抵消，得到：</p>

<p>P(j>=i) = (b+1)/i</p>

<p>意即：j>=i的概率为(b+1)/i</p>

<p>此时，我们取一个在[0,1]区间均匀分布的随机数r，规定 r&lt;(b+1)/i，就有j>=i，
所以有 i&lt;(b+1)/r，这样就得到了i的上界是 (b+1)/r，由于对任意的i都要有j>=i，所以
j=floor( (b+1)/r )，这样我们用一个随机数r得到了j。</p>

<p>因此，代码可以改进为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int</span> <span class="nf">ch</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_buckets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">random</span><span class="p">.</span> <span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//  bucket number before the previous jump</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// bucket number before the current jump</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">j</span><span class="o">&lt;</span><span class="n">num_buckets</span><span class="p">){</span>
</span><span class='line'>        <span class="n">b</span><span class="o">=</span><span class="n">j</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">double</span> <span class="n">r</span><span class="o">=</span><span class="n">random</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">//  0&lt;r&lt;1.0</span>
</span><span class='line'>        <span class="n">j</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span> <span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span><span class="n">r</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>这个算法的时间复杂度，可以假设每次r都取0.5，则可以认为每次 j=2*j，因此时间复杂度为O(log(n))。</p>

<p>此处需要一个均匀的伪随机数生成器，论文中使用了一个64位的线性同余随机数生成器。</p>

<p>需要指出的是：不像割环法，jump consistent hash不需要对key做hash，这是由于jump consistent hash使用内置的伪随机数生成器，来对每一次key做再hash，（byron的理解：所以结果分布的均匀性与输入key的分布无关，由伪随机数生成器的均匀性保证）。</p>

<a name="L..........................."></a>
<h2>各项指标对比分析：</h2>

<p>consistent hash的概念出自David Karger的论文，经典并且应用广泛的割环法即出自这篇论文：<a href="http://www.ra.ethz.ch/cdstore/www8/data/2181/pdf/pd1.pdf">http://www.ra.ethz.ch/cdstore/www8/data/2181/pdf/pd1.pdf</a></p>

<p>Karger提出2种实现:</p>

<ol>
<li>&ldquo;version A"，用 std::map&lt;uint64_t, int32_t>表示key的hash 到桶id的映射。</li>
<li>&ldquo;version B"，用 vector&lt;pair&lt;uint64_t, int32_t> >存储，vector事先排好序，用二分查找。</li>
</ol>


<p>这两种实现的查找时间复杂度也都是O(log(n))</p>

<p>jump consistent hash的论文中，用jump consistent hash和Karger的割环算法做了对比，结果如下：</p>

<a name="L1..key.................."></a>
<h3>1. key分布的均匀性</h3>

<p>直接从论文中摘录如下表格：</p>

<p><img src="https://blog.helong.info//images/blog/jmp_consistent_hash_distribution.png"></p>

<p>从标准差(Standard Error)这一列可见，jump consistent hash的均匀性要胜过割环法。</p>

<p>并且显而易见，jump consistent hash，当 扩/缩容 时，跳变key数量已经是理论最少值 1/n。</p>

<a name="L2.............."></a>
<h3>2. 执行耗时</h3>

<p>下面是论文中的执行耗时对比图，其中k=1000。</p>

<p><img src="https://blog.helong.info//images/blog/jmp_consistent_hash_cpu.png"></p>

<a name="L3...................."></a>
<h3>3. 内存占用对比</h3>

<p>显而易见，请自行脑补</p>

<a name="L4......................."></a>
<h3>4. 初始化耗时对比</h3>

<p>显而易见，请自行脑补</p>

<a name="L............"></a>
<h1>相关链接</h1>

<p>在 Hacker News上面的讨论：<a href="https://news.ycombinator.com/item?id=8136408">https://news.ycombinator.com/item?id=8136408</a></p>

<p>这个算法最早在Google的guava库里面开源：<a href="https://github.com/google/guava/blob/master/guava/src/com/google/common/hash/Hashing.java#L392">https://github.com/google/guava/blob/master/guava/src/com/google/common/hash/Hashing.java#L392</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SSL/TLS CipherSuite 介绍]]></title>
    <link href="https://blog.helong.info//blog/2015/01/23/ssl_tls_ciphersuite_intro/"/>
    <updated>2015-01-23T14:30:00+00:00</updated>
    <id>https://blog.helong.info//blog/2015/01/23/ssl_tls_ciphersuite_intro</id>
    <content type="html"><![CDATA[<p>本文是关于SSL/TLS的 CipherSuite 的信息摘录，翻译。如有疑问，欢迎指出。</p>

<a name="L......CipherSuite........."></a>
<h2>一，CipherSuite的概念</h2>

<p>CipherSuite 这个名词目前没看到有好的中文翻译，个人觉得翻译成“加密算法套件”比较合适。Cipher泛指是密码学的加密算法，例如 aes, rsa, ecdh 等。
tls是由各类基础算法，作为原语组合而成。
一个CipherSuite是4个算法的组合：</p>

<ol>
<li>1个authentication (认证)算法</li>
<li>1个encryption(加密)算法</li>
<li>1个message authentication code (消息认证码 简称MAC)算法</li>
<li>1 个key exchange(密钥交换)算法</li>
</ol>


<!--more-->


<a name="L......CipherSuite..............."></a>
<h2>二，CipherSuite的注册管理</h2>

<p>TLS Cipher Suite  在 iana 集中注册，每一个CipherSuite分配有 一个2字节的数字用来标识 ：
可以在 iana的网页查看：
 <a href="https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-4">https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-4</a>
例如:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x00,0x2F    TLS_RSA_WITH_AES_128_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x30 TLS_DH_DSS_WITH_AES_128_CBC_SHA Y   [RFC5246]
</span><span class='line'>0x00,0x31 TLS_DH_RSA_WITH_AES_128_CBC_SHA Y   [RFC5246]
</span><span class='line'>0x00,0x32 TLS_DHE_DSS_WITH_AES_128_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x33 TLS_DHE_RSA_WITH_AES_128_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x34 TLS_DH_anon_WITH_AES_128_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x35 TLS_RSA_WITH_AES_256_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x36 TLS_DH_DSS_WITH_AES_256_CBC_SHA Y   [RFC5246]
</span><span class='line'>0x00,0x37 TLS_DH_RSA_WITH_AES_256_CBC_SHA Y   [RFC5246]
</span><span class='line'>0x00,0x38 TLS_DHE_DSS_WITH_AES_256_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x39 TLS_DHE_RSA_WITH_AES_256_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x3A TLS_DH_anon_WITH_AES_256_CBC_SHA    Y   [RFC5246]
</span><span class='line'>0x00,0x3B TLS_RSA_WITH_NULL_SHA256    Y   [RFC5246]
</span><span class='line'>0x00,0x3C TLS_RSA_WITH_AES_128_CBC_SHA256 Y   [RFC5246]
</span><span class='line'>0x00,0x3D TLS_RSA_WITH_AES_256_CBC_SHA256 Y   [RFC5246]
</span><span class='line'>0x00,0x3E TLS_DH_DSS_WITH_AES_128_CBC_SHA256  Y   [RFC5246]
</span><span class='line'>0x00,0x3F TLS_DH_RSA_WITH_AES_128_CBC_SHA256  Y   [RFC5246]</span></code></pre></td></tr></table></div></figure>


<p>例如其中的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x00,0x37    TLS_DH_RSA_WITH_AES_256_CBC_SHA Y   [RFC5246]</span></code></pre></td></tr></table></div></figure>


<p>这一条，
0x00,0x37 这个 value 就是  TLS_DH_RSA_WITH_AES_256_CBC_SHA 这个 Cipher Suite的数字，rfc5246 定义了这个CipherSuite的具体实现。</p>

<a name="L......CipherSuite........................"></a>
<h2>三，CipherSuite在现实环境的应用</h2>

<p>tls/ssl 一共出过 5个版本：ssl2/ssl3/tls1.0/tls1.1/tls1.2 ，ssl2/ssl3这两个版本漏洞太多，请务必禁用。</p>

<p>tls1.2，当前(2015年)最新的tls协议，定义在：rfc5246</p>

<p>tls协议的实现有多种，如openssl, gnutls, nss, libressl, cyassl, polarssl, botan等等。</p>

<p>openssl的代码算是其中最混乱的，但是也是最久经考验的。
( 请参见此打脸文： <a href="http://blog.csdn.net/dog250/article/details/24552307">http://blog.csdn.net/dog250/article/details/24552307</a> )</p>

<p>个人觉得polarssl和botan的架构最清晰，代码风格清新可爱，便于学习理解协议（但是不建议在生产环境下用，例如polarssl功能尚有欠缺）。</p>

<a name="L1................"></a>
<h3>1.服务器端：</h3>

<p>说说openssl，openssl 实现了以上列表中的大部分( 摒弃了不安全的一些CipherSuite)。</p>

<p>openssl 支持的 cipher 列表，可以用  openssl  ciphers -V  | column -t 命令查看
输出如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0xC0,0x30  -  ECDHE-RSA-AES256-GCM-SHA384    TLSv1.2  Kx=ECDH        Au=RSA    Enc=AESGCM(256)    Mac=AEAD
</span><span class='line'>0xC0,0x2C  -  ECDHE-ECDSA-AES256-GCM-SHA384  TLSv1.2  Kx=ECDH        Au=ECDSA  Enc=AESGCM(256)    Mac=AEAD
</span><span class='line'>0xC0,0x28  -  ECDHE-RSA-AES256-SHA384        TLSv1.2  Kx=ECDH        Au=RSA    Enc=AES(256)       Mac=SHA384
</span><span class='line'>0xC0,0x24  -  ECDHE-ECDSA-AES256-SHA384      TLSv1.2  Kx=ECDH        Au=ECDSA  Enc=AES(256)       Mac=SHA384
</span><span class='line'>0xC0,0x14  -  ECDHE-RSA-AES256-SHA           SSLv3    Kx=ECDH        Au=RSA    Enc=AES(256)       Mac=SHA1
</span><span class='line'>0xC0,0x0A  -  ECDHE-ECDSA-AES256-SHA         SSLv3    Kx=ECDH        Au=ECDSA  Enc=AES(256)       Mac=SHA1
</span><span class='line'>0x00,0xA5  -  DH-DSS-AES256-GCM-SHA384       TLSv1.2  Kx=DH/DSS      Au=DH     Enc=AESGCM(256)    Mac=AEAD
</span><span class='line'>0x00,0xA1  -  DH-RSA-AES256-GCM-SHA384       TLSv1.2  Kx=DH/RSA      Au=DH     Enc=AESGCM(256)    Mac=AEAD
</span><span class='line'>0x00,0x9F  -  DHE-RSA-AES256-GCM-SHA384      TLSv1.2  Kx=DH          Au=RSA    Enc=AESGCM(256)    Mac=AEAD
</span><span class='line'>0x00,0x6B  -  DHE-RSA-AES256-SHA256          TLSv1.2  Kx=DH          Au=RSA    Enc=AES(256)       Mac=SHA256
</span><span class='line'>0x00,0x69  -  DH-RSA-AES256-SHA256           TLSv1.2  Kx=DH/RSA      Au=DH     Enc=AES(256)       Mac=SHA256
</span><span class='line'>0x00,0x68  -  DH-DSS-AES256-SHA256           TLSv1.2  Kx=DH/DSS      Au=DH     Enc=AES(256)       Mac=SHA256
</span><span class='line'>0x00,0x39  -  DHE-RSA-AES256-SHA             SSLv3    Kx=DH          Au=RSA    Enc=AES(256)       Mac=SHA1
</span><span class='line'>0x00,0x37  -  DH-RSA-AES256-SHA              SSLv3    Kx=DH/RSA      Au=DH     Enc=AES(256)       Mac=SHA1
</span></code></pre></td></tr></table></div></figure>


<p>每一行里：</p>

<ol>
<li>第1个字段是 这个CipherSuite的value，</li>
<li>第2个字段是 CipherSuite 的名字 ，</li>
<li>第3个字段是本Cipher Suite是用于哪个 SSL/TLS版本的协议，</li>
<li>第4个字段 Kx 是 key exchange 算法</li>
<li>第5个字段 Au 是 authentication 算法</li>
<li>第6个字段Enc是 encryptation算法</li>
<li>第7个字段 Mac 是 MAC 算法，用于创建消息摘要</li>
</ol>


<p>例如:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0xC0,0x23  -  ECDHE-ECDSA-AES128-SHA256      TLSv1.2  Kx=ECDH        Au=ECDSA  Enc=AES(128)       Mac=SHA256</span></code></pre></td></tr></table></div></figure>


<p>这一行，表示：</p>

<ul>
<li> 名字为 ECDH-ECDSA-AES128-SHA256  的CipherSuite ，用于 TLSv1.2版本，</li>
<li> 使用 ECDH做密钥交换，</li>
<li> 使用ECDSA做认证，</li>
<li> 使用AES-128做加密算法，</li>
<li> 使用SHA256做MAC算法。</li>
</ul>


<p>一个CipherSuite，在 openssl 库里用这个结构体表示:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/* used to hold info on the particular ciphers used */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">ssl_cipher_st</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>           <span class="cm">/* text name */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>           <span class="cm">/* id, 4 bytes, first is version */</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * changed in 0.9.9: these four used to be portions of a single value</span>
</span><span class='line'><span class="cm">     * &#39;algorithms&#39;</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_mkey</span><span class="p">;</span> <span class="cm">/* key exchange algorithm */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_auth</span><span class="p">;</span> <span class="cm">/* server authentication */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_enc</span><span class="p">;</span> <span class="cm">/* symmetric encryption */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_mac</span><span class="p">;</span> <span class="cm">/* symmetric authentication */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_ssl</span><span class="p">;</span> <span class="cm">/* (major) protocol version */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algo_strength</span><span class="p">;</span> <span class="cm">/* strength and export flags */</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm2</span><span class="p">;</span>   <span class="cm">/* Extra flags */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">strength_bits</span><span class="p">;</span>          <span class="cm">/* Number of bits really used */</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">alg_bits</span><span class="p">;</span>               <span class="cm">/* Number of bits for algorithm */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上4个算法，对应其中的下面四行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_mkey</span><span class="p">;</span>   <span class="cm">/* key exchange algorithm */</span>
</span><span class='line'> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_auth</span><span class="p">;</span>   <span class="cm">/* server authentication */</span>
</span><span class='line'> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_enc</span><span class="p">;</span>    <span class="cm">/* symmetric encryption */</span>
</span><span class='line'> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">algorithm_mac</span><span class="p">;</span>    <span class="cm">/* symmetric authentication */</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L2..............."></a>
<h3>2，客户端：</h3>

<p>在浏览器里面，可以这样查看当前使用的CipherSuite:
Firefox下打开gmail，点击地址栏左侧锁图标</p>

<a name="L3..............CipherSuite"></a>
<h3>3. 如何指定CipherSuite</h3>

<p>在tls中，选择CipherSuite的方法是通过cipher list</p>

<p>格式和用法见：<a href="https://www.openssl.org/docs/apps/ciphers.html">https://www.openssl.org/docs/apps/ciphers.html</a></p>

<p>nginx里面的配置项是  cipher_list</p>

<p>cipher list 的格式是：</p>

<p>一个cipher list 包含一个或者多个由冒号分隔的cipher string( 逗号和空格也可以接受但不常用)。</p>

<p>一个cipher string可以是下列形式之一:</p>

<p>(1).可以由单个cipher suite构成，例如  RC4-SHA。</p>

<p>(2).它可以表示含有某个特定算法的cipher列表，或者一种特定类型的cipher suite。例如， SHA1表示所有使用摘要算法SHA1的cipher suite, SSLV3表示所有SSL V3算法。</p>

<p>(3).cipher suite的列表,可以使用加号+ 合并到一个单一的cipher string里面。这被作为一个逻辑且操作。例如，SHA1+DES表示所有包含了 SHA，并且包含了DES的算法。</p>

<p>(4).每一个cipher string可以在前面加上字符 !,-,或者+</p>

<p>如果加了!，那么这种cipher永久从列表里面删除，就算后边显式添加进来也不行。</p>

<p>如果加了-，那么cipher中的一些或者全部可以在后面的选项里面加回来。</p>

<p>如果加了+，那么cipher被移动到列表的最后，这个选项不增加任何cipher，只是把匹配的cipher移动到最后。</p>

<p>如果没有上述字符，那么字符串被解析成一个cipher list，追加到当前配置列表的后面。如果cipher list 中的某些cipher已经存在了，就忽略该cipher。</p>

<p>(5).另外，cipher string @STRENGTH 可以用在任何点，用来把当前cipher list按照加密算法key长度排序。</p>

<p>当前建议的配置参数可以看看mozilla的这个文档：<a href="https://wiki.mozilla.org/Security/Server_Side_TLS#Recommended_configurations">https://wiki.mozilla.org/Security/Server_Side_TLS#Recommended_configurations</a></p>

<a name="L......CipherSuite.................."></a>
<h2>四，CipherSuite的进化与现状</h2>

<p>随着密码学的发展，硬件性能的提高，加密和破解的不断对抗博弈，常用的算法也在不断进化，旧的算法被破解，新的算法诞生。</p>

<p>CipherSuite的当前流行趋势：</p>

<p>authentication (认证)算法 ：常见的有 RSA/DSA/ECDSA 3种，目前最主流的是人民群众喜闻乐见，妇孺皆知的RSA ( 2048 bit及以上)， （ECDSA 是新兴趋势，例如gmail，facebook都在迁移到ECDSA，当然目前用的还不多，DSA 由于只能提供1024bit，已经没啥人敢用）。</p>

<p>加密算法：主流趋势是使用 aes，128/256 bit都可以，加密模式的趋势是使用gcm，cbc由于被发现有 BEAST 攻击等，比较难以正确使用，至于ecb模式，请勿使用。加密算法 还有RC4（不建议使用），3DES（不建议使用），Camellia(貌似日本人搞的) ，DES(已经被淘汰)等，</p>

<p>message authentication code (消息认证码 简称MAC)算法 ，主流有 sha256,sha384,sha1,等。tls中使用了HMAC模式，而不是原始的 sha256,sha1等。google已经在淘汰MD5了。（gcm是一种特殊的称为aead的加密模式，不需要配合MAC。）</p>

<p>key exchange(密钥交换)算法：主流有两种：DH和ECDH，自从斯诺登爆料了NSA的https破解方案以后，现在的 key exchange(密钥交换)算法，普遍流行 PFS，把DH, ECDH变成 DHE，ECDHE 。</p>

<p>mozilla目前推荐的 cipher list：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">kEDH</span><span class="o">+</span><span class="nl">AESGCM</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA384</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA256</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">DSS</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="n">DHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="nl">SHA</span><span class="p">:</span><span class="o">!</span><span class="nl">aNULL</span><span class="p">:</span><span class="o">!</span><span class="nl">eNULL</span><span class="p">:</span><span class="o">!</span><span class="nl">EXPORT</span><span class="p">:</span><span class="o">!</span><span class="nl">DES</span><span class="p">:</span><span class="o">!</span><span class="nl">RC4</span><span class="p">:</span><span class="o">!</span><span class="mi">3</span><span class="nl">DES</span><span class="p">:</span><span class="o">!</span><span class="nl">MD5</span><span class="p">:</span><span class="o">!</span><span class="n">PSK</span>
</span></code></pre></td></tr></table></div></figure>


<p>mozilla的优先级选择考虑：</p>

<p>1.ECDHE+AESGCM最先选，目前没有已知漏洞。</p>

<p>2.PFS ciphersuite优先，其中ECDHE优先于DHE</p>

<p>3.SHA256优先于SHA1。完全禁用MD5。</p>

<p>4.AES 128优先于AES 256。这个问题有一些讨论。</p>

<p>5.在向后兼容模式中，AES优先于3DES。</p>

<p>6.完全禁止RC4。3DES只用于兼容老版本。</p>

<p>cloudflare的ssl cipher list配置：</p>

<p><a href="https://github.com/cloudflare/sslconfig/blob/master/conf">https://github.com/cloudflare/sslconfig/blob/master/conf</a></p>

<p>google的一篇文章解释当前cipher suite的流行趋势
<a href="http://googleonlinesecurity.blogspot.com.au/2013/11/a-roster-of-tls-cipher-suites-weaknesses.html">http://googleonlinesecurity.blogspot.com.au/2013/11/a-roster-of-tls-cipher-suites-weaknesses.html</a></p>

<p>google在密码学方面的最新进展可以在这个博客追踪：<a href="http://googleonlinesecurity.blogspot.com/">http://googleonlinesecurity.blogspot.com/</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mock C++ Function for Unit Test]]></title>
    <link href="https://blog.helong.info//blog/2014/03/27/mock-c-plus-plus-function-for-unit-test/"/>
    <updated>2014-03-27T10:05:55+00:00</updated>
    <id>https://blog.helong.info//blog/2014/03/27/mock-c-plus-plus-function-for-unit-test</id>
    <content type="html"><![CDATA[<p>在单元测试中，我们需要提供业务逻辑的mock版本，
当业务逻辑实现为C++的virtual function时，这是很容易的，我们只需要写一个子类，
实现virtual function就行了，Google 的 gmock就针对这种情况设计。</p>

<p>可是，如果遗留代码中有一般C函数，非virtual的类成员函数，模板函数，inline函数，如何提供mock版本呢？</p>

<p>下面的代码用一点trick实现了上述函数的运行时mock。</p>

<!--more-->


<p>原理是，在运行时，修改目标函数的机器码，改为jmp到mock版本的函数中。</p>

<p>实现如下：</p>

<figure class='code'><figcaption><span>patch实现 cpp (patch_elf.cpp)</span> <a href='https://blog.helong.info//downloads/code/patch_elf/patch_elf.cpp'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;stdint.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/mman.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;patch_elf.h&quot;</span>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">print_op</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">addr</span><span class="p">,</span><span class="kt">int</span> <span class="n">leng</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">op</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">&lt;&lt;</span><span class="s">&quot;addr:&quot;</span><span class="o">&lt;&lt;</span><span class="n">addr</span><span class="o">&lt;&lt;</span><span class="s">&quot; code:&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">leng</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span class='line'>        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;0x&quot;</span><span class="o">&lt;&lt;</span><span class="n">hex</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">op</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="s">&quot; &quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">patch_func</span><span class="p">(</span><span class="kt">void</span>  <span class="o">*</span> <span class="n">original</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="n">mock</span><span class="p">){</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    cout&lt;&lt;endl&lt;&lt;&quot;----------------------------------------------------------------------&quot;</span>
</span><span class='line'><span class="cm">        &lt;&lt;endl&lt;&lt;__func__&lt;&lt;&quot; ,i am going to patch &quot;&lt;&lt;original&lt;&lt;&quot; to &quot;&lt;&lt;mock</span>
</span><span class='line'><span class="cm">        &lt;&lt;endl;</span>
</span><span class='line'><span class="cm">        */</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//rax 用于保存函数调用的返回值，所以可以占用</span>
</span><span class='line'>    <span class="c1">//4010e1:       b8 20 0c 40 00          mov    $0x400c20,%eax</span>
</span><span class='line'>    <span class="c1">//4010e6:       ff e0                   jmpq   *%rax</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">addr</span><span class="o">=</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">mock</span><span class="p">;</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">int</span> <span class="n">code_len</span><span class="o">=</span><span class="mi">7</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">inject_code</span><span class="p">[</span><span class="n">code_len</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">};</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inject_code</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//print_op(inject_code,code_len);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//接下来，把inject_code复制到original这个位置</span>
</span><span class='line'>    <span class="c1">//print_op(original,100);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//首先，要改掉内存的权限，增加写权限</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">length</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span> <span class="n">code_addr</span><span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">original</span><span class="o">/</span><span class="n">length</span><span class="p">)</span><span class="o">*</span><span class="n">length</span> <span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="n">mprotect</span><span class="p">(</span><span class="n">code_addr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span><span class="o">!=</span><span class="n">ret</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">cerr</span><span class="o">&lt;&lt;</span><span class="s">&quot;mprotect failed! ret=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ret</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//修改代码</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span> <span class="n">original</span><span class="p">,</span><span class="n">inject_code</span><span class="p">,</span><span class="n">code_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//再去掉写权限</span>
</span><span class='line'>    <span class="n">ret</span><span class="o">=</span><span class="n">mprotect</span><span class="p">(</span><span class="n">code_addr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span>  <span class="n">PROT_EXEC</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span><span class="o">!=</span><span class="n">ret</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">cerr</span><span class="o">&lt;&lt;</span><span class="s">&quot;mprotect failed! ret=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ret</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//print_op(original,100);</span>
</span><span class='line'>    <span class="c1">//cout&lt;&lt;&quot;----------------------------------------------------------------------&quot;</span>
</span><span class='line'>    <span class="c1">//  &lt;&lt;endl&lt;&lt;endl;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>测试了</p>

<p>1.一般函数 2.inline函数 3.一般成员函数 4.模板函数</p>

<p>并在 ：32位，64位; -O2, -O0，参数下编译</p>

<p>除了 inline函数没办法，其它的都有效</p>

<figure class='code'><figcaption><span>被测试的函数  (func.h)</span> <a href='https://blog.helong.info//downloads/code/patch_elf/func.h'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#pragma once</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;cstdio&gt;</span>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ST1</span><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="kt">uint32_t</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">uint64_t</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">double</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ST1</span> <span class="o">*</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ST1</span><span class="p">()</span><span class="o">:</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">d</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">e</span><span class="p">(</span><span class="mi">0</span><span class="p">){</span>
</span><span class='line'>            <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//类的成员函数</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">member_func</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">int</span> <span class="nf">member_func_mock</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">member_func_extern</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">st</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//一般函数</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">original_func</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">para1</span><span class="p">,</span><span class="n">ST1</span> <span class="n">para2</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="n">para3</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">mock_func</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">para1</span><span class="p">,</span><span class="n">ST1</span> <span class="n">para2</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="n">para3</span><span class="p">);</span>
</span><span class='line'><span class="c1">//int ref_func(ST1 * para1,ST1 para2,void * para3);</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Base</span><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>        <span class="kt">uint32_t</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ST1</span> <span class="n">st</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="kt">uint32_t</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Base</span><span class="p">()</span><span class="o">:</span><span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">){}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//inline 函数</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inline_func</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span><span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">+</span> <span class="mh">0x1111</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">/</span><span class="mh">0x1111</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">inline</span> <span class="kt">int</span> <span class="nf">inline_func_mock</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span><span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="mi">100</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//模板函数</span>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">uint32_t</span> <span class="n">get_member_a</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span> <span class="n">t</span><span class="p">){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot; a=&quot;</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">uint32_t</span> <span class="n">get_member_b</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span> <span class="n">t</span><span class="p">){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot; b=&quot;</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">b</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>被测试的函数和mock函数 cpp (func.cpp)</span> <a href='https://blog.helong.info//downloads/code/patch_elf/func.cpp'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;stdint.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;func.h&quot;</span>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">original_func</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">para1</span><span class="p">,</span><span class="n">ST1</span> <span class="n">para2</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="n">para3</span><span class="p">){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">called! &quot;</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; a+a &quot;</span><span class="o">&lt;&lt;</span><span class="n">para1</span><span class="o">-&gt;</span><span class="n">a</span><span class="o">+</span><span class="n">para2</span><span class="p">.</span><span class="n">a</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; b+b &quot;</span><span class="o">&lt;&lt;</span><span class="n">para1</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">+</span><span class="n">para2</span><span class="p">.</span><span class="n">b</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; c+c &quot;</span><span class="o">&lt;&lt;</span><span class="n">para1</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">&lt;&lt;</span><span class="n">para2</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; d+d &quot;</span><span class="o">&lt;&lt;</span><span class="n">para1</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">+</span><span class="n">para2</span><span class="p">.</span><span class="n">d</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; e+e &quot;</span><span class="o">&lt;&lt;</span><span class="n">para1</span><span class="o">-&gt;</span><span class="n">e</span><span class="o">&lt;&lt;</span><span class="n">para2</span><span class="p">.</span><span class="n">e</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="n">para3</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">mock_func</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">para1</span><span class="p">,</span><span class="n">ST1</span> <span class="n">para2</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="n">para3</span><span class="p">){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">called!&quot;</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">ref_func</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">para1</span><span class="p">,</span><span class="n">ST1</span> <span class="n">para2</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="n">para3</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">mock_func</span><span class="p">(</span><span class="n">para1</span><span class="p">,</span><span class="n">para2</span><span class="p">,</span><span class="n">para3</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">ST1</span><span class="o">::</span><span class="n">member_func</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot; called! &quot;</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; a=&quot;</span><span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">a</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; b=&quot;</span><span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">b</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; c=&quot;</span><span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">c</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="s">&quot; d=&quot;</span><span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">d</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">ST1</span><span class="o">::</span><span class="n">member_func_mock</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot; called! i do nothing.&quot;</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">member_func_extern</span><span class="p">(</span><span class="n">ST1</span> <span class="o">*</span> <span class="n">st</span><span class="p">){</span>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__func__</span><span class="o">&lt;&lt;</span><span class="s">&quot; called! i am not member function.&quot;</span>
</span><span class='line'>        <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>demo cpp (main.cpp)</span> <a href='https://blog.helong.info//downloads/code/patch_elf/main.cpp'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;stdint.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/mman.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;func.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;patch_elf.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">test</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">ST1</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">str</span><span class="p">[]</span><span class="o">=</span><span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">s1</span><span class="p">.</span><span class="n">a</span><span class="o">=</span><span class="n">s1</span><span class="p">.</span><span class="n">b</span><span class="o">=</span><span class="n">s1</span><span class="p">.</span><span class="n">d</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">s1</span><span class="p">.</span><span class="n">e</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">s2</span><span class="p">.</span><span class="n">a</span><span class="o">=</span><span class="n">s2</span><span class="p">.</span><span class="n">b</span><span class="o">=</span><span class="n">s2</span><span class="p">.</span><span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="n">s1</span><span class="p">.</span><span class="n">e</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;----------------------------------------------------------------------&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//mock original_func，替换成mock_func</span>
</span><span class='line'>    <span class="n">original_func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">patch_func</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">original_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mock_func</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">original_func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;----------------------------------------------------------------------&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//mock inline 函数貌似不行</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">a</span><span class="o">=</span><span class="n">s1</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">s1</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'>    <span class="n">inline_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="n">patch_func</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">inline_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">inline_func_mock</span><span class="p">);</span>
</span><span class='line'>    <span class="n">inline_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;----------------------------------------------------------------------&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">s1</span><span class="p">.</span><span class="n">member_func</span><span class="p">();</span>
</span><span class='line'>    <span class="n">patch_func</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ST1</span><span class="o">::</span><span class="n">member_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ST1</span><span class="o">::</span><span class="n">member_func_mock</span><span class="p">);</span>
</span><span class='line'>    <span class="n">s1</span><span class="p">.</span><span class="n">member_func</span><span class="p">();</span>
</span><span class='line'>    <span class="n">patch_func</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ST1</span><span class="o">::</span><span class="n">member_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">member_func_extern</span><span class="p">);</span>
</span><span class='line'>    <span class="n">s1</span><span class="p">.</span><span class="n">member_func</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;----------------------------------------------------------------------&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">get_member_a</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">patch_func</span><span class="p">(</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_member_a</span><span class="o">&lt;</span><span class="n">ST1</span><span class="o">&gt;</span> <span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">get_member_b</span><span class="o">&lt;</span><span class="n">ST1</span><span class="o">&gt;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">get_member_a</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">test</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[博客迁移到octopress]]></title>
    <link href="https://blog.helong.info//blog/2014/03/24/move-to-octopress/"/>
    <updated>2014-03-24T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2014/03/24/move-to-octopress</id>
    <content type="html"><![CDATA[<p>wordpress的编辑器混淆了 结构 和 表现
而markdown，类似latex，结构和表现分离，更符合我的偏好。</p>

<p>在vim里面写博客，更能激起人的写作欲望，浏览器里面，容易转移注意力。</p>

<p>octopress的博客还可以用git做版本管理，备份。</p>

<p>octopress内置了代码格式化，着色。</p>

<p>这些都比wordpress更适合做技术博客。</p>

<p>从wordpress导出数据使用了  <a href="https://github.com/benbalter/wordpress-to-jekyll-exporter">https://github.com/benbalter/wordpress-to-jekyll-exporter</a></p>

<p>评论使用了 <a href="https://disqus.com">https://disqus.com</a> ，只需要申请一个账号，然后填到_config.yml里面，就行了</p>

<p>google analytics也是，只需要申请，然后把ID填入_config.yml就ok了。</p>

<p>octopress并不适合放在 xxx.com/blog/ 这样的目录下面，一些js脚本不支持目录，
最好放在独立域名下面。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一个使用KuaiPan备份linux服务器的脚本]]></title>
    <link href="https://blog.helong.info//blog/2014/02/08/%25e4%25b8%2580%25e4%25b8%25aa%25e4%25bd%25bf%25e7%2594%25a8kuaipan%25e5%25a4%2587%25e4%25bb%25bdlinux%25e6%259c%258d%25e5%258a%25a1%25e5%2599%25a8%25e7%259a%2584%25e8%2584%259a%25e6%259c%25ac/"/>
    <updated>2014-02-08T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2014/02/08/%e4%b8%80%e4%b8%aa%e4%bd%bf%e7%94%a8kuaipan%e5%a4%87%e4%bb%bdlinux%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e8%84%9a%e6%9c%ac</id>
    <content type="html"><![CDATA[<p>近日需要给服务器做备份，在网上找到了一个现成的金山快盘的api：<a href="https://github.com/deren/python-kuaipan" target="_blank"><a href="https://github.com/deren/python-kuaipan">https://github.com/deren/python-kuaipan</a></a> （感谢！）<br/>
试了一下，遂决定备份到金山快盘上。</p>

<p>备份脚本考虑了以下几个方面的要求：<br/>
1.上传之前一定要加密，对比之后，使用了openssl的aes-256-cbc加密算法<br/>
2.增量备份，最开始尝试用<a href="http://duplicity.nongnu.org" target="_blank">duplicity</a> ,写了一个duplicity的backend，然后发现，好复杂！猛然发现，linux上的tar就有<a href="http://www.gnu.org/software/tar/manual/html_node/Incremental-Dumps.html#Incremental-Dumps" target="_blank">增量备份功能</a>，于是直接用了tar<br/>
3.分卷，KuaiPan有文件大小限制，此处用了split把tar文件分卷</p>

<p>代码放在 <a href="https://github.com/windydays/kuaipan_backup" target="_blank"><a href="https://github.com/windydays/kuaipan_backup">https://github.com/windydays/kuaipan_backup</a></a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Http Proxy Script]]></title>
    <link href="https://blog.helong.info//blog/2013/11/18/a-http-proxy-script/"/>
    <updated>2013-11-18T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2013/11/18/a-http-proxy-script</id>
    <content type="html"><![CDATA[<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/local/bin/python</span>
</span><span class='line'><span class="c"># -*- coding: utf-8 -*-</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">base64</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">select</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">httplib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="c">#base64.encodestring(&quot;das\120xsdada\s&quot;)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">usage</span> <span class="p">():</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;connect_to_http_proxy </span><span class="si">%s</span><span class="s">&quot;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;usage: connect_to_http_proxy &amp;lt;desthost&amp;gt; &amp;lt;destport&amp;gt;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span class='line'>    <span class="n">usage</span><span class="p">()</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">proxy_host</span><span class="o">=</span><span class="s">&quot;web-proxy-domain.com&quot;</span>
</span><span class='line'><span class="n">proxy_port</span><span class="o">=</span><span class="s">&quot;8080&quot;</span>
</span><span class='line'><span class="n">dest_host</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'><span class="n">dest_port</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'><span class="n">dest_host</span><span class="p">,</span> <span class="n">dest_port</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sock</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">proxy_host</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">proxy_port</span><span class="p">)))</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">req</span><span class="o">=</span><span class="s">&quot;CONNECT &quot;</span><span class="o">+</span><span class="n">dest_host</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">dest_port</span> <span class="o">+</span> <span class="s">&quot; HTTP/1.0</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</span><span class='line'><span class="n">resp</span><span class="o">=</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;200&quot;</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">req</span><span class="p">,</span><span class="n">resp</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ep</span><span class="o">=</span><span class="n">select</span><span class="o">.</span><span class="n">epoll</span><span class="p">()</span>
</span><span class='line'><span class="n">ep</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span><span class="p">)</span>
</span><span class='line'><span class="n">ep</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span><span class="p">)</span>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">events</span><span class="o">=</span><span class="n">ep</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">fd</span><span class="p">,</span><span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">event</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLERR</span><span class="p">:</span>
</span><span class='line'>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">event</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span> <span class="ow">and</span> <span class="n">fd</span><span class="o">==</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">():</span>
</span><span class='line'>            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">event</span> <span class="o">&amp;</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span> <span class="ow">and</span> <span class="n">fd</span><span class="o">==</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">():</span>
</span><span class='line'>            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="c">#conn=httplib.HTTPConnection(proxy_host+&quot;:&quot;+proxy_port)</span>
</span><span class='line'><span class="c">#conn.request(&quot;CONNECT&quot;,dest_host+&quot;:&quot;+dest_port)</span>
</span><span class='line'><span class="c">#res=conn.getresponse()</span>
</span><span class='line'><span class="c">#print res.read()</span>
</span><span class='line'><span class="c">#if res.status != 200:</span>
</span><span class='line'><span class="c">#    print res.status,res.reason</span>
</span><span class='line'><span class="c">#    sys.exit()</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Libpcap试玩]]></title>
    <link href="https://blog.helong.info//blog/2013/08/04/libpcap%25e8%25af%2595%25e7%258e%25a9/"/>
    <updated>2013-08-04T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2013/08/04/libpcap%e8%af%95%e7%8e%a9</id>
    <content type="html"><![CDATA[<p>libpcap驱动了tcpdump,和wireshark这类抓包工具.提供了高度灵活的包过滤语言. 据wikipedia,高性能的包过滤最早是在bsd上作为一个问题被解决,被称为bpf,在内核实现了一个解释器,进行包匹配,用户态提供一个字符设备, linux作为后来者,支持与bsd基本相同的packet filter,称为lpf,不同的是,linux是通过在一个raw socket来支持包过滤的,通过setsockopt来SO_ATTACH_FILTER,挂载过滤器. strace 可知,libpcap实际上进行了如下syscall:</p>

<pre>socket(PF_PACKET, SOCK_RAW, 768) = 59 
setsockopt(59, SOL_SOCKET, SO_ATTACH_FILTER, "\1\0\0\0\0\0\0\0\250\327Vc\375\177\0\0", 16) = 0</pre>


<p>libpcap的api文档和demo代码可以参见</p>

<ol>
<li><a href="http://www.tcpdump.org/pcap3_man.html" target="_blank"><a href="http://www.tcpdump.org/pcap3_man.html">http://www.tcpdump.org/pcap3_man.html</a></a></li>
<li><a href="http://www.tcpdump.org/sniffex.c" target="_blank"><a href="http://www.tcpdump.org/sniffex.c">http://www.tcpdump.org/sniffex.c</a></a></li>
</ol>


<p>参考文档了demo,我写了一个小的sniffer,</p>

<!--more-->


<p>如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">Sniffer</span><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Sniffer</span><span class="p">()</span><span class="o">:</span><span class="n">handle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">cap_exp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="n">net_if</span><span class="p">(</span><span class="s">&quot;any&quot;</span><span class="p">),</span><span class="n">exp_compiled</span><span class="p">(</span><span class="nb">false</span><span class="p">){}</span>
</span><span class='line'>    <span class="o">~</span><span class="n">Sniffer</span><span class="p">(){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">handle</span><span class="p">){</span>
</span><span class='line'>            <span class="n">pcap_freecode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filter_code</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">exp_compiled</span><span class="p">){</span>
</span><span class='line'>            <span class="n">pcap_close</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">string</span> <span class="n">help</span><span class="p">(){</span>
</span><span class='line'>        <span class="n">string</span> <span class="n">h</span><span class="p">(</span><span class="s">&quot;avaliable net_interface:&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">pcap_if_t</span><span class="o">*</span> <span class="n">alldev</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">pcap_findalldevs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alldev</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">)){</span>
</span><span class='line'>            <span class="k">for</span><span class="p">(</span><span class="kt">pcap_if_t</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span><span class="n">alldev</span><span class="p">;</span><span class="nb">NULL</span><span class="o">!=</span><span class="n">dev</span><span class="p">;</span><span class="n">dev</span><span class="o">=</span><span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">next</span><span class="p">){</span>
</span><span class='line'>                <span class="n">h</span><span class="o">+=</span><span class="n">dev</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>                <span class="n">h</span><span class="o">+=</span><span class="s">&quot; &quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">pcap_freealldevs</span><span class="p">(</span><span class="n">alldev</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span> <span class="n">default_if</span><span class="o">=</span><span class="n">pcap_lookupdev</span><span class="p">(</span><span class="n">errbuf</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">default_if</span><span class="p">){</span>
</span><span class='line'>            <span class="n">h</span><span class="o">+=</span><span class="s">&quot; default interface:&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="n">h</span><span class="o">+=</span><span class="n">default_if</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">string</span> <span class="n">err</span><span class="p">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">pcap_geterr</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">configure</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span> <span class="n">net_interface</span><span class="p">,</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span> <span class="n">exp</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">net_interface</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">net_if</span><span class="o">=</span><span class="n">net_interface</span><span class="p">;</span>
</span><span class='line'>        <span class="n">cap_exp</span><span class="o">=</span><span class="n">exp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">!=</span><span class="n">pcap_lookupnet</span><span class="p">(</span><span class="n">net_if</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="o">&amp;</span><span class="n">netp</span><span class="p">,</span><span class="o">&amp;</span><span class="n">maskp</span><span class="p">,</span><span class="n">errbuf</span><span class="p">)){</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">handle</span><span class="o">=</span><span class="n">pcap_create</span><span class="p">(</span><span class="n">net_if</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="n">errbuf</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">NULL</span><span class="o">==</span><span class="n">handle</span><span class="p">){</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">!=</span><span class="n">pcap_activate</span><span class="p">(</span><span class="n">handle</span><span class="p">)){</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//ignore:?</span>
</span><span class='line'>        <span class="c1">//pcap_set_snaplen</span>
</span><span class='line'>        <span class="c1">//pcap_set_promisc</span>
</span><span class='line'>        <span class="c1">//pcap_set_rfmon</span>
</span><span class='line'>        <span class="c1">//pcap_set_timeout</span>
</span><span class='line'>        <span class="c1">//pcap_set_buffer_size</span>
</span><span class='line'>        <span class="c1">//pcap_set_tstamp_type</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//only cap ethernet packet</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">DLT_EN10MB</span><span class="o">!=</span><span class="n">pcap_datalink</span><span class="p">(</span><span class="n">handle</span><span class="p">)){</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="o">!=</span><span class="n">pcap_compile</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter_code</span><span class="p">,</span> <span class="n">cap_exp</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maskp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">exp_compiled</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="o">!=</span><span class="n">pcap_setfilter</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter_code</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">loop</span><span class="p">(</span><span class="kt">int</span> <span class="n">pkg_num</span><span class="o">=-</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>        <span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pcap_handler</span><span class="p">)(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcap_pkthdr</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
</span><span class='line'>                <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">bytes</span><span class="p">);</span>
</span><span class='line'>        <span class="n">pcap_loop</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="n">pkg_num</span><span class="p">,</span><span class="o">&amp;</span><span class="p">(</span><span class="n">Sniffer</span><span class="o">::</span><span class="n">pcap_callback</span><span class="p">),(</span><span class="n">u_char</span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="kt">void</span> <span class="n">pcap_callback</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcap_pkthdr</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
</span><span class='line'>        <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">bytes</span><span class="p">){</span>
</span><span class='line'>    <span class="n">Sniffer</span> <span class="o">*</span> <span class="n">p_this</span><span class="o">=</span><span class="p">(</span><span class="n">Sniffer</span><span class="o">*</span><span class="p">)</span> <span class="n">user</span><span class="p">;</span>
</span><span class='line'>    <span class="n">p_this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">dispatch</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">bytes</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">dispatch</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pcap_pkthdr</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">bytes</span><span class="p">){</span>
</span><span class='line'>        <span class="n">got_packet</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">bytes</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">pcap_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>             <span class="c1">// packet capture handle </span>
</span><span class='line'>    <span class="n">string</span> <span class="n">net_if</span><span class="p">;</span> <span class="c1">//e.g. &quot;eth0&quot;</span>
</span><span class='line'>    <span class="n">string</span> <span class="n">cap_exp</span><span class="p">;</span> <span class="c1">//e.g &quot;tcp and dst port 80&quot;</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">exp_compiled</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">bpf_program</span> <span class="n">filter_code</span><span class="p">;</span>         <span class="c1">// compiled filter program (expression) </span>
</span><span class='line'>    <span class="n">bpf_u_int32</span> <span class="n">netp</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bpf_u_int32</span> <span class="n">maskp</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">errbuf</span><span class="p">[</span><span class="n">PCAP_ERRBUF_SIZE</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[开始写博客]]></title>
    <link href="https://blog.helong.info//blog/2013/07/11/%25e5%25bc%2580%25e5%25a7%258b%25e5%2586%2599%25e5%258d%259a%25e5%25ae%25a2/"/>
    <updated>2013-07-11T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2013/07/11/%e5%bc%80%e5%a7%8b%e5%86%99%e5%8d%9a%e5%ae%a2</id>
    <content type="html"><![CDATA[<p>我开始在这写博客了。</p>

<p>这个博客专注在技术方面，C++，Linux，等等，务求原创，务求深度。</p>

<p>可能还会有一些文字。</p>

<p>早于此的，是从cnblogs上迁移过来的文章，基本写于学生时期。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[圆形坠落模拟算法设计]]></title>
    <link href="https://blog.helong.info//blog/2012/07/25/%25e5%259c%2586%25e5%25bd%25a2%25e5%259d%25a0%25e8%2590%25bd%25e6%25a8%25a1%25e6%258b%259f%25e7%25ae%2597%25e6%25b3%2595%25e8%25ae%25be%25e8%25ae%25a1/"/>
    <updated>2012-07-25T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2012/07/25/%e5%9c%86%e5%bd%a2%e5%9d%a0%e8%90%bd%e6%a8%a1%e6%8b%9f%e7%ae%97%e6%b3%95%e8%ae%be%e8%ae%a1</id>
    <content type="html"><![CDATA[<p>目标：实现一个算法，模拟在一个封闭二维区域，圆形小球朝给定方向坠落的过程，实现二维区域的紧密填充。</p>

<p>像下面这样：</p>

<p><img src="https://blog.helong.info//images/blog/2012072600504753.png"></p>

<p>难点，及其简单解决：</p>

<p>1.如何把粒子移动尽可能远？</p>

<p><img src="https://blog.helong.info//images/blog/2012072601011361.png"></p>

<p>图中的粒子i，能往下移动多远？一般情况,碰撞？边界？</p>

<p>一个简单解法：</p>

<!--more-->


<p>注意如下事实：判断两个粒子是否重叠，判断粒子是否和边 界线重叠，都是十分容易的。</p>

<p>据此定义函数 f &reg; 如下</p>

<p><img src="https://blog.helong.info//images/blog/2012072601024742.png"></p>

<p>考虑把粒子往前推的过程，最开始 f &reg; = 1，当推进到一个临界值后，f &reg; = 0,</p>

<p>因此，f &reg; 的函数图像是：</p>

<p><img src="https://blog.helong.info//images/blog/2012072601032995.png"></p>

<p>代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">//找出一个点，在一个方向上最远可以前进多远，限于一步之内，该点可以不属于这个mesh，如果不能前进，返回false</span>
</span><span class='line'><span class="kt">bool</span> <span class="nf">most_advance</span><span class="p">(</span><span class="n">Point</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span><span class="kt">double</span> <span class="n">direc_x</span><span class="p">,</span><span class="kt">double</span> <span class="n">direc_y</span><span class="p">,</span><span class="n">Mesh</span> <span class="o">*</span><span class="n">mesh</span><span class="p">,</span><span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span><span class="kt">double</span> <span class="o">&amp;</span><span class="n">best</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">//二分法求根。</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">can_move</span><span class="p">))</span>
</span><span class='line'>                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">double</span> <span class="n">low_radio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">double</span> <span class="n">high_radio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">;</span><span class="c1">//mesh-&gt;x_num + mesh-&gt;y_num;</span>
</span><span class='line'>        <span class="n">best</span><span class="o">=</span><span class="n">low_radio</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">bool</span> <span class="n">at_least_one_success</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">double</span> <span class="n">mid</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">double</span> <span class="n">step</span><span class="o">=</span><span class="n">mesh</span><span class="o">-&gt;</span><span class="n">get_step</span><span class="p">();</span>
</span><span class='line'>        <span class="n">Point</span> <span class="n">new_point</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">low_radio</span><span class="o">-</span><span class="n">high_radio</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.000001</span><span class="p">){</span>
</span><span class='line'>                <span class="n">mid</span><span class="o">=</span><span class="p">(</span><span class="n">low_radio</span><span class="o">+</span><span class="n">high_radio</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'>                <span class="n">new_point</span><span class="p">.</span><span class="n">x</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="n">direc_x</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="n">mid</span><span class="p">;</span>
</span><span class='line'>                <span class="n">new_point</span><span class="p">.</span><span class="n">y</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">+</span> <span class="n">direc_y</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="n">mid</span><span class="p">;</span>
</span><span class='line'>                <span class="kt">bool</span> <span class="n">result</span><span class="o">=</span><span class="n">mesh</span><span class="o">-&gt;</span><span class="n">can_move_point</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">new_point</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">){</span>
</span><span class='line'>                        <span class="n">low_radio</span><span class="o">=</span><span class="n">mid</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">best</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">best</span><span class="p">,</span><span class="n">mid</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">at_least_one_success</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                        <span class="n">high_radio</span><span class="o">=</span><span class="n">mid</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="c1">//cout&lt;&lt;&quot;mid=&quot;&lt;&lt;mid&lt;&lt;&quot; best=&quot;&lt;&lt;best&lt;&lt;&quot; result=&quot;&lt;&lt;result&lt;&lt;endl;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">at_least_one_success</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">x</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="n">direc_x</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="n">best</span><span class="p">;</span>
</span><span class='line'>        <span class="n">y</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">+</span> <span class="n">direc_y</span> <span class="o">*</span> <span class="n">step</span> <span class="o">*</span> <span class="n">best</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[翻译]轻松7步，导出Y结合子]]></title>
    <link href="https://blog.helong.info//blog/2012/04/09/%25e7%25bf%25bb%25e8%25af%2591%25e8%25bd%25bb%25e6%259d%25be7%25e6%25ad%25a5%25ef%25bc%258c%25e5%25af%25bc%25e5%2587%25bay%25e7%25bb%2593%25e5%2590%2588%25e5%25ad%2590/"/>
    <updated>2012-04-09T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2012/04/09/%e7%bf%bb%e8%af%91%e8%bd%bb%e6%9d%be7%e6%ad%a5%ef%bc%8c%e5%af%bc%e5%87%bay%e7%bb%93%e5%90%88%e5%ad%90</id>
    <content type="html"><![CDATA[<p>本文译自 &#8220;<em>Deriving the Y Combinator in 7 Easy Steps</em>&#8220;，</p>

<p>原文链接：<a href="http://igstan.ro/posts/2010-12-01-deriving-the-y-combinator-in-7-easy-steps.html">http://igstan.ro/posts/2010-12-01-deriving-the-y-combinator-in-7-easy-steps.html</a></p>

<p>在没有原生递归支持的语言中，Y结合子（<a href="http://en.wikipedia.org/wiki/Fixed_point_combinator" target="_blank">Y Combinator</a>）是一种实现递归的方式（事实上，它更常被作为一种锻炼程序思维的方式）。要实现Y结合子，要求这种语言支持匿名函数。</p>

<p>此处，我选择JavaScript来推导Y结合子，从递归阶乘函数的定义开始，一步一步进行变换。</p>

<a name="Step.1"></a>
<h2>Step 1</h2>

<p>最初的实现，使用JavaScript内建的递归机制。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">fact</span><span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>&nbsp;</p>

<a name="Step.2"></a>
<h2>Step 2</h2>

<p>获得递归的最简单方法是什么？我们可以定义一个函数，它接受它自身作为参数，并且用这个参数作为参数，调用这个参数。当然，这是一个无限循环，会导致栈溢出。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们的阶乘函数套用上面的模板，再做点改动，阶乘函数接受一个我们还不知道的参数，所以我们要的是返回一个接受该参数的函数。然后这个函数可以被用于计算阶乘。同时，这可以让我们的阶乘函数不会无限循环下去。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 终止条件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//因为f返回一个函数，所以这有一个双重调用。 </span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 终止条件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 因为f返回一个函数，所以这有一个双重调用。</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<a name="Step.3"></a>
<h2>Step 3</h2>

<p>此时，我们的代码有一些糟糕的重复，让我们把放进一个名叫recur的辅助函数里。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">recur</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="nx">recur</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 因为f返回一个函数，所以这有一个双重调用。</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Step.4"></a>
<h2>Step 4</h2>

<p>上面这个版本的问题是，它有两重调用（指的是f(f)(n-1)）。我们想去除它，让我们的函数跟接近于递归版本。怎么做呢？</p>

<p>我们可以使用一个辅助函数，它接受一个数值参数，进行两重调用。这个trick通过把辅助函数放在可见f的作用域里，所以g可以调用f。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">recur</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="nx">recur</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 没有双重调用了，函数g接受一个数值参数。</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">g</span><span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Step.5"></a>
<h2>Step 5</h2>

<p>以上版本工作良好，但是它的定义太杂乱了。我们可以把它再清理为一个辅助函数，把阶乘定义尽可能分离出来。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">recur</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">recur</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="nx">wrap</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">g</span><span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Step.6"></a>
<h2>Step 6</h2>

<p>g只调用了一次，让我们把g内联进wrap里。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">recur</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">recur</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="nx">wrap</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">g</span><span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Step.7"></a>
<h2>Step 7</h2>

<p>现在，如果我们把recur也内联进wrap里，我们就得到了著名的<strong>Y结合子</strong>！</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Y</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'>    <span class="p">})(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">n</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fact</span> <span class="o">=</span> <span class="nx">Y</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">g</span><span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<a name="The.End"></a>
<h2>The End</h2>

<p>玩的开心！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一个基于约束传播的，玩具级微型计算语言的设计和简单实现]]></title>
    <link href="https://blog.helong.info//blog/2012/04/09/%25e4%25b8%2580%25e4%25b8%25aa%25e5%259f%25ba%25e4%25ba%258e%25e7%25ba%25a6%25e6%259d%259f%25e4%25bc%25a0%25e6%2592%25ad%25e7%259a%2584%25ef%25bc%258c%25e7%258e%25a9%25e5%2585%25b7%25e7%25ba%25a7%25e5%25be%25ae%25e5%259e%258b%25e8%25ae%25a1%25e7%25ae%2597%25e8%25af%25ad%25e8%25a8%2580%25e7%259a%2584%25e8%25ae%25be%25e8%25ae%25a1/"/>
    <updated>2012-04-09T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2012/04/09/%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%e7%ba%a6%e6%9d%9f%e4%bc%a0%e6%92%ad%e7%9a%84%ef%bc%8c%e7%8e%a9%e5%85%b7%e7%ba%a7%e5%be%ae%e5%9e%8b%e8%ae%a1%e7%ae%97%e8%af%ad%e8%a8%80%e7%9a%84%e8%ae%be%e8%ae%a1</id>
    <content type="html"><![CDATA[<p>这个程序就是做来玩和练习的，代码是玩具级别的，用的python，基本可以正常工作了。</p>

<p>先介绍应用背景：</p>

<p>在流体机械设计中，通常根据性能参数进行设计，算出其它变量，但问题是，在设计过程中，需要进行变量的<strong>手工调整</strong>，例如圆整，修正到某一范围，校核等等。</p>

<p>其计算模式举例如下：</p>

<p>1.定义变量，如输入压力P<sub><span style="font-size: 12px;">in</span></sub>=0.98，输入温度T<sub>in</sub>=27,输入流量Q<sub>vin</sub>=400,k<sub>v2，</sub>φ<sub>2r，</sub>b2，D2，u2，qin等等。。。</p>

<p>2.根据某些物理公式，算出几个新的量，如转速 n=33.9<em>sqrt(k<sub>v2</sub></em>φ<sub>2r<em></sub>b2/D2</em>(u2<sup>3</sup>)/qin)</p>

<p>3.把n从8296.93圆整为整数8300，</p>

<p>4.重新计算b2/D2=0.06455，校核可知0.02&lt;0.06455&lt;0.065，符合要求</p>

<p>5.根据n计算出其它新的变量，修正，校核。。。</p>

<p>。。。</p>

<p>观察可以发现，这种计算模式，和《计算机程序的构造与解释》中提到的约束传播系统很像，如果把一个变量看作一个对象，那么，当它位于一个公式的左侧，例如n，也就意味着，右侧变量例如k<sub>v2</sub>更新时，应该给它发送一个消息，让它重新计算自己的值，当n更新后，如果它发现有别的变量依赖于自己，它应该发消息通知它们更新自己的值。</p>

<p>还可以看出，这种依赖关系形成了一个图，例如应该有一条从k<sub>v2</sub>到n的边，把n称为k<sub>v2</sub>的订阅者。</p>

<p>所以这种计算模式可以用约束传播系统建模，但是此处和书里的约束传播系统有差异：此处的约束传播系统是<strong>有向图</strong>，而书里是无向图，设计成有向图主要是为了简单，无向图的消息发送顺序是难以控制的，而且构造的时候公式中的每个变量都要持有其它对象的引用，太麻烦，有向图只需要在公式左侧的那个变量哪里保存公式右侧的每个变量的引用。</p>

<p>形成有向图后，每个变量的状态设为invaild，这种状态下，不会向它的会订阅者发送更新消息，收到获取值的消息时报错。</p>

<p>有向图中，还有一些源点，是最初给定值的变量。</p>

<p>当某个变量被赋值时，它把自己设为新值，同时向它的订阅者发送更新消息。订阅者计算自己的新值，如果和旧值相同，就沉默；否则，更新自己，通知订阅者更新。</p>

<p>so，想象一下，在你的面前，虚空之中漂浮着一张有向图， 由k<sub>v2</sub>&#8212;>n这样的一条条边练成，当一个点被赋予值，从这点荡出一圈圈涟漪，传到它的下一级，再从更新过的点荡出新的波纹，传开，传开。。。直到所有的点都收敛，水面恢复宁静。</p>

<p>&nbsp;</p>

<!--more-->


<p>好了，说代码，每一个变量都要保存它的订阅者，它的表达式，注意到，数字1.1是一种变量，变量a是一种表达式，所以代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c"># -*- coding: utf-8 -*-</span>
</span><span class='line'>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">变量is-a表达式</span>
</span><span class='line'><span class="sd">数值is-a表达式</span>
</span><span class='line'><span class="sd">故有如下继承关系</span>
</span><span class='line'>
</span><span class='line'><span class="sd">通过env的符号表可以查到Expr的实例</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Expr&#39;</span><span class="p">,</span><span class="s">&#39;Var&#39;</span><span class="p">,</span><span class="s">&#39;Number&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Expr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="n">op</span><span class="o">=</span><span class="s">&quot;&quot;</span>               <span class="c">#a function</span>
</span><span class='line'>    <span class="n">parameters</span><span class="o">=</span><span class="p">[]</span>       <span class="c">#Expr list</span>
</span><span class='line'>    <span class="n">desc</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">paras</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">=</span><span class="n">op</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">=</span><span class="n">paras</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">pl</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="o">*</span><span class="n">pl</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="o">=</span><span class="n">d</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">pas</span><span class="o">=</span><span class="p">[]</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
</span><span class='line'>            <span class="n">pas</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
</span><span class='line'>        <span class="n">pas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pas</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Number</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
</span><span class='line'>    <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">v</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Var</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
</span><span class='line'>    <span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="n">desc</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="n">expr</span><span class="o">=</span><span class="bp">None</span>
</span><span class='line'>    <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span>
</span><span class='line'>    <span class="n">subscribers</span><span class="o">=</span><span class="p">[]</span>
</span><span class='line'>    <span class="n">state</span><span class="o">=</span><span class="s">&quot;invaild&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">=</span><span class="s">&quot;invaild&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
</span><span class='line'>            <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">=</span><span class="s">&quot;normal&quot;</span>
</span><span class='line'>        <span class="n">new_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">new_value</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exp</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">=</span><span class="n">exp</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">Number</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">v</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">=</span><span class="s">&quot;normal&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">==</span><span class="s">&quot;invaild&quot;</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span class='line'>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">==</span><span class="s">&quot;normal&quot;</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">subs</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">expr_d</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
</span><span class='line'>            <span class="n">expr_d</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="n">expr_d</span><span class="c">#+&quot; &quot;+self.desc</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
</span><span class='line'>    <span class="n">a</span><span class="o">=</span><span class="n">Var</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="s">&quot;变量a&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">b</span><span class="o">=</span><span class="n">Var</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="s">&quot;变量b&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">test</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>所有的变量当然是要保存到一个符号表（或称环境）里的，同时，这个环境里还要有加减乘除，sin，sqrt这样的基本运算的定义，pi，e这样的常数的定义，python的operator和math模块就够用了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c"># -*- coding: utf-8 -*-</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">math</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">operator</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">expr</span> <span class="kn">import</span> <span class="n">Var</span><span class="p">,</span><span class="n">Number</span><span class="p">,</span><span class="n">Expr</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">parser</span> <span class="kn">import</span> <span class="n">Parser</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CmdFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">env</span><span class="p">,</span><span class="n">input_file</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">=</span><span class="n">env</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">=</span><span class="n">input_file</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">s</span>
</span><span class='line'>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">filter_cmd</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">s</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Env</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    求值环境，提供变量符号表和函数符号表</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">symbol_table</span><span class="o">=</span><span class="p">{}</span> <span class="c">#存放变量</span>
</span><span class='line'>    <span class="n">expr_table</span><span class="o">=</span><span class="p">[]</span>   <span class="c">#存放自由表达式</span>
</span><span class='line'>    <span class="n">function_table</span><span class="o">=</span><span class="p">{}</span><span class="c">#存放函数，对外只读</span>
</span><span class='line'>    <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;dump&#39;</span><span class="p">,</span><span class="s">&#39;run&#39;</span><span class="p">]</span>    <span class="c">#env先于parser处理掉一些命令,如dump</span>
</span><span class='line'>    <span class="n">parser</span><span class="o">=</span><span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">fill_function_table</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">fill_symbol_table</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">=</span><span class="n">Parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;-&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">dump all variables and expressions:&quot;</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class='line'>            <span class="k">print</span> <span class="n">k</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">all checkings:&quot;</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr_table</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span><span class="s">&quot;=&quot;</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;-&quot;</span><span class="o">*</span><span class="mi">70</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span class='line'>            <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">fill_function_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="c">#算术运算符</span>
</span><span class='line'>        <span class="c">#1.+,-,*,/,^,=,(,)   算术运算符</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;+&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;-&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">div</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;^&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">pow</span>
</span><span class='line'>        <span class="c">#逻辑运算符</span>
</span><span class='line'>        <span class="c">#2.==,&gt;=,&gt;,&amp;lt;=,&amp;lt;,!=   逻辑运算符</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;==&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;&gt;=&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">ge</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;&gt;&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">gt</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;&amp;lt;=&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">le</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;&amp;lt;&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">lt</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;!=&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">ne</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;sqrt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;sin&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;cos&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;tan&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">tan</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;asin&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;acos&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;atan&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">atan</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;exp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;pow&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;factorial&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;fabs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;ln&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="s">&#39;log10&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">fill_symbol_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="s">&#39;pi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Number</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="s">&#39;e&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">Number</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">add_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">expr_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">var</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">var</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">filter_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
</span><span class='line'>        <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmds</span><span class="p">:</span>
</span><span class='line'>            <span class="n">fun</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>            <span class="n">fun</span><span class="p">()</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">s</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">exec_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">in_file</span><span class="p">):</span>
</span><span class='line'>        <span class="n">input_file</span><span class="o">=</span><span class="n">CmdFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">in_file</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
</span><span class='line'>    <span class="n">env</span><span class="o">=</span><span class="n">Env</span><span class="p">()</span>
</span><span class='line'>    <span class="n">env</span><span class="o">.</span><span class="n">exec_stream</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">test</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来，词法分析和语法分析，词法分析没有手写，也没有用flex那样的工具，直接用了一排正则表达式，挨个往下匹配，匹配上了就返回。</p>

<p>严格来说，这个是不太好的，此处的词法分析原理上是不能和flex比的，flex里的多个正则表达式是合并到一个NFA里，再转化成一个DFA的，所以它的规则首先是最长优先，其次是长度相同时写在前面的优先，此处只有写在前面的优先，不太好。</p>

<p>语法分析是递归下降文法分析。一行一行地分析，一行是一个token的list。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c"># -*- coding: utf-8 -*-</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">expr</span> <span class="kn">import</span> <span class="n">Var</span><span class="p">,</span><span class="n">Number</span><span class="p">,</span><span class="n">Expr</span>
</span><span class='line'>
</span><span class='line'><span class="sd">&quot;&quot;&quot; 把</span>
</span><span class='line'><span class="sd">a=1+b+c^2</span>
</span><span class='line'><span class="sd">c=2</span>
</span><span class='line'><span class="sd">b=c+2</span>
</span><span class='line'><span class="sd">这样的一行一行，分成</span>
</span><span class='line'><span class="sd">ID ASSIGN ADD ID ADD EQ POW 2 EOL</span>
</span><span class='line'><span class="sd">ID ASSIGN 2 EOL</span>
</span><span class='line'><span class="sd">ID ASSIGN ID ADD 2 EOL</span>
</span><span class='line'><span class="sd">这样的一行一行token,</span>
</span><span class='line'><span class="sd">输出是一行一个token list的形式</span>
</span><span class='line'>
</span><span class='line'><span class="sd">token分为如下几类:</span>
</span><span class='line'><span class="sd">1.+,-,*,/,^,=,(,),,   算术运算符</span>
</span><span class='line'><span class="sd">2.==,&gt;=,&gt;,&lt;=,&lt;,!=   逻辑运算符</span>
</span><span class='line'><span class="sd">3.[0-9]+\.[0-9]*[Ee][+-]?[0-9]+  [0-9]+ 字面浮点数和整数</span>
</span><span class='line'><span class="sd">4.[a-zA-Z_]+        变量或函数名称标识符</span>
</span><span class='line'><span class="sd">5.[ \\t\\n]           忽略，或结束</span>
</span><span class='line'>
</span><span class='line'><span class="sd">由于使用正则表达式直接匹配，所以和flex不同的是:</span>
</span><span class='line'><span class="sd">无法确保当有多个匹配项时，最长优先,因此，只能利用先后顺序解决冲突，</span>
</span><span class='line'><span class="sd">因而必须把==放在=前面。</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">logic_op_re</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;==|&gt;=|&gt;|&lt;=|&lt;|!=&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">number_re</span>  <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[+-]?[0-9]+\.?[0-9]*[Ee]?[+-]?[0-9]?&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">arith_op_re</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\+|-|\*|/|\^|=|\(|\)|,&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">int_re</span>     <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[0-9]+&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">id_re</span>      <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[a-zA-Z_]+&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">blank_re</span>   <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[\ |\t|\r]+&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">comment_re</span> <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&quot;([^&quot;]*)&quot;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">other_re</span>   <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;.+&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">scanner</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</span><span class='line'>    <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">logic_op_re</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;logic_op&#39;</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">number_re</span>  <span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;number&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">())))</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">arith_op_re</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;arith_op&#39;</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">int_re</span>     <span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;number&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">())))</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">id_re</span>      <span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">comment_re</span> <span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;comment&#39;</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">blank_re</span>   <span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">other_re</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;亲，看看你都塞了一堆什么进来呀？</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> 人家好伤心的呀！&quot;</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Parser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot; 文法分析： &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">input_file</span><span class="o">=</span><span class="bp">None</span>
</span><span class='line'>    <span class="n">env</span><span class="o">=</span><span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">env</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">=</span><span class="n">env</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_file</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        如入可以是sys.stdin,a file,a string</span>
</span><span class='line'><span class="sd">        要求实现readline()方法</span>
</span><span class='line'><span class="sd">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">=</span><span class="n">input_file</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">line</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span><span class='line'>                <span class="k">return</span>
</span><span class='line'>            <span class="n">tokens</span><span class="o">=</span><span class="n">scanner</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c">#把字母名称的函数标示出来</span>
</span><span class='line'>            <span class="n">r</span><span class="o">=</span><span class="p">[]</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;id&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span class='line'>                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;function&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span class='line'>                <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">tokens</span><span class="o">=</span><span class="n">r</span>
</span><span class='line'>
</span><span class='line'>            <span class="c">#把comment提取出来</span>
</span><span class='line'>            <span class="n">comments</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>                         <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;comment&quot;</span><span class="p">,</span><span class="n">tokens</span><span class="p">))</span>
</span><span class='line'>            <span class="n">comments</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
</span><span class='line'>            <span class="n">tokens</span><span class="o">=</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot;comment&quot;</span><span class="p">,</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c">#含有=的表达式是约束方程，其它的都是expr</span>
</span><span class='line'>            <span class="n">c</span><span class="o">=</span><span class="n">tokens</span><span class="o">.</span><span class="n">count</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;arith_op&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">))</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                <span class="c">#没有约束到变量的表达式</span>
</span><span class='line'>                <span class="n">e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_expr</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>                <span class="c">#e.set_desc(comments)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">add_expr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>                <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">c</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                <span class="k">print</span> <span class="s">&quot;亲，赋值一次就够了，你肿么赋值了&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;次涅？&quot;</span>
</span><span class='line'>                <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>            <span class="c">#c=1</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&#39;id&#39;</span> <span class="ow">or</span> \
</span><span class='line'>               <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="p">(</span><span class="s">&#39;arith_op&#39;</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">):</span>
</span><span class='line'>                <span class="k">print</span> <span class="s">&quot;亲，你给我的表达式格式有问题偶～:&quot;</span><span class="o">+</span><span class="n">line</span>
</span><span class='line'>                <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">var_name</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                <span class="n">var</span><span class="o">=</span><span class="n">Var</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span><span class="n">comments</span><span class="p">)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span><span class="n">var</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_expr</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
</span><span class='line'>            <span class="n">var</span><span class="o">.</span><span class="n">set_expr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        token分为如下几类:</span>
</span><span class='line'><span class="sd">        1.+,-,*,/,^,=,(,),,   算术运算符</span>
</span><span class='line'><span class="sd">        2.==,&gt;=,&gt;,&lt;=,&lt;,!=   逻辑运算符</span>
</span><span class='line'><span class="sd">        3.[0-9]+\.[0-9]*[Ee][+-]?[0-9]+  [0-9]+ 字面浮点数和整数</span>
</span><span class='line'><span class="sd">        4.[a-zA-Z_]+        变量或函数名称标识符</span>
</span><span class='line'><span class="sd">        5.[ \\t\\n]           忽略，或结束</span>
</span><span class='line'>
</span><span class='line'><span class="sd">        BNF:</span>
</span><span class='line'><span class="sd">        expr=expr[==|&gt;=|&gt;|&lt;=|&lt;|!=]expr|expr</span>
</span><span class='line'><span class="sd">        expr=expr+expr | expr-expr</span>
</span><span class='line'><span class="sd">        expr=expr*expr | expr/expr</span>
</span><span class='line'><span class="sd">        expr=expr^expr</span>
</span><span class='line'><span class="sd">        expr=function(expr[,expr])</span>
</span><span class='line'><span class="sd">        expr=(expr)</span>
</span><span class='line'><span class="sd">        expr=&lt;float&gt;|&lt;var&gt;</span>
</span><span class='line'><span class="sd">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>            <span class="n">expr</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_logic_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">expr</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#能处理就处理，不能处理原样返回。</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_logic_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="n">left</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_add_sub_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">rest</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">logic_op_list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;==&quot;</span><span class="p">,</span><span class="s">&quot;&gt;=&quot;</span><span class="p">,</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span><span class="s">&quot;&lt;=&quot;</span><span class="p">,</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="s">&quot;!=&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logic_op_list</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">rest</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>        <span class="n">right</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_add_sub_op</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Expr</span><span class="p">(</span><span class="n">op</span><span class="p">,[</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">]),</span><span class="n">rest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_add_sub_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="n">left</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_mul_div_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>        <span class="n">add_sub_op_list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;+&quot;</span><span class="p">,</span><span class="s">&quot;-&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">add_sub_op_list</span><span class="p">:</span>
</span><span class='line'>            <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="n">right</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_mul_div_op</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>            <span class="n">left</span><span class="o">=</span><span class="n">Expr</span><span class="p">(</span><span class="n">op</span><span class="p">,[</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">rest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_mul_div_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="n">left</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_pow_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>        <span class="n">mul_div_op_list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mul_div_op_list</span><span class="p">:</span>
</span><span class='line'>            <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="n">right</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_pow_op</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>            <span class="n">left</span><span class="o">=</span><span class="n">Expr</span><span class="p">(</span><span class="n">op</span><span class="p">,[</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">rest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_pow_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="n">left</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_function_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pow_op_list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;^&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pow_op_list</span><span class="p">):</span>
</span><span class='line'>            <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="n">right</span><span class="p">,</span><span class="n">rest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_pow_op</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>            <span class="n">left</span><span class="o">=</span><span class="n">Expr</span><span class="p">(</span><span class="n">op</span><span class="p">,[</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">])</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">rest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_function_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;number&#39;</span><span class="p">,</span><span class="s">&#39;id&#39;</span><span class="p">]:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_float_var_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;(&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_parentheses_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&#39;function&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">op</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;(&#39;</span><span class="p">:</span>
</span><span class='line'>                <span class="n">paras</span><span class="o">=</span><span class="p">[]</span>
</span><span class='line'>                <span class="n">tokens</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</span><span class='line'>                <span class="n">left</span><span class="p">,</span><span class="n">tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_add_sub_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>                <span class="n">paras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
</span><span class='line'>                <span class="k">while</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;,&#39;</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">left</span><span class="p">,</span><span class="n">tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_add_sub_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>                    <span class="n">paras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;)&#39;</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">tokens</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>                <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                    <span class="k">print</span> <span class="s">&quot;bad syntax. tokens found -&gt;&quot;</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">expr</span><span class="o">=</span><span class="n">Expr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="n">paras</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">expr</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;error bad syntax -&gt;&quot;</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_parentheses_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;(&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">left</span><span class="p">,</span><span class="n">tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_logic_op</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;)&#39;</span><span class="p">:</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">parse_float_var_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tokens</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;number&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">n</span><span class="o">=</span><span class="n">Number</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">n</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
</span><span class='line'>                <span class="n">var_name</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                <span class="n">var</span><span class="o">=</span><span class="n">Var</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span><span class="n">var</span><span class="p">)</span>
</span><span class='line'>                <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">var</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="n">tokens</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">StringIO</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">env</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
</span><span class='line'>    <span class="n">s</span><span class="o">=</span><span class="s">&quot;&quot;&quot; a=1+(b+c)^2/23.1e-10 &quot;变量a&quot;</span>
</span><span class='line'><span class="s">    c=2  &quot;变量c&quot; &quot;c是个好变量&quot;</span>
</span><span class='line'><span class="s">    b=c+2 &quot;变量b&quot; &quot;b也是个好变量&quot; &quot;这是为它写的第三条注释&quot;</span>
</span><span class='line'><span class="s">    a&gt;c  &quot;检查a是否大于c&quot;</span>
</span><span class='line'><span class="s">    a&gt;=c  &quot;检查a是否大于等于c&quot;</span>
</span><span class='line'><span class="s">    run</span>
</span><span class='line'><span class="s">    dump</span>
</span><span class='line'><span class="s">    c=3   &quot;change c again.&quot;</span>
</span><span class='line'><span class="s">    &quot;注释也可以在前面&quot; c^2&gt;=sin(pow(a,b)+b)</span>
</span><span class='line'><span class="s">    run</span>
</span><span class='line'><span class="s">    dump</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="c">#for l in s.split(&#39;\n&#39;):</span>
</span><span class='line'>    <span class="c">#    scanner(l)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;+&quot;</span><span class="o">*</span><span class="mi">80</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;*&#39;</span><span class="o">*</span><span class="mi">70</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">s</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;*&#39;</span><span class="o">*</span><span class="mi">70</span>
</span><span class='line'>    <span class="n">e</span><span class="o">=</span><span class="n">Env</span><span class="p">()</span>
</span><span class='line'>    <span class="n">i</span><span class="o">=</span><span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>    <span class="n">e</span><span class="o">.</span><span class="n">exec_stream</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;+&quot;</span><span class="o">*</span><span class="mi">80</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">test</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>  最后是个main.py</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c"># -*- coding: utf-8 -*-</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">env</span> <span class="kn">import</span> <span class="n">Env</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">StringIO</span>
</span><span class='line'>
</span><span class='line'><span class="n">e</span><span class="o">=</span><span class="n">Env</span><span class="p">()</span>
</span><span class='line'><span class="n">e</span><span class="o">.</span><span class="n">exec_stream</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span><span class="o">=</span><span class="s">&quot;&quot;&quot; x=-1&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">i</span><span class="o">=</span><span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="n">e</span><span class="o">.</span><span class="n">exec_stream</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[sicp练习2.42 [解8皇后问题的Scheme语言实现]]]></title>
    <link href="https://blog.helong.info//blog/2011/12/22/sicp%25e7%25bb%2583%25e4%25b9%25a02-42-%25e8%25a7%25a38%25e7%259a%2587%25e5%2590%258e%25e9%2597%25ae%25e9%25a2%2598%25e7%259a%2584scheme%25e8%25af%25ad%25e8%25a8%2580%25e5%25ae%259e%25e7%258e%25b0/"/>
    <updated>2011-12-22T00:00:00+00:00</updated>
    <id>https://blog.helong.info//blog/2011/12/22/sicp%e7%bb%83%e4%b9%a02-42-%e8%a7%a38%e7%9a%87%e5%90%8e%e9%97%ae%e9%a2%98%e7%9a%84scheme%e8%af%ad%e8%a8%80%e5%ae%9e%e7%8e%b0</id>
    <content type="html"><![CDATA[<p>代码框架来自sicp 练习2.42。算是作业吧。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">enumerate-interval</span> <span class="nv">l</span> <span class="nv">r</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">l</span> <span class="nv">r</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">list </span><span class="nv">l</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">cons </span><span class="nv">l</span> <span class="p">(</span><span class="nf">enumerate-interval</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">l</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">r</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;(enumerate-interval 1 10)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">contains?</span> <span class="nv">e</span> <span class="nv">pl</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">pl</span><span class="p">)</span>
</span><span class='line'>      <span class="no">#f</span>
</span><span class='line'>      <span class="p">(</span><span class="k">or </span><span class="p">(</span><span class="nb">eq? </span><span class="nv">e</span> <span class="p">(</span><span class="nb">car </span><span class="nv">pl</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">contains?</span> <span class="nv">e</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">pl</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;检查形如(2 1 4 3 2)这样的positions list中有没有重复元素,简单办法，hash会是更好的办法。</span>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">no-repeat?</span> <span class="nv">positions</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">positions</span><span class="p">)</span>
</span><span class='line'>      <span class="no">#t</span>
</span><span class='line'>      <span class="p">(</span><span class="k">and </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">contains?</span> <span class="p">(</span><span class="nb">car </span><span class="nv">positions</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">positions</span><span class="p">)))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">no-repeat?</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">positions</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;(no-repeat? &#39;(1 2))</span>
</span><span class='line'><span class="c1">;(no-repeat? &#39;(1 2 1))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;按理说应该检查一下rest-of-queens是不是length = (- k 1)...</span>
</span><span class='line'><span class="c1">;使用cons可以想象成把所有列往右移一列再把新的添到第一列，这样不影响safe?的判断，简单。</span>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">addjoin-position</span> <span class="nv">new-row</span> <span class="nv">k</span> <span class="nv">rest-of-queens</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">cons </span><span class="nv">new-row</span> <span class="nv">rest-of-queens</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">flatmap</span> <span class="nv">proc</span> <span class="nv">seq</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">foldr</span> <span class="nv">append</span> <span class="p">()</span> <span class="p">(</span><span class="nb">map </span><span class="nv">proc</span> <span class="nv">seq</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">safe?</span> <span class="nv">k</span> <span class="nv">positions</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;两个点在对角线上，也就是满足同一个方程x+y=n或x-y=n</span>
</span><span class='line'>  <span class="c1">;所以要判断两个点是不是在同一条“左下至右上对角线”上，</span>
</span><span class='line'>  <span class="c1">;只需要算出两个x-y，判断是否相等即可。左上至右下同理。</span>
</span><span class='line'>  <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">px-y</span> <span class="nv">pl</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="nv">+</span> <span class="nv">positions</span> <span class="p">(</span><span class="nf">enumerate-interval</span> <span class="mi">1</span> <span class="nv">k</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">px+y</span> <span class="nv">pl</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="nv">-</span> <span class="nv">positions</span> <span class="p">(</span><span class="nf">enumerate-interval</span> <span class="mi">1</span> <span class="nv">k</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">and</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">no-repeat?</span> <span class="nv">positions</span><span class="p">)</span><span class="c1">;不在同一行</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">no-repeat?</span> <span class="p">(</span><span class="nf">px-y</span> <span class="nv">positions</span><span class="p">))</span><span class="c1">;不在同一条“左下至右上对角线”上</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">no-repeat?</span> <span class="p">(</span><span class="nf">px+y</span> <span class="nv">positions</span><span class="p">))</span><span class="c1">;不在同一条“左上至右下对角线”上</span>
</span><span class='line'>   <span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;(safe? 1 &#39;(1))</span>
</span><span class='line'><span class="c1">;(safe? 2 &#39;(1 2))</span>
</span><span class='line'><span class="c1">;(safe? 3 &#39;(1 2 3))</span>
</span><span class='line'><span class="c1">;(safe? 4 &#39;(3 1 4 2))</span>
</span><span class='line'><span class="c1">;(safe? 4 &#39;(2 4 1 3))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;层次遍历状态空间树，剪掉每一层中不合适的分支后再扩展到下一层。</span>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">queens</span> <span class="nv">board-size</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">define </span><span class="nv">empty-board</span> <span class="p">())</span>
</span><span class='line'>  <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">queen-cols</span> <span class="nv">k</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">;一个布局表示成一个list,形如(2 4 1 3),表示第一列为2，第二列为2，第三列为1...</span>
</span><span class='line'>    <span class="c1">;queens-cols 返回((1,2,3)(2,1,3)(3,2,1))这样的布局组成的list</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">k</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="nv">empty-board</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">filter</span>
</span><span class='line'>         <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">positions</span><span class="p">)</span> <span class="p">(</span><span class="nf">safe?</span> <span class="nv">k</span> <span class="nv">positions</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">flatmap</span>
</span><span class='line'>          <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">reat-of-queens</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">new-row</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="nf">addjoin-position</span> <span class="nv">new-row</span> <span class="nv">k</span> <span class="nv">reat-of-queens</span><span class="p">))</span>
</span><span class='line'>                 <span class="p">(</span><span class="nf">enumerate-interval</span> <span class="mi">1</span> <span class="nv">board-size</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">queen-cols</span> <span class="p">(</span><span class="nb">- </span><span class="nv">k</span> <span class="mi">1</span><span class="p">))))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">queen-cols</span> <span class="nv">board-size</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;(queens 4)</span>
</span><span class='line'><span class="p">(</span><span class="nf">queens</span> <span class="mi">8</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>

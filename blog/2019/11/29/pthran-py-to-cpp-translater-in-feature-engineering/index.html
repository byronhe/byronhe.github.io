
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Python 自动翻译成 C++ ，彻底保证离线在线特征一致 - Tech Ideas</title>
  <meta name="author" content="byronhe">

  
  <meta name="description" content="一，问题背景 随着深度学习的广泛应用，在搜索引擎/推荐系统/机器视觉等业务系统中，越来越多的深度学习模型部署到线上服务。 机器学习模型在离线训练时，一般要将输入的数据做特征工程预处理，再输入模型在 TensorFlow PyTorch 等框架上做训练。 1.常见的特征工程逻辑 &hellip;">
  <meta name="keywords" content="python, C++, 特征工程">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://blog.helong.info//blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tech Ideas" type="application/atom+xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49290834-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tech Ideas</a></h1>
  
    <h2>C++,Linux,Algorithm,Crypto,Lisp,etc</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.helong.info/">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Python 自动翻译成 C++ ，彻底保证离线在线特征一致</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-11-29T13:54:00+00:00'><span class='date'>2019-11-29</span> <span class='time'>1:54 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><hr />

<a name="L.................."></a>
<h1>一，问题背景</h1>

<p>随着深度学习的广泛应用，在搜索引擎/推荐系统/机器视觉等业务系统中，越来越多的深度学习模型部署到线上服务。</p>

<p>机器学习模型在离线训练时，一般要将输入的数据做特征工程预处理，再输入模型在 TensorFlow PyTorch 等框架上做训练。</p>

<a name="L1............................"></a>
<h3>1.常见的特征工程逻辑</h3>

<p>常见的特征工程逻辑有：</p>

<ol>
<li>分箱/分桶 离散化</li>
<li>log/exp 对数/幂等 math numpy 常见数学运算</li>
<li>特征缩放/归一化/截断</li>
<li>交叉特征生成</li>
<li>分词匹配程度计算</li>
<li>字符串分隔匹配判断tong</li>
<li>缺省值填充等</li>
<li>数据平滑</li>
<li>onehot 编码，hash 编码等</li>
</ol>


<p>这些特征工程代码，当然一般使用深度学习最主要的语言 <strong>python</strong> 实现。</p>

<a name="L.................."></a>
<h1>二，业务痛点</h1>

<p>离线训练完成，模型上线部署后，同样要<strong>用 C++ 重新实现</strong> 这些 python 的特征工程逻辑代码。</p>

<p>我们发现，<strong>“用 C++ 重新实现”</strong> 这个步骤，给实际业务带来了大量的问题：</p>

<ol>
<li>繁琐，费时费力，极容易出现 python 和 C++ 代码<strong>不一致</strong></li>
<li><strong>不一致</strong>会直接影响模型在线上的效果，导致大盘业务指标不如预期，产生各种 bad case</li>
<li><strong>不一致</strong>难以发现，无法测试，无法监控，经常要靠用户投诉反馈，甚至大盘数据异常才能发现</li>
</ol>


<!--more-->


<a name="L1.............."></a>
<h3>1. 业界方案</h3>

<p>针对这些问题，我调研了这些业界方案：</p>

<p>《推荐系统中模型训练及使用流程的标准化》
<a href="https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3">https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3</a></p>

<p>《自主研发、不断总结经验，美团搜索推荐机器学习平台》
<a href="https://cloud.tencent.com/developer/article/1357309">https://cloud.tencent.com/developer/article/1357309</a></p>

<p>《京东电商推荐系统实践》
<a href="https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW">https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW</a></p>

<blockquote><p>“模型线上线下一致性问题对于模型效果非常重要，我们使用特征日志来实时记录特征，保证特征的一致性。这样离线处理的时候会把实时的用户反馈，和特征日志做一个结合生成训练样本，然后更新到模型训练平台上，平台更新之后在推送到线上，这样整个排序形成了一个闭环。”</p></blockquote>

<p>总结起来，有几种思路：</p>

<ol>
<li>在线特征存储起来给离线用</li>
<li>在线 C++ 代码编译成 so 导出给离线用</li>
<li>根据一份配置生成离线和在线代码</li>
<li>提取公共代码，加强代码复用，等软件工程手段，减少不一致</li>
</ol>


<a name="L2...................."></a>
<h3>2. 自动翻译方案</h3>

<a name="L.1........................"></a>
<h4>(1) .已有方案的缺点</h4>

<p>但这些思路都有各种缺点：</p>

<ol>
<li>所有在线请求的所有特征，这个存储量数据量很大</li>
<li>算法改代码需要等待后台开发，降低了算法同学的工作效率</li>
<li>特征处理代码的复杂度转移到配置文件中，不一定能充分表达，而且配置格式增加学习成本</li>
<li>就这边真实离线特征处理代码来看，大部分代码都无法抽取出公共代码做复用。</li>
</ol>


<a name="L.2............"></a>
<h4>(2). 翻译器</h4>

<p>回到问题出发点考虑，显而易见，这个问题归根结底就是需要一个 “ python 到 c++ 的翻译器 ” 。</p>

<p>那其实 “翻译器 Transpiler ” ，和编译器解释器类似，也是个古老的热门话题了，比如 <a href="https://webassembly.org/">WebAssembly</a>, <a href="https://coffeescript.org/">CoffeeScript </a>，<a href="https://www.babeljs.cn/docs/">Babel</a> ,
<a href="https://github.com/google/closure-compiler">Google Closure Compiler</a>，<a href="https://www.netlib.org/f2c/f2c.1">f2c</a></p>

<p>于是一番搜索，发现 python 到 C++ 的翻译器也不少，其中 <a href="https://github.com/serge-sans-paille/pythran">Pythran</a> 是新兴比较热门的开源项目。</p>

<p>于是一番尝试后，借助 pythran，我们实现了：</p>

<ol>
<li>一条命令 <strong>全自动把 Python 翻译成等价 C++</strong></li>
<li>严格等价保证改写，彻底消除不一致</li>
<li><strong>完全去掉重新实现</strong> 这块工作量，后台开发成本降到 0 ，彻底解放生产力</li>
<li>算法同学继续使用纯 python，开发效率无影响，<strong> 无学习成本 </strong></li>
<li>并能推广到其他需要 <strong>python 改写成后台 C++ 代码</strong> 的业务场景，解放生产力</li>
</ol>


<a name="L......pythran................"></a>
<h1>三，pythran 的使用流程</h1>

<a name="L.1........."></a>
<h3>(1). 安装</h3>

<p>一条命令安装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip3 install pythran
</span></code></pre></td></tr></table></div></figure>


<a name="L.2.......Python......."></a>
<h3>(2). 写 Python 代码</h3>

<p>下面这个 python demo，是 pythran 官方 demo</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">math</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">zero</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export matrix_multiply(float list list, float list list)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">matrix_multiply</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">):</span>
</span><span class='line'>    <span class="n">new_matrix</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">)):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">)):</span>
</span><span class='line'>                <span class="n">new_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">m0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">m1</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">new_matrix</span>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export arc_distance(float[], float[], float[], float[])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">arc_distance</span><span class="p">(</span><span class="n">theta_1</span><span class="p">,</span> <span class="n">phi_1</span><span class="p">,</span> <span class="n">theta_2</span><span class="p">,</span> <span class="n">phi_2</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Calculates the pairwise arc distance</span>
</span><span class='line'><span class="sd">    between all points in vector a and b.</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">theta_2</span><span class="o">-</span><span class="n">theta_1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span><span class='line'>           <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">phi_2</span><span class="o">-</span><span class="n">phi_1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">distance_matrix</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">temp</span><span class="p">))</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">distance_matrix</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export dprod(int list, int list)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">dprod</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;WoW, generator expression, zip and sum.&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">l1</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#pythran export get_age(int )</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_age</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;0_20&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;21_25&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;26_30&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">35</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;31_35&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;36_40&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">45</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;41_45&#39;</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;46_50&#39;</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">age_x</span> <span class="o">=</span> <span class="s">&#39;50+&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">age_x</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L.3...Python........C.."></a>
<h3>(3). Python 转成 C++</h3>

<p>一条命令完成翻译</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pythran -e demo.py -o  demo.hpp
</span></code></pre></td></tr></table></div></figure>


<a name="L.4.......C..............."></a>
<h3>(4). 写 C++ 代码调用</h3>

<p>pythran/pythonic/ 目录下是 python 标准库的 C++ 等价实现，翻译出来的C++ 代码需要 include 这些头文件</p>

<p>写个 C++ 代码调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &quot;demo.hpp&quot;</span>
</span><span class='line'><span class="cp">#include &quot;pythonic/numpy/random/rand.hpp&quot;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pythonic</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">pythonic</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span> <span class="n">m0</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">},</span>
</span><span class='line'>                                                             <span class="p">{</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">}</span> <span class="p">},</span>
</span><span class='line'>                                                       <span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">},</span>
</span><span class='line'>                                                             <span class="p">{</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">}</span> <span class="p">};</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">m0</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;*&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">=</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">matrix_multiply</span><span class="p">()(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">auto</span> <span class="n">theta_1</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>       <span class="n">phi_1</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>       <span class="n">theta_2</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span class='line'>       <span class="n">phi_2</span> <span class="o">=</span> <span class="n">pythonic</span><span class="o">::</span><span class="n">numpy</span><span class="o">::</span><span class="n">random</span><span class="o">::</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;arc_distance &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">theta_1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">phi_1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">theta_2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">phi_2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">=</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">arc_distance</span><span class="p">()(</span><span class="n">theta_1</span><span class="p">,</span> <span class="n">phi_1</span><span class="p">,</span> <span class="n">theta_2</span><span class="p">,</span> <span class="n">phi_2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pythonic</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">l0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="n">l1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dprod &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">l0</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">l1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">=</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">dprod</span><span class="p">()(</span><span class="n">l0</span><span class="p">,</span> <span class="n">l1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span>
</span><span class='line'>       <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;get_age 30 = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">__pythran_demo</span><span class="o">::</span><span class="n">get_age</span><span class="p">()(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L.5..............."></a>
<h3>(5). 编译运行</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>g++ -g -std<span class="o">=</span>c++11 main.cpp -fopenmp -march<span class="o">=</span>native -DUSE_XSIMD -I /usr/local/lib/python3.6/site-packages/pythran/ -o pythran_demo
</span><span class='line'>
</span><span class='line'>./pythran_demo
</span></code></pre></td></tr></table></div></figure>


<a name="L......pythran..................."></a>
<h1>四，pythran 的功能与特性</h1>

<a name="L.1........."></a>
<h3>(1). 介绍</h3>

<p>按官方定义，Pythran 是一个 AOT (Ahead-Of-Time - 预先编译) 编译器。 给科学计算的 python 加注解后，pythran 可以把 python 代码变成接口相同的原生 python 模块，大幅度提升性能。</p>

<p>并且 pythran 也可以利用 OpenMP 多核和 SIMD 指令集。</p>

<p>支持 python 3 和 Python 2.7 。</p>

<p>pythran 的 manual 挺详细：
<a href="https://pythran.readthedocs.io/en/latest/MANUAL.html">https://pythran.readthedocs.io/en/latest/MANUAL.html</a></p>

<a name="L.2........."></a>
<h3>(2). 功能</h3>

<p>pythran 并不支持完整的python， 只支持 python 语言特性的一个子集:</p>

<ul>
<li>polymorphic functions 多态函数(翻译成 C++ 的泛型模板函数)</li>
<li>lambda</li>
<li>list comprehension  列表推导式</li>
<li>map, reduce 等函数</li>
<li>dictionary, set, list 等数据结构</li>
<li>exceptions 异常</li>
<li>file handling 文件处理</li>
<li>部分 numpy</li>
</ul>


<p>不支持的功能：</p>

<ul>
<li>classes 类</li>
<li>polymorphic variables 可变类型变量</li>
</ul>


<a name="L.3................................."></a>
<h3>(3). 支持的数据类型和函数</h3>

<p>pythran export  可以导出函数和全局变量。
支持导出的数据类型，BNF 定义是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='antlr'><span class='line'><span class="nl">argument_type</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">basic_type</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">(argument_type+)</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">tuple</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="err">list</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">list</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="err">set</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">set</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[]</span><span class="err">+</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">C</span><span class="err">-style</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[</span><span class="x">::</span><span class="p">]</span><span class="err">+</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">strided</span><span class="w"> </span><span class="err">ndarray</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[</span><span class="x">:,...,:</span><span class="p">]</span><span class="err">+</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">Cython</span><span class="w"> </span><span class="err">style</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="w"> </span><span class="p">[</span><span class="x">:,...,3</span><span class="p">]</span><span class="err">+</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">ndarray</span><span class="p">,</span><span class="w"> </span><span class="nl">some</span><span class="w"> </span><span class="err">dimension</span><span class="w"> </span><span class="err">fixed</span><span class="w"></span>
</span><span class='line'><span class="w">              </span><span class="err">|</span><span class="w"> </span><span class="err">argument_type</span><span class="p">:</span><span class="nv">argument_type</span><span class="w"> </span><span class="nv">dict</span><span class="w">    </span><span class="o">#</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">dictionary</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nv">basic_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bool</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">byte</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">float</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">str</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">slice</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">uint8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uint16</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uint32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uint64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">uintp</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">int8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int16</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">int64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">intp</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">float32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">float64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">float128</span><span class="w"></span>
</span><span class='line'><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nv">complex64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">complex128</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">complex256</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到基础类型相当全面，支持各种 整数，浮点数，字符串，复数</p>

<p>复合类型支持 tuple, list, set, dict, numpy.ndarray 等，</p>

<p>对应 C++ 代码的类型实现在  pythran/pythonic/include/types/  下面，可以看到比如 dict 实际就是封装了一下 std::unordered_map
<a href="https://pythran.readthedocs.io/en/latest/SUPPORT.html">https://pythran.readthedocs.io/en/latest/SUPPORT.html</a>
可以看到支持的 python 基础库，其中常用于机器学习的 numpy 支持算比较完善。</p>

<a name="L......pythran................"></a>
<h1>五，pythran 的基本原理</h1>

<p>和常见的编译器/解释器类似， pythran 的架构是分成 3 层：</p>

<ol>
<li>python 代码解析成抽象语法树 AST 。用 python 标准库自带的的 ast 模块实现</li>
<li>代码优化。
 在 AST 上做优化，有多种 transformation pass，比如 deadcode_elimination 死代码消除，loop_full_unrolling  循环展开 等。还有 Function/Module/Node 级别的 Analysis，用来遍历 AST 供 transformation 利用。</li>
<li>后端，实现代码生成。目前有2个后端，Cxx / Python，  Cxx 后端可以把 AST 转成 C++ 代码（ Python 后端用来调试）。</li>
</ol>


<p>目前看起来 ，pythran 还欠缺的：</p>

<ol>
<li>字符串处理能力欠缺，缺少 str.encode()/str.decode() 对 utf8 的支持</li>
<li>缺少正则表达式 regex 支持</li>
<li>缺少 json 支持</li>
</ol>


<p>看文档要自己加也不麻烦，看业务需要可以加。</p>

<a name="L.................."></a>
<h1>六，相关文章</h1>

<p>《京东电商推荐系统实践》
<a href="https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW">https://www.infoq.cn/article/1OkKmb_gEYNR3YqC9RcW</a></p>

<p>《自主研发、不断总结经验，美团搜索推荐机器学习平台》
<a href="https://cloud.tencent.com/developer/article/1357309">https://cloud.tencent.com/developer/article/1357309</a></p>

<p>《推荐系统中模型训练及使用流程的标准化》
<a href="https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3">https://www.infoq.cn/article/2E6LCqb1GeqFRAjkkjX3</a></p>

<p>numba
<a href="http://numba.pydata.org">http://numba.pydata.org</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">byronhe</span></span>

      




<time class='entry-date' datetime='2019-11-29T13:54:00+00:00'><span class='date'>2019-11-29</span> <span class='time'>1:54 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/search/'>search</a>, <a class='category' href='/blog/categories/server/'>server</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/11/25/cppjieba-darts-DAT-memory_optimize/" title="Previous Post: 用 DAT 重实现 CppJieba 中文分词算法，降低 99% 内存消耗">&laquo; 用 DAT 重实现 CppJieba 中文分词算法，降低 99% 内存消耗</a>
      
      
        <a class="basic-alignment right" href="/blog/2020/03/03/abstract-unix-socket-single-instance/" title="Next Post: 用 abstract unix socket 实现进程单实例运行">用 abstract unix socket 实现进程单实例运行 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/03/03/abstract-unix-socket-single-instance/">用 Abstract Unix Socket 实现进程单实例运行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering/">Python 自动翻译成 C++ ，彻底保证离线在线特征一致</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/25/cppjieba-darts-DAT-memory_optimize/">用 DAT 重实现 CppJieba 中文分词算法，降低 99% 内存消耗</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/18/newwords_discovery/">GB 规模语料上的高性能新词发现算法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/06/tls-protocol-analysis-and-crypto-protocol-design/">TLS协议分析 与 现代加密通信协议设计</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/byronhe">@byronhe</a> on GitHub
  
  <script type="text/javascript">

    //$(document).ready(function(){
    document.addEventListener("DOMContentLoaded", function(event) { 
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'byronhe',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script async src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - byronhe -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
    <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script async >!window.jQuery && document.write(unescape('%3Cscript async  src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script async  src="/javascripts/octopress.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49290834-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




<script type="text/javascript">
      var disqus_shortname = 'byronheblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://blog.helong.info//blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering/';
        var disqus_url = 'https://blog.helong.info//blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










<script src="//s95.cnzz.com/z_stat.php?id=1256308650&web_id=1256308650" language="JavaScript"></script>

<script src="/javascripts/jquery.tableofcontents.min.js" type="text/javascript"></script>
<script src="/javascripts/toc-generator.js" type="text/javascript"></script>


  <script type="text/javascript">
  jQuery(document).ready(function() {
    // Put a TOC right before the entry content.
    generateTOC('.entry-content', 'Table of Contents');
  });
  </script>



</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Visual Studio静态，动态链接库开发工具简单使用 - Tech Ideas</title>
  <meta name="author" content="byronhe">

  
  <meta name="description" content="这是2011年8月份做过的一点实验，查了MSDN等等很多资料，基本搞明白了。这里我不会使用visual studio的图形界面工具，作为专业人士，还是搞懂自己的工具是怎么运转的，这样比较好。 要使用的是visual studio的命令行工具，其实和gcc那堆工具对应关系挺明显的，大致如下： gcc &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://blog.helong.info//blog/2011/11/13/visual-studio%25e9%259d%2599%25e6%2580%2581%25ef%25bc%258c%25e5%258a%25a8%25e6%2580%2581%25e9%2593%25be%25e6%258e%25a5%25e5%25ba%2593%25e5%25bc%2580%25e5%258f%2591%25e5%25b7%25a5%25e5%2585%25b7%25e7%25ae%2580%25e5%258d%2595%25e4%25bd%25bf%25e7%2594%25a8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tech Ideas" type="application/atom+xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49290834-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tech Ideas</a></h1>
  
    <h2>C++,Linux,Algorithm,Crypto,Lisp,etc</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.helong.info/">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Visual Studio静态，动态链接库开发工具简单使用</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-11-13T00:00:00+00:00'><span class='date'>2011-11-13</span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>这是2011年8月份做过的一点实验，查了MSDN等等很多资料，基本搞明白了。这里我不会使用visual studio的图形界面工具，作为专业人士，还是搞懂自己的工具是怎么运转的，这样比较好。</p>

<p>要使用的是visual studio的命令行工具，其实和gcc那堆工具对应关系挺明显的，大致如下：</p>

<table border="1" cellspacing="1" cellpadding="1">
  <tr>
    <td>
      gcc
    </td>
    
    <td>
      cl
    </td>
  </tr>
  
  <tr>
    <td>
      ar
    </td>
    
    <td>
      lib
    </td>
  </tr>
  
  <tr>
    <td>
      ld
    </td>
    
    <td>
      link
    </td>
  </tr>
</table>


<p>文件后缀对应关系:</p>

<!--more-->




<table border="1" cellspacing="1" cellpadding="1">
  <tr>
    <td>
      .a
    </td>
    
    <td>
      .lib
    </td>
  </tr>
  
  <tr>
    <td>
      .so
    </td>
    
    <td>
      .dll
    </td>
  </tr>
  
  <tr>
    <td>
      .o
    </td>
    
    <td>
      .obj
    </td>
  </tr>
</table>


<p>&nbsp;</p>

<p>新手注意：这个命令提示符是&#8221;开始菜单&#8221;&#8211;>>&#8221;Microsoft Visual studio&#8221;&#8211;>>&#8221;Visual Tools&#8221; 那里的提示符，其实就是设置过一些环境变量的cmd。</p>

<p><img src="/images/blog/0_1321170608jSJW.gif"></p>

<p>&nbsp;</p>

<p>先把实验代码贴出来（可以先跳过不看），共有五个文件：</p>

<p>1.build.bat</p>

<pre class="lang:sh decode:true">""C:Program Files (x86)Microsoft Visual Studio 10.0VCvcvarsall.bat"" x86
cd dynamic
del /f /Q * 
cl /LD ..ext.c 
del ext.obj 
cl ..main.c /link ext.lib
del main.obj
cd ..
cd static
del /f /Q *
cl /c ..ext.c
lib ext.obj
del ext.obj
cl ..main-static.c /link ext.lib
del main*.obj main*.exp main*.lib
cd ..</pre>


<p>2.库的头文件，ext.h</p>

<pre class="lang:c++ decode:true">#ifndef EXT_H
#define EXT_H
#ifdef Import
#define Dll __declspec(dllimport)
#else
#ifdef Export
#define Dll __declspec(dllexport)
#else
#define Dll
#endif
#endif

#include 
Dll typedef struct {
int i;
char c;
} st;
Dll extern int num;
Dll void fun();
Dll extern st s;
#endif</pre>




<div class="cpp">
  3.库的实现文件,ext.c
</div>




<pre class="lang:c++ decode:true">#define Export
#include "ext.h"
st s={24,'h'};
int num=0;
void fun(){
printf("hello,i am in lib. num=%dn",num++);
}</pre>




<div class="cpp">
  4.以动态链接库方式使用这个库的程序代码，main.c
</div>




<pre class="lang:c++ decode:true">#define Import
#include "ext.h" 
#include "windows.h"
#include 

int main(){
    fun();
    printf("num=%d\n",num);
    fun();
    printf("num=%d\n",num);
    printf("st i=%d c=%c \n",s.i,s.c);
}</pre>


<p><span style="font-size: 1rem; line-height: 1;">5.以静态链接库方式使用这个库的程序代码，main-static.c</span></p>

<pre class="lang:c++ decode:true"> 
#include "ext.h" 
#include "windows.h"
#include

int main(){
    fun();
    printf("num=%d\n",num);
    fun();
    printf("num=%d\n",num);
    printf("st i=%d c=%c \n",s.i,s.c);
}</pre>


<p>&nbsp;</p>

<p>一，静态链接库</p>

<div>
  <div>
    要给用户提供静态链接库，都要提供哪些文件呢？.h头文件+.lib库文件
  </div>
  
  <div>
  </div>
  
  <div>
    先问个问题： 使用库的最简单方式是什么？当然是不使用库！
  </div>
  
  <div>
  </div>
  
  <div>
    不使用库谁不会啊？使用如下命令：
  </div>
  
  <div>
            cl main-static.c ext.c
  </div>
  
  <div>
            在当前目录下，就会编译，链接成一个main-static.exe，执行一下，没有问题！
  </div>
  
  <div>
  </div>
  
  <div>
            再问个问题：除了exe文件，还看见了什么？有ext.obj, main-static.obj, main-static.lib ,main-static.exp .
  </div>
  
  <div>
  </div>
  
  <div>
             .obj文件是目标文件（object file），
  </div>
  
  <div>
             .lib文件是静态库文件（msdn中称为导入库），
  </div>
  
  <div>
              .exp文件，导出文件，辅助作用（参看<a href="http://msdn.microsoft.com/zh-cn/library/se8y7dcs(v=vs.80).aspx">这里</a>和<a href="http://msdn.microsoft.com/zh-cn/library/kkt2hd12.aspx" target="_blank">这里</a>）
  </div>
  
  <div>
  </div>
  
  <div>
              可以猜想，用cl直接编译生成exe的过程，是
  </div>
  
  <div>
             1. ext.c&#8212;>>ext.obj
  </div>
  
  <div>
             2.main-static.c&#8211;>>main-static.obj
  </div>
  
  <div>
             3.main-static.obj&#8212;>>main-static.exp+main-static.lib
  </div>
  
  <div>
             4.ext.obj+main-static.lib+main-static.exp&#8212;>>main-static.exe
  </div>
  
  <div>
             的过程
  </div>
  
  <div>
  </div>
  
  <div>
    我尝试了改换参数顺序，即用命令 cl ext.c main-static.c
  </div>
  
  <div>
    发现main-static.exp + main-static.lib换成了ext.lib+ext.exp
  </div>
  
  <div>
  </div>
  
  <div>
    这说明是cl是先把.c文件都生成为obj文件，然后把第一个命令行参数指定xxx.c的xxx.obj文件再生成为xxx.lib+xxx.exp文件
  </div>
  
  <div>
  </div>
  
  <div>
  </div>
  
  <div>
    这和静态链接有什么关系呢？关系密切啊！
  </div>
  
  <div>
    把除了ext.lib 以外的所有生成文件删除，运行如下命令:
  </div>
  
  <div>
    cl main-static.c /link ext.lib
  </div>
  
  <div>
    就可以看见，生成了main-static.exe，运行正常。ext.lib就是静态链接库。
  </div>
  
  <p>
    其实，这就是一个静态链接的过程。
  </p>
  
  <p>
    静态链接的第一步，怎么由ext.c生成obj文件？查msdn（或者 命令cl /?）可知，给cl提供/c参数就可以了，先清掉那堆文件，运行 cl /c ext.c
  </p>
  
  <p>
    成功生成ext.obj.同理可以生成main-static.obj。
  </p>
  
  <div>
    严格来说编译已经完成，接下来的，都是链接过程。
  </div>
  
  <div>
  </div>
  
  <div>
    第二步，怎么从obj文件生成.lib文件（加/DEF参数，就可以同时生成.exp文件)
  </div>
  
  <div>
    <div>
      lib ext.obj
    </div>
  </div>
  
  <div>
    就生成了ext.lib
  </div>
  
  <div>
    第三步，怎么从main-static.c + ext.lib 生成exe
  </div>
  
  <div>
    <div>
      cl main-static.c /link ext.lib
    </div>
    
    <p>
      需要注意的是，头文件一定要可以找到。
    </p>
  </div>
  
  <div>
  </div>
  
  <h2>
    二，动态链接库
  </h2>
  
  <div>
    visual studio的动态链接分为显式链接和隐式链接两种（<a href="http://msdn.microsoft.com/zh-cn/library/253b8k2c(v=vs.80).aspx">http://msdn.microsoft.com/zh-cn/library/253b8k2c(v=vs.80).aspx</a>），<a href="http://msdn.microsoft.com/zh-cn/library/784bt7z7(v=vs.80).aspx" target="_blank">显式链接</a>就是自己写代码调用win32<br /> Api加载dll文件，要使用LoadLibrary, GetProcAddress(), FreeLibrary()这些函数，这个方法几乎不需要工具，就不说了，看看msdn的例子就明白了。
  </div>
  
  <div>
    以下说的都是<a href="http://msdn.microsoft.com/zh-cn/library/d14wsce5(v=vs.80).aspx" target="_blank">隐式链接</a>
  </div>
  
  <div>
    visual studio的动态链接库使用很与众不同，竟然需要提供三种文件：.h+.lib+.dll文件，诡异的是，这个.lib文件和静态链接库里的.lib文件其实不一样！
  </div>
  
  <div>
    更诡异的是，用户链接的时候，其实不需要.dll文件！
  </div>
  
  <div>
    对比之下，linux下的gcc，若是动态链接库，需要的是.so+.h 文件（.so相当于.dll），这是显著的差异。
  </div>
  
  <div>
    参看csdn(<a href="http://msdn.microsoft.com/zh-cn/library/3y1sfaz2(v=vs.100).aspx">http://msdn.microsoft.com/zh-cn/library/3y1sfaz2(v=vs.100).aspx</a>)可知，和静态链接不同的是，动态链接需要对库的源代码进行改动，添加
  </div>
  
  <div>
          __declspec( dllimport )
  </div>
  
  <div>
     或 __declspec( dllexport )
  </div>
  
  <div>
  </div>
  
  <div>
    补充：也可以用def文件，不过我没试过，参看<a href="http://msdn.microsoft.com/zh-cn/library/0b9xe492.aspx">http://msdn.microsoft.com/zh-cn/library/0b9xe492.aspx</a> 和 <a href="http://msdn.microsoft.com/zh-cn/library/28d6s79h.aspx">http://msdn.microsoft.com/zh-cn/library/28d6s79h.aspx</a>。
  </div>
  
  <div>
  </div>
  
  <div>
    这个时候要注意，__declspec( dllimport )和__declspec( dllexport ) 的使用是不一样的，在库里导出的符号（函数，变量等，可以用dumpbin查看）应该使用__declspec( dllexport ) ，而使用库的代码，在包含头文件后，要有这些符号的声明，要看到__declspec( dllimport )形式的声明，所以这是有区别的。在上面ext.h里，我用了一个宏Dll来统一处理。
  </div>
  
  <div>
  </div>
  
  <div>
  </div>
  
  <div>
    处理完源代码，就可以编译了。
  </div>
  
  <div>
  </div>
  
  <div>
    第一步，生成obj文件，
  </div>
  
  <div>
    <pre class="lang:sh decode:true ">cl /c ext.c</pre>
    
    <p>
      <span style="line-height: 1.714285714; font-size: 1rem;">第二步，由obj文件生成dll文件+lib文件，</span>
    </p>
  </div>
  
  <div>
    <div>
      <pre class="lang:sh decode:true">cl /LD ext.obj</pre>
      
      <p>
        <span style="font-size: 1rem; line-height: 1;">或者也可以用</span></div> <div>
          <pre class="lang:sh decode:true ">link /DLL ext.obj</pre>
          
          <p>
            <span style="line-height: 1.714285714; font-size: 1rem;">可以看到，生成了ext.dll , ext.exp, ext.lib 三个文件，其中的ext.lib 这个文件和静态链接时生成的ext.lib文件是不一样的！而且ext.dll在main.c的链接过程中是用不着的！</span>
          </p>
        </div></div> 
        
        <div>
          （此时已经生成了dll文件，要是使用显式链接，就把dll文件弄走，自己写代码去啦），继续隐式链接<br /> 第三步，不妨移走ext.dll，然后编译
        </div>
        
        <div>
        </div>
        
        <div>
          <div>
            <pre class="lang:sh decode:true ">cl main.c /link ext.lib</pre>
            
            <p>
              &nbsp;
            </p>
            
            <p>
              <span style="line-height: 1.714285714; font-size: 1rem;">可以看到生成main.exe，但是运行一下，会报告找不到ext.dll，当然找不到啦，只要把ext.dll移到当前目录下（或在dll文件查找路径中的一个中）即可正常运行。</span></div> </div> <div>
                <p>
                     注：dll文件查找路径参看 <a href="http://msdn.microsoft.com/zh-cn/library/7d83bc18(v=vs.80).aspx">http://msdn.microsoft.com/zh-cn/library/7d83bc18(v=vs.80).aspx</a>
                </p>
              </div>
              
              <div>
                这个领域关注的人少，鄙人理解浅薄，错误难免，欢迎指正。
              </div>
              
              <div>
              </div></div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">windydays</span></span>

      




<time class='entry-date' datetime='2011-11-13T00:00:00+00:00'><span class='date'>2011-11-13</span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cpp/'>cpp</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/10/17/%25e9%2580%2592%25e5%25a2%259e%25e5%25ad%2590%25e5%25ba%258f%25e5%2588%2597%25e6%2595%25b0%25e7%259b%25ae%25e8%25ae%25a1%25e7%25ae%2597%25e7%259a%2584%25e7%25ae%2597%25e6%25b3%2595/" title="Previous Post: 递增子序列数目计算的算法">&laquo; 递增子序列数目计算的算法</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/11/15/%25e3%2580%2590%25e6%2597%25a7%25e4%25bb%25a3%25e7%25a0%2581%25e3%2580%2591%25e4%25bc%25a0%25e7%2583%25ad%25e8%25bf%2587%25e7%25a8%258b%25e6%2595%25b0%25e5%2580%25bc%25e6%25a8%25a1%25e6%258b%259f%25ef%25bc%2588%25e3%2580%258a%25e4%25bc%25a0%25e7%2583%25ad%25e5%25ad%25a6%25e3%2580%258b%25e5%25ae%259e%25e9%25aa%258c%25e6%258c%2587/" title="Next Post: 【旧代码】传热过程数值模拟（《传热学》实验指导书第四部分第一题，第一，第二类边界条件）">【旧代码】传热过程数值模拟（《传热学》实验指导书第四部分第一题，第一，第二类边界条件） &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/11/29/pthran-py-to-cpp-translater-in-feature-engineering/">Python 自动翻译成 C++ ，彻底保证离线在线特征一致</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/25/cppjieba-darts-DAT-memory_optimize/">用 DAT 重实现 CppJieba 中文分词算法，降低 99% 内存消耗</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/18/newwords_discovery/">GB 规模语料上的高性能新词发现算法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/06/tls-protocol-analysis-and-crypto-protocol-design/">TLS协议分析 与 现代加密通信协议设计</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/05/modern-crypto/">现代密码学实践指南[2015年]</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/byronhe">@byronhe</a> on GitHub
  
  <script type="text/javascript">

    //$(document).ready(function(){
    document.addEventListener("DOMContentLoaded", function(event) { 
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'byronhe',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script async src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - byronhe -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
    <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script async >!window.jQuery && document.write(unescape('%3Cscript async  src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script async  src="/javascripts/octopress.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49290834-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




<script type="text/javascript">
      var disqus_shortname = 'byronheblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










<script src="//s95.cnzz.com/z_stat.php?id=1256308650&web_id=1256308650" language="JavaScript"></script>

<script src="/javascripts/jquery.tableofcontents.min.js" type="text/javascript"></script>
<script src="/javascripts/toc-generator.js" type="text/javascript"></script>




</body>
</html>
